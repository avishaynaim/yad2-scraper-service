<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yad2 Scraper Dashboard</title>
    <style>
        :root {
            --primary: #4f46e5;
            --primary-light: #818cf8;
            --primary-dark: #3730a3;
            --primary-bg: #eef2ff;
            --success: #059669;
            --success-light: #d1fae5;
            --warning: #d97706;
            --warning-light: #fef3c7;
            --danger: #dc2626;
            --danger-light: #fee2e2;
            --info: #0284c7;
            --info-light: #e0f2fe;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
            --radius: 0.75rem;
            --radius-sm: 0.5rem;
            --shadow: 0 1px 3px rgba(0,0,0,0.08);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
            --shadow-lg: 0 12px 24px rgba(0,0,0,0.12);
            --transition: 0.2s ease;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: var(--gray-100);
            color: var(--gray-800);
            line-height: 1.6;
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 0.875rem 1.5rem;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 20px rgba(79, 70, 229, 0.3);
        }

        .header-content {
            max-width: 1920px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
        }

        .header-left { display: flex; align-items: center; gap: 1rem; }
        .header h1 { font-size: 1.25rem; font-weight: 700; letter-spacing: -0.02em; }

        .live-badge {
            display: flex;
            align-items: center;
            gap: 0.375rem;
            font-size: 0.75rem;
            background: rgba(255,255,255,0.15);
            padding: 0.25rem 0.625rem;
            border-radius: 1rem;
            backdrop-filter: blur(8px);
        }

        .live-dot {
            width: 8px;
            height: 8px;
            background: #34d399;
            border-radius: 50%;
            animation: pulse-dot 2s ease-in-out infinite;
        }

        @keyframes pulse-dot {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(0.8); }
        }

        .header-kpis {
            display: flex;
            gap: 1.5rem;
            align-items: center;
        }

        .header-kpi { text-align: center; }
        .header-kpi-value { font-size: 1.125rem; font-weight: 700; }
        .header-kpi-label { font-size: 0.6875rem; opacity: 0.8; }

        .last-update {
            font-size: 0.6875rem;
            opacity: 0.7;
            text-align: left;
        }

        /* Container */
        .container { max-width: 1920px; margin: 0 auto; padding: 1.25rem; }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 0.25rem;
            margin-bottom: 1.25rem;
            background: white;
            border-radius: var(--radius);
            padding: 0.25rem;
            box-shadow: var(--shadow);
            overflow-x: auto;
        }

        .tab {
            flex: 1;
            padding: 0.625rem 1rem;
            background: transparent;
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 0.8125rem;
            font-weight: 500;
            color: var(--gray-500);
            transition: var(--transition);
            white-space: nowrap;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .tab:hover { color: var(--gray-700); background: var(--gray-50); }
        .tab.active { background: var(--primary); color: white; box-shadow: 0 2px 8px rgba(79,70,229,0.3); }

        .tab-badge {
            background: var(--gray-200);
            color: var(--gray-600);
            padding: 0.125rem 0.5rem;
            border-radius: 1rem;
            font-size: 0.6875rem;
            font-weight: 600;
            min-width: 1.5rem;
            text-align: center;
        }

        .tab.active .tab-badge { background: rgba(255,255,255,0.25); color: white; }

        /* Panels */
        .panel { display: none; }
        .panel.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(4px); } to { opacity: 1; transform: translateY(0); } }

        /* Analytics Grid */
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 0.75rem;
            margin-bottom: 1.25rem;
        }

        .kpi-card {
            background: white;
            padding: 1rem 1.25rem;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            border-right: 4px solid var(--gray-200);
            transition: var(--transition);
        }

        .kpi-card:hover { box-shadow: var(--shadow-md); transform: translateY(-1px); }
        .kpi-card.accent-primary { border-right-color: var(--primary); }
        .kpi-card.accent-success { border-right-color: var(--success); }
        .kpi-card.accent-warning { border-right-color: var(--warning); }
        .kpi-card.accent-danger { border-right-color: var(--danger); }
        .kpi-card.accent-info { border-right-color: var(--info); }

        .kpi-value { font-size: 1.5rem; font-weight: 700; color: var(--gray-900); line-height: 1.2; }
        .kpi-label { font-size: 0.75rem; color: var(--gray-500); margin-top: 0.125rem; }
        .kpi-trend { font-size: 0.6875rem; margin-top: 0.25rem; }
        .kpi-trend.up { color: var(--danger); }
        .kpi-trend.down { color: var(--success); }

        /* Charts Row */
        .charts-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
            margin-bottom: 1.25rem;
        }

        .chart-card {
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .chart-card-header {
            padding: 0.875rem 1.25rem;
            border-bottom: 1px solid var(--gray-100);
            font-weight: 600;
            font-size: 0.875rem;
            color: var(--gray-700);
        }

        .chart-card-body { padding: 1rem 1.25rem; }

        /* Bar Chart */
        .bar-chart { display: flex; flex-direction: column; gap: 0.5rem; }
        .bar-row { display: flex; align-items: center; gap: 0.5rem; font-size: 0.75rem; }
        .bar-label { width: 80px; text-align: right; color: var(--gray-600); flex-shrink: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .bar-track { flex: 1; height: 22px; background: var(--gray-100); border-radius: 4px; overflow: hidden; position: relative; }
        .bar-fill { height: 100%; border-radius: 4px; transition: width 0.6s ease; display: flex; align-items: center; padding: 0 0.5rem; }
        .bar-fill span { font-size: 0.625rem; font-weight: 600; color: white; white-space: nowrap; }
        .bar-count { width: 50px; text-align: left; font-weight: 500; color: var(--gray-500); font-size: 0.6875rem; }

        /* Card */
        .card {
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            margin-bottom: 1.25rem;
        }

        .card-header {
            padding: 0.875rem 1.25rem;
            border-bottom: 1px solid var(--gray-100);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.75rem;
        }

        .card-title { font-size: 0.9375rem; font-weight: 600; color: var(--gray-800); }

        /* Active Filters Bar */
        .active-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 0.375rem;
            align-items: center;
            padding: 0 1.25rem;
        }

        .active-filters:empty { display: none; }

        .active-filters-bar {
            border-bottom: 1px solid var(--gray-100);
            padding: 0.625rem 0;
        }

        .filter-chip {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            background: var(--primary-bg);
            color: var(--primary);
            padding: 0.25rem 0.5rem;
            border-radius: 1rem;
            font-size: 0.6875rem;
            font-weight: 500;
        }

        .filter-chip-remove {
            cursor: pointer;
            opacity: 0.6;
            font-size: 0.875rem;
            line-height: 1;
        }

        .filter-chip-remove:hover { opacity: 1; }

        .clear-all-btn {
            background: none;
            border: none;
            color: var(--danger);
            font-size: 0.6875rem;
            cursor: pointer;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
        }

        .clear-all-btn:hover { background: var(--danger-light); }

        /* Filter Toolbar */
        .filter-toolbar {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .preset-btn {
            padding: 0.375rem 0.625rem;
            background: var(--gray-50);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-sm);
            font-size: 0.6875rem;
            cursor: pointer;
            transition: var(--transition);
        }

        .preset-btn:hover { background: var(--gray-100); border-color: var(--gray-300); }

        /* Table */
        .table-container { overflow-x: auto; -webkit-overflow-scrolling: touch; }

        table { width: 100%; border-collapse: collapse; font-size: 0.8125rem; }

        th, td {
            padding: 0.625rem 0.875rem;
            text-align: right;
            border-bottom: 1px solid var(--gray-100);
            white-space: nowrap;
        }

        th {
            background: var(--gray-50);
            font-weight: 600;
            font-size: 0.75rem;
            color: var(--gray-500);
            text-transform: uppercase;
            letter-spacing: 0.03em;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        tbody tr { transition: background var(--transition); }
        tbody tr:hover { background: var(--primary-bg); }

        .th-content { display: flex; flex-direction: column; gap: 0.375rem; }
        .th-label { display: flex; align-items: center; gap: 0.375rem; cursor: pointer; user-select: none; }
        .th-label:hover { color: var(--primary); }
        .sort-icon { font-size: 0.625rem; opacity: 0.4; }
        .sort-icon.active { opacity: 1; color: var(--primary); }

        /* Multi-select Dropdown */
        .multi-select { position: relative; min-width: 100px; }

        .ms-trigger {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.3125rem 0.5rem;
            border: 1px solid var(--gray-200);
            border-radius: 0.25rem;
            background: white;
            cursor: pointer;
            font-size: 0.6875rem;
            min-height: 26px;
            gap: 0.25rem;
            transition: var(--transition);
        }

        .ms-trigger:hover { border-color: var(--primary-light); }
        .ms-trigger.has-selection { border-color: var(--primary); background: var(--primary-bg); }

        .ms-count {
            background: var(--primary);
            color: white;
            padding: 0 0.375rem;
            border-radius: 0.25rem;
            font-size: 0.5625rem;
            font-weight: 600;
            line-height: 1.4;
        }

        .ms-arrow { font-size: 0.5rem; color: var(--gray-400); transition: transform var(--transition); }
        .ms-trigger.open .ms-arrow { transform: rotate(180deg); }

        .ms-dropdown {
            position: absolute;
            top: calc(100% + 4px);
            right: 0;
            min-width: 200px;
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-sm);
            box-shadow: var(--shadow-lg);
            z-index: 1000;
            display: none;
            overflow: hidden;
        }

        .ms-dropdown.open { display: block; animation: dropIn 0.15s ease; }
        @keyframes dropIn { from { opacity: 0; transform: translateY(-4px); } to { opacity: 1; transform: translateY(0); } }

        .ms-search {
            padding: 0.5rem;
            border-bottom: 1px solid var(--gray-100);
        }

        .ms-search input {
            width: 100%;
            padding: 0.375rem 0.5rem;
            border: 1px solid var(--gray-200);
            border-radius: 0.25rem;
            font-size: 0.75rem;
            outline: none;
        }

        .ms-search input:focus { border-color: var(--primary-light); }

        .ms-actions {
            display: flex;
            gap: 0.25rem;
            padding: 0.375rem 0.5rem;
            border-bottom: 1px solid var(--gray-100);
            background: var(--gray-50);
        }

        .ms-actions button {
            flex: 1;
            padding: 0.25rem;
            border: none;
            border-radius: 0.25rem;
            background: white;
            cursor: pointer;
            font-size: 0.625rem;
            color: var(--gray-600);
            transition: var(--transition);
        }

        .ms-actions button:hover { background: var(--primary-bg); color: var(--primary); }

        .ms-options { max-height: 220px; overflow-y: auto; }

        .ms-option {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.4375rem 0.5rem;
            cursor: pointer;
            font-size: 0.75rem;
            transition: background var(--transition);
        }

        .ms-option:hover { background: var(--gray-50); }
        .ms-option input[type="checkbox"] { accent-color: var(--primary); margin: 0; cursor: pointer; }
        .ms-option-label { flex: 1; }
        .ms-option-count { color: var(--gray-400); font-size: 0.625rem; }

        /* Range Filter */
        .range-filter { display: flex; gap: 0.25rem; align-items: center; }
        .range-filter input {
            width: 55px;
            padding: 0.3125rem 0.375rem;
            border: 1px solid var(--gray-200);
            border-radius: 0.25rem;
            font-size: 0.6875rem;
            text-align: center;
            outline: none;
        }
        .range-filter input:focus { border-color: var(--primary-light); }

        /* Price styling */
        .price-up { color: var(--danger); }
        .price-down { color: var(--success); }
        .price-stable { color: var(--gray-400); }

        .trend-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.75rem;
            font-weight: 500;
        }

        /* Badges */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 0.1875rem 0.5rem;
            border-radius: 1rem;
            font-size: 0.6875rem;
            font-weight: 500;
        }

        .badge-success { background: var(--success-light); color: var(--success); }
        .badge-warning { background: var(--warning-light); color: var(--warning); }
        .badge-danger { background: var(--danger-light); color: var(--danger); }
        .badge-info { background: var(--info-light); color: var(--info); }
        .badge-neutral { background: var(--gray-100); color: var(--gray-600); }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1.25rem;
            border-top: 1px solid var(--gray-100);
            flex-wrap: wrap;
            gap: 0.75rem;
        }

        .pagination-info { color: var(--gray-500); font-size: 0.8125rem; }
        .pagination-controls { display: flex; gap: 0.25rem; }

        .page-btn {
            padding: 0.375rem 0.625rem;
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: 0.25rem;
            cursor: pointer;
            font-size: 0.8125rem;
            transition: var(--transition);
            color: var(--gray-600);
        }

        .page-btn:hover:not(:disabled) { background: var(--gray-50); border-color: var(--gray-300); }
        .page-btn:disabled { opacity: 0.4; cursor: not-allowed; }
        .page-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

        /* Loading */
        .loading { display: flex; justify-content: center; align-items: center; padding: 2rem; color: var(--gray-400); gap: 0.75rem; }
        .spinner {
            width: 1.5rem; height: 1.5rem;
            border: 2px solid var(--gray-200);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .empty-state { text-align: center; padding: 2rem; color: var(--gray-400); font-size: 0.875rem; }

        /* Scraper Status Panel */
        .scraper-status {
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 1rem 1.25rem;
            margin-bottom: 1.25rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .scraper-status-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            flex-shrink: 0;
        }

        .scraper-status-icon.running { background: var(--info-light); animation: pulse-bg 2s ease-in-out infinite; }
        .scraper-status-icon.idle { background: var(--success-light); }
        @keyframes pulse-bg { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }

        .scraper-status-text { flex: 1; }
        .scraper-status-title { font-weight: 600; font-size: 0.875rem; color: var(--gray-800); }
        .scraper-status-detail { font-size: 0.75rem; color: var(--gray-500); }

        .scraper-status-progress {
            width: 200px;
            height: 6px;
            background: var(--gray-200);
            border-radius: 3px;
            overflow: hidden;
        }

        .scraper-status-progress-fill {
            height: 100%;
            background: var(--primary);
            border-radius: 3px;
            transition: width 0.5s ease;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.4);
            backdrop-filter: blur(4px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-overlay.active { display: flex; }

        .modal {
            background: white;
            border-radius: var(--radius);
            padding: 1.5rem;
            max-width: 400px;
            width: 90%;
            box-shadow: var(--shadow-lg);
        }

        .modal h3 { margin-bottom: 1rem; font-size: 1rem; }
        .modal input {
            width: 100%;
            padding: 0.625rem;
            border: 1px solid var(--gray-300);
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
            margin-bottom: 1rem;
        }
        .modal-actions { display: flex; gap: 0.5rem; justify-content: flex-end; }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 0.8125rem;
            font-weight: 500;
            transition: var(--transition);
        }

        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-secondary { background: var(--gray-100); color: var(--gray-600); }
        .btn-secondary:hover { background: var(--gray-200); }

        a { color: var(--primary); text-decoration: none; }
        a:hover { text-decoration: underline; }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 1.5rem;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--gray-900);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: var(--radius);
            font-size: 0.8125rem;
            box-shadow: var(--shadow-lg);
            z-index: 10000;
            transition: transform 0.3s ease;
            pointer-events: none;
        }

        .toast.visible { transform: translateX(-50%) translateY(0); }

        /* Responsive */
        @media (max-width: 768px) {
            .header-content { flex-direction: column; gap: 0.5rem; }
            .header-kpis { gap: 1rem; flex-wrap: wrap; justify-content: center; }
            .container { padding: 0.75rem; }
            .analytics-grid { grid-template-columns: repeat(2, 1fr); }
            .charts-row { grid-template-columns: 1fr; }
            th, td { padding: 0.5rem 0.625rem; }
            .card-header { flex-direction: column; align-items: flex-start; }
            .tabs { flex-wrap: nowrap; overflow-x: auto; }
            .tab { min-width: fit-content; flex: none; }
            .scraper-status { flex-direction: column; text-align: center; }
            .scraper-status-progress { width: 100%; }
        }

        @media (max-width: 480px) {
            .analytics-grid { grid-template-columns: 1fr; }
            .kpi-value { font-size: 1.25rem; }
        }
    </style>
</head>
<body>

<header class="header">
    <div class="header-content">
        <div class="header-left">
            <h1>Yad2 Dashboard</h1>
            <div class="live-badge">
                <span class="live-dot"></span>
                <span id="liveStatus">Auto-refresh</span>
            </div>
        </div>
        <div class="header-kpis" id="headerKpis">
            <div class="header-kpi">
                <div class="header-kpi-value" id="hkTotal">--</div>
                <div class="header-kpi-label">Active Listings</div>
            </div>
            <div class="header-kpi">
                <div class="header-kpi-value" id="hkCities">--</div>
                <div class="header-kpi-label">Cities</div>
            </div>
            <div class="header-kpi">
                <div class="header-kpi-value" id="hkAvgPrice">--</div>
                <div class="header-kpi-label">Avg Price</div>
            </div>
            <div class="header-kpi">
                <div class="header-kpi-value" id="hkChanges">--</div>
                <div class="header-kpi-label">Price Changes 24h</div>
            </div>
        </div>
        <div class="last-update" id="lastUpdate">Loading...</div>
    </div>
</header>

<main class="container">
    <div class="tabs">
        <button class="tab active" data-tab="overview">Overview<span class="tab-badge" id="overviewBadge">--</span></button>
        <button class="tab" data-tab="listings">Listings<span class="tab-badge" id="listingsBadge">0</span></button>
        <button class="tab" data-tab="price-changes">Price Changes<span class="tab-badge" id="priceChangesBadge">0</span></button>
        <button class="tab" data-tab="runs">Scrape History<span class="tab-badge" id="runsBadge">0</span></button>
    </div>

    <!-- Overview Panel -->
    <div class="panel active" id="overview-panel">
        <div id="scraperStatusContainer"></div>

        <div class="analytics-grid" id="kpiGrid">
            <div class="kpi-card accent-primary">
                <div class="kpi-value" id="kpiActive">--</div>
                <div class="kpi-label">Active Listings</div>
            </div>
            <div class="kpi-card accent-info">
                <div class="kpi-value" id="kpiTotal">--</div>
                <div class="kpi-label">Total Ever Seen</div>
            </div>
            <div class="kpi-card accent-success">
                <div class="kpi-value" id="kpiAvg">--</div>
                <div class="kpi-label">Avg Price</div>
            </div>
            <div class="kpi-card accent-warning">
                <div class="kpi-value" id="kpiMin">--</div>
                <div class="kpi-label">Min Price</div>
            </div>
            <div class="kpi-card accent-danger">
                <div class="kpi-value" id="kpiMax">--</div>
                <div class="kpi-label">Max Price</div>
            </div>
            <div class="kpi-card accent-info">
                <div class="kpi-value" id="kpiCities">--</div>
                <div class="kpi-label">Cities</div>
            </div>
            <div class="kpi-card accent-primary">
                <div class="kpi-value" id="kpiNeighborhoods">--</div>
                <div class="kpi-label">Neighborhoods</div>
            </div>
            <div class="kpi-card accent-warning">
                <div class="kpi-value" id="kpiChanges7d">--</div>
                <div class="kpi-label">Price Changes 7d</div>
            </div>
        </div>

        <div class="charts-row">
            <div class="chart-card">
                <div class="chart-card-header">Top Cities</div>
                <div class="chart-card-body" id="topCitiesChart"></div>
            </div>
            <div class="chart-card">
                <div class="chart-card-header">Rooms Distribution</div>
                <div class="chart-card-body" id="roomsChart"></div>
            </div>
        </div>

        <div class="charts-row">
            <div class="chart-card">
                <div class="chart-card-header">Recent Scrape Runs</div>
                <div class="chart-card-body" id="recentRunsChart"></div>
            </div>
            <div class="chart-card">
                <div class="chart-card-header">Latest Price Drops</div>
                <div class="chart-card-body" id="latestDropsChart"></div>
            </div>
        </div>
    </div>

    <!-- Listings Panel -->
    <div class="panel" id="listings-panel">
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Listings</h2>
                <div class="filter-toolbar">
                    <div id="listingsPresets"></div>
                    <button class="preset-btn" onclick="savePreset()">Save Filter</button>
                    <button class="preset-btn" onclick="clearAllFilters()">Clear All</button>
                </div>
            </div>
            <div class="active-filters-bar">
                <div class="active-filters" id="activeFiltersChips"></div>
            </div>
            <div class="table-container">
                <table id="listingsTable">
                    <thead>
                        <tr>
                            <th>
                                <div class="th-content">
                                    <div class="th-label" onclick="sortListings('city')">City <span class="sort-icon" data-sort="city">&#9650;</span></div>
                                    <div class="multi-select" data-col="city" data-tbl="listings"></div>
                                </div>
                            </th>
                            <th>
                                <div class="th-content">
                                    <div class="th-label" onclick="sortListings('neighborhood')">Neighborhood <span class="sort-icon" data-sort="neighborhood">&#9650;</span></div>
                                    <div class="multi-select" data-col="neighborhood" data-tbl="listings"></div>
                                </div>
                            </th>
                            <th>
                                <div class="th-content">
                                    <div class="th-label" onclick="sortListings('street')">Street</div>
                                </div>
                            </th>
                            <th>
                                <div class="th-content">
                                    <div class="th-label" onclick="sortListings('rooms')">Rooms <span class="sort-icon" data-sort="rooms">&#9650;</span></div>
                                    <div class="multi-select" data-col="rooms" data-tbl="listings"></div>
                                </div>
                            </th>
                            <th>
                                <div class="th-content">
                                    <div class="th-label" onclick="sortListings('price_numeric')">Price <span class="sort-icon" data-sort="price_numeric">&#9650;</span></div>
                                    <div class="range-filter" data-col="price">
                                        <input type="number" placeholder="Min" data-range="min">
                                        <span style="color:var(--gray-400)">-</span>
                                        <input type="number" placeholder="Max" data-range="max">
                                    </div>
                                </div>
                            </th>
                            <th>
                                <div class="th-content">
                                    <div class="th-label" onclick="sortListings('size_sqm')">Sqm <span class="sort-icon" data-sort="size_sqm">&#9650;</span></div>
                                    <div class="multi-select" data-col="size_sqm" data-tbl="listings"></div>
                                </div>
                            </th>
                            <th>
                                <div class="th-content">
                                    <div class="th-label" onclick="sortListings('floor')">Floor <span class="sort-icon" data-sort="floor">&#9650;</span></div>
                                    <div class="multi-select" data-col="floor" data-tbl="listings"></div>
                                </div>
                            </th>
                            <th>
                                <div class="th-content">
                                    <div class="th-label">Type</div>
                                    <div class="multi-select" data-col="is_merchant" data-tbl="listings"></div>
                                </div>
                            </th>
                            <th>Added</th>
                            <th>Link</th>
                        </tr>
                    </thead>
                    <tbody id="listingsBody"></tbody>
                </table>
            </div>
            <div class="pagination">
                <div class="pagination-info" id="listingsPaginationInfo"></div>
                <div class="pagination-controls" id="listingsPagination"></div>
            </div>
        </div>
    </div>

    <!-- Price Changes Panel -->
    <div class="panel" id="price-changes-panel">
        <div class="analytics-grid">
            <div class="kpi-card accent-primary">
                <div class="kpi-value" id="pcTotal">--</div>
                <div class="kpi-label">Total Changes (30d)</div>
            </div>
            <div class="kpi-card accent-success">
                <div class="kpi-value" id="pcDrops">--</div>
                <div class="kpi-label">Price Drops</div>
            </div>
            <div class="kpi-card accent-danger">
                <div class="kpi-value" id="pcRaises">--</div>
                <div class="kpi-label">Price Raises</div>
            </div>
            <div class="kpi-card accent-info">
                <div class="kpi-value" id="pcAvg">--</div>
                <div class="kpi-label">Avg Change</div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Price Changes</h2>
                <button class="preset-btn" onclick="clearPriceChangeFilters()">Clear Filters</button>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>
                                <div class="th-content">
                                    <div class="th-label">City</div>
                                    <div class="multi-select" data-col="city" data-tbl="priceChanges"></div>
                                </div>
                            </th>
                            <th>Neighborhood</th>
                            <th>Street</th>
                            <th>Rooms</th>
                            <th>Old Price</th>
                            <th>New Price</th>
                            <th>
                                <div class="th-content">
                                    <div class="th-label">Direction</div>
                                    <div class="multi-select" data-col="direction" data-tbl="priceChanges"></div>
                                </div>
                            </th>
                            <th>Change</th>
                            <th>Change %</th>
                            <th>Date</th>
                            <th>Link</th>
                        </tr>
                    </thead>
                    <tbody id="priceChangesBody"></tbody>
                </table>
            </div>
            <div class="pagination">
                <div class="pagination-info" id="priceChangesPaginationInfo"></div>
                <div class="pagination-controls" id="priceChangesPagination"></div>
            </div>
        </div>
    </div>

    <!-- Runs Panel -->
    <div class="panel" id="runs-panel">
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Scrape Run History</h2>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Type</th>
                            <th>Started</th>
                            <th>Duration</th>
                            <th>Pages</th>
                            <th>Listings</th>
                            <th>New</th>
                            <th>Updated</th>
                            <th>Price Chg</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="runsBody"></tbody>
                </table>
            </div>
        </div>
    </div>
</main>

<!-- Save Preset Modal -->
<div class="modal-overlay" id="presetModal">
    <div class="modal">
        <h3>Save Filter Preset</h3>
        <input type="text" id="presetName" placeholder="Preset name...">
        <div class="modal-actions">
            <button class="btn btn-secondary" onclick="closePresetModal()">Cancel</button>
            <button class="btn btn-primary" onclick="confirmSavePreset()">Save</button>
        </div>
    </div>
</div>

<div class="toast" id="toast"></div>

<script>
const API_BASE = location.hostname === 'localhost' || location.hostname === '127.0.0.1'
    ? 'http://localhost:8000' : location.origin;

const AUTO_REFRESH_MS = 60000;
const COLORS = ['#4f46e5','#0284c7','#059669','#d97706','#dc2626','#7c3aed','#db2777','#0891b2','#65a30d','#ea580c'];

const S = {
    listings: { data: [], allData: [], filters: {}, sort: { col: 'last_seen_at', ord: 'desc' }, page: 1, limit: 50 },
    priceChanges: { data: [], allData: [], filters: {}, page: 1, limit: 50 },
    runs: { data: [] },
    stats: {},
    presets: JSON.parse(localStorage.getItem('yad2_presets') || '[]'),
};

let openDD = null;
let refreshTimer = null;

// ─── INIT ───────────────────────────────────────────────────────────────────

document.addEventListener('DOMContentLoaded', () => {
    initTabs();
    initRangeFilters();
    renderPresets();
    loadAll();
    refreshTimer = setInterval(loadAll, AUTO_REFRESH_MS);
    document.addEventListener('click', e => {
        if (!e.target.closest('.multi-select')) closeAllDD();
    });
});

function initTabs() {
    document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            tab.classList.add('active');
            document.getElementById(`${tab.dataset.tab}-panel`).classList.add('active');
        });
    });
}

function initRangeFilters() {
    document.querySelectorAll('.range-filter input').forEach(input => {
        input.addEventListener('input', debounce(() => {
            const c = input.closest('.range-filter');
            S.listings.filters.price_min = parseInt(c.querySelector('[data-range="min"]').value) || null;
            S.listings.filters.price_max = parseInt(c.querySelector('[data-range="max"]').value) || null;
            S.listings.page = 1;
            filterAndRender('listings');
        }, 400));
    });
}

// ─── DATA LOADING ───────────────────────────────────────────────────────────

async function api(endpoint, params = {}) {
    const url = new URL(`${API_BASE}${endpoint}`);
    Object.entries(params).forEach(([k, v]) => { if (v != null && v !== '') url.searchParams.set(k, v); });
    const r = await fetch(url);
    if (!r.ok) throw new Error(`${r.status}`);
    return r.json();
}

async function loadAll() {
    await Promise.all([loadStats(), loadListings(), loadPriceChanges(), loadRuns()]);
    document.getElementById('lastUpdate').textContent = `Updated ${new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })}`;
}

async function loadStats() {
    try {
        const s = await api('/stats');
        S.stats = s;
        document.getElementById('hkTotal').textContent = fmtN(s.active_listings);
        document.getElementById('hkCities').textContent = fmtN(s.cities);
        document.getElementById('hkAvgPrice').textContent = `${fmtN(s.avg_price)}`;
        document.getElementById('hkChanges').textContent = fmtN(s.price_history?.changes_last_24h || 0);
        document.getElementById('overviewBadge').textContent = fmtN(s.active_listings);

        document.getElementById('kpiActive').textContent = fmtN(s.active_listings);
        document.getElementById('kpiTotal').textContent = fmtN(s.total_listings);
        document.getElementById('kpiAvg').textContent = `${fmtN(s.avg_price)}`;
        document.getElementById('kpiMin').textContent = `${fmtN(s.min_price)}`;
        document.getElementById('kpiMax').textContent = `${fmtN(s.max_price)}`;
        document.getElementById('kpiCities').textContent = fmtN(s.cities);
        document.getElementById('kpiNeighborhoods').textContent = fmtN(s.neighborhoods);
        document.getElementById('kpiChanges7d').textContent = fmtN(s.price_history?.changes_last_7d || 0);

        renderTopCities(s.top_cities || []);
        renderRoomsChart(s.rooms_distribution || []);
    } catch (e) { console.error('Stats error:', e); }
}

async function loadListings() {
    try {
        const d = await api('/listings', { limit: 1000, active_only: true });
        S.listings.allData = d.listings;
        document.getElementById('listingsBadge').textContent = fmtN(d.total);
        buildFilters('listings');
        filterAndRender('listings');
    } catch (e) {
        document.getElementById('listingsBody').innerHTML = `<tr><td colspan="10" class="empty-state">Error: ${e.message}</td></tr>`;
    }
}

async function loadPriceChanges() {
    try {
        const d = await api('/price-changes', { limit: 500, days: 30 });
        S.priceChanges.allData = d.changes;
        document.getElementById('priceChangesBadge').textContent = fmtN(d.changes.length);

        const drops = d.changes.filter(c => c.price_diff < 0);
        const raises = d.changes.filter(c => c.price_diff > 0);
        const avg = d.changes.length ? Math.round(d.changes.reduce((s, c) => s + c.price_diff, 0) / d.changes.length) : 0;

        document.getElementById('pcTotal').textContent = fmtN(d.changes.length);
        document.getElementById('pcDrops').textContent = fmtN(drops.length);
        document.getElementById('pcRaises').textContent = fmtN(raises.length);
        document.getElementById('pcAvg').textContent = `${fmtN(avg)}`;

        buildFilters('priceChanges');
        filterAndRender('priceChanges');
        renderLatestDrops(drops.slice(0, 8));
    } catch (e) {
        document.getElementById('priceChangesBody').innerHTML = `<tr><td colspan="11" class="empty-state">Error: ${e.message}</td></tr>`;
    }
}

async function loadRuns() {
    try {
        const d = await api('/runs', { limit: 50 });
        S.runs.data = d.runs;
        document.getElementById('runsBadge').textContent = fmtN(d.runs.length);
        renderRuns();
        renderScraperStatus(d.runs);
        renderRecentRuns(d.runs.slice(0, 8));
    } catch (e) {
        document.getElementById('runsBody').innerHTML = `<tr><td colspan="10" class="empty-state">Error: ${e.message}</td></tr>`;
    }
}

// ─── MULTI-SELECT FILTER SYSTEM ─────────────────────────────────────────────

function buildFilters(tbl) {
    document.querySelectorAll(`.multi-select[data-tbl="${tbl}"]`).forEach(container => {
        const col = container.dataset.col;
        const opts = getOptions(tbl, col);
        renderMS(container, opts, col, tbl);
    });
}

function getOptions(tbl, col) {
    const data = S[tbl].allData;
    const filters = S[tbl].filters;

    // Apply all OTHER filters to get cascaded counts
    let filtered = data;
    Object.entries(filters).forEach(([fc, vals]) => {
        if (fc === col || fc === 'price_min' || fc === 'price_max' || !vals?.length) return;
        filtered = filtered.filter(item => {
            if (fc === 'is_merchant') return vals.includes(String(item.is_merchant));
            if (fc === 'direction') {
                return (vals.includes('down') && item.price_diff < 0) || (vals.includes('up') && item.price_diff > 0);
            }
            return vals.includes(String(item[fc] || ''));
        });
    });

    if (col === 'is_merchant') {
        return [
            { value: 'true', label: 'Agent', count: filtered.filter(d => d.is_merchant).length },
            { value: 'false', label: 'Private', count: filtered.filter(d => !d.is_merchant).length },
        ];
    }
    if (col === 'direction') {
        return [
            { value: 'down', label: 'Drop', count: filtered.filter(d => d.price_diff < 0).length },
            { value: 'up', label: 'Raise', count: filtered.filter(d => d.price_diff > 0).length },
        ];
    }

    const counts = {};
    filtered.forEach(item => {
        const v = String(item[col] || '');
        if (v) counts[v] = (counts[v] || 0) + 1;
    });

    return Object.entries(counts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 150)
        .map(([value, count]) => ({ value, label: value, count }));
}

function renderMS(container, options, col, tbl) {
    const sel = S[tbl].filters[col] || [];
    const id = `dd-${tbl}-${col}`;

    container.innerHTML = `
        <div class="ms-trigger ${sel.length ? 'has-selection' : ''}" onclick="toggleDD(event,'${id}')">
            <span>${sel.length ? sel.length + ' selected' : 'All'}</span>
            ${sel.length ? `<span class="ms-count">${sel.length}</span>` : ''}
            <span class="ms-arrow">&#9660;</span>
        </div>
        <div class="ms-dropdown" id="${id}">
            <div class="ms-search">
                <input type="text" placeholder="Search..." oninput="searchDD(this)">
            </div>
            <div class="ms-actions">
                <button onclick="msAll('${tbl}','${col}','${id}')">Select All</button>
                <button onclick="msNone('${tbl}','${col}','${id}')">Clear</button>
            </div>
            <div class="ms-options">
                ${options.map(o => `
                    <label class="ms-option" data-v="${o.value}">
                        <input type="checkbox" value="${o.value}" ${sel.includes(o.value) ? 'checked' : ''}
                            onchange="msChange('${tbl}','${col}','${o.value}',this.checked)">
                        <span class="ms-option-label">${o.label}</span>
                        <span class="ms-option-count">${o.count}</span>
                    </label>
                `).join('')}
            </div>
        </div>
    `;
}

function toggleDD(e, id) {
    e.stopPropagation();
    const dd = document.getElementById(id);
    const trigger = dd.previousElementSibling;

    if (openDD && openDD !== dd) {
        openDD.classList.remove('open');
        openDD.previousElementSibling.classList.remove('open');
    }

    dd.classList.toggle('open');
    trigger.classList.toggle('open');
    openDD = dd.classList.contains('open') ? dd : null;

    if (openDD) {
        const input = dd.querySelector('.ms-search input');
        if (input) setTimeout(() => input.focus(), 50);
    }
}

function closeAllDD() {
    document.querySelectorAll('.ms-dropdown.open').forEach(d => {
        d.classList.remove('open');
        d.previousElementSibling.classList.remove('open');
    });
    openDD = null;
}

function searchDD(input) {
    const q = input.value.toLowerCase();
    input.closest('.ms-dropdown').querySelectorAll('.ms-option').forEach(o => {
        o.style.display = o.textContent.toLowerCase().includes(q) ? '' : 'none';
    });
}

function msAll(tbl, col, id) {
    const dd = document.getElementById(id);
    const visible = dd.querySelectorAll('.ms-option:not([style*="display: none"]) input');
    const vals = Array.from(visible).map(cb => { cb.checked = true; return cb.value; });
    S[tbl].filters[col] = vals;
    S[tbl].page = 1;
    buildFilters(tbl);
    filterAndRender(tbl);
}

function msNone(tbl, col) {
    S[tbl].filters[col] = [];
    S[tbl].page = 1;
    buildFilters(tbl);
    filterAndRender(tbl);
}

function msChange(tbl, col, val, checked) {
    if (!S[tbl].filters[col]) S[tbl].filters[col] = [];
    if (checked) {
        if (!S[tbl].filters[col].includes(val)) S[tbl].filters[col].push(val);
    } else {
        S[tbl].filters[col] = S[tbl].filters[col].filter(v => v !== val);
    }
    S[tbl].page = 1;
    // Rebuild ALL filter dropdowns for this table (cascading)
    buildFilters(tbl);
    filterAndRender(tbl);
}

// ─── FILTERING & RENDERING ──────────────────────────────────────────────────

function filterAndRender(tbl) {
    if (tbl === 'listings') filterListings();
    else if (tbl === 'priceChanges') filterPriceChanges();
}

function filterListings() {
    const f = S.listings.filters;
    let data = S.listings.allData;

    Object.entries(f).forEach(([col, vals]) => {
        if (col === 'price_min' || col === 'price_max' || !vals?.length) return;
        if (col === 'is_merchant') {
            data = data.filter(i => vals.includes(String(i.is_merchant)));
        } else {
            data = data.filter(i => vals.includes(String(i[col] || '')));
        }
    });

    if (f.price_min) data = data.filter(i => i.price_numeric >= f.price_min);
    if (f.price_max) data = data.filter(i => i.price_numeric <= f.price_max);

    // Sort
    const { col, ord } = S.listings.sort;
    data.sort((a, b) => {
        let av = a[col], bv = b[col];
        if (av == null) av = '';
        if (bv == null) bv = '';
        if (typeof av === 'string') { av = av.toLowerCase(); bv = (bv || '').toLowerCase(); }
        if (av < bv) return ord === 'asc' ? -1 : 1;
        if (av > bv) return ord === 'asc' ? 1 : -1;
        return 0;
    });

    S.listings.data = data;

    const start = (S.listings.page - 1) * S.listings.limit;
    const page = data.slice(start, start + S.listings.limit);

    renderListingsTable(page);
    renderPagination('listings', data.length);
    renderActiveChips();
    updateSortIcons();
}

function renderListingsTable(listings) {
    const tbody = document.getElementById('listingsBody');
    if (!listings.length) {
        tbody.innerHTML = '<tr><td colspan="10" class="empty-state">No listings found</td></tr>';
        return;
    }

    tbody.innerHTML = listings.map(l => `
        <tr>
            <td>${l.city || '-'}</td>
            <td>${l.neighborhood || '-'}</td>
            <td>${l.street || '-'}</td>
            <td>${l.rooms || '-'}</td>
            <td><strong>${fmtP(l.price_numeric)}</strong></td>
            <td>${l.size_sqm || '-'}</td>
            <td>${l.floor || '-'}</td>
            <td>${l.is_merchant ? '<span class="badge badge-warning">Agent</span>' : '<span class="badge badge-success">Private</span>'}</td>
            <td>${fmtD(l.first_seen_at)}</td>
            <td><a href="https://www.yad2.co.il/item/${l.link_token || l.id}" target="_blank">View</a></td>
        </tr>
    `).join('');
}

function filterPriceChanges() {
    const f = S.priceChanges.filters;
    let data = S.priceChanges.allData;

    Object.entries(f).forEach(([col, vals]) => {
        if (!vals?.length) return;
        if (col === 'direction') {
            data = data.filter(i => (vals.includes('down') && i.price_diff < 0) || (vals.includes('up') && i.price_diff > 0));
        } else {
            data = data.filter(i => vals.includes(String(i[col] || '')));
        }
    });

    S.priceChanges.data = data;

    const start = (S.priceChanges.page - 1) * S.priceChanges.limit;
    const page = data.slice(start, start + S.priceChanges.limit);

    renderPriceChangesTable(page);
    renderPagination('priceChanges', data.length);
}

function renderPriceChangesTable(changes) {
    const tbody = document.getElementById('priceChangesBody');
    if (!changes.length) {
        tbody.innerHTML = '<tr><td colspan="11" class="empty-state">No price changes found</td></tr>';
        return;
    }

    tbody.innerHTML = changes.map(c => {
        const down = c.price_diff < 0;
        const cls = down ? 'price-down' : 'price-up';
        const arrow = down ? '&#9660;' : '&#9650;';
        return `
            <tr>
                <td>${c.city || '-'}</td>
                <td>${c.neighborhood || '-'}</td>
                <td>${c.street || '-'}</td>
                <td>${c.rooms || '-'}</td>
                <td>${fmtP(c.previous_price)}</td>
                <td><strong>${fmtP(c.price_numeric)}</strong></td>
                <td><span class="${cls}">${arrow}</span></td>
                <td class="${cls}">${fmtP(Math.abs(c.price_diff))}</td>
                <td class="${cls}">${c.price_diff_percent}%</td>
                <td>${fmtDT(c.recorded_at)}</td>
                <td><a href="https://www.yad2.co.il/item/${c.listing_id}" target="_blank">View</a></td>
            </tr>
        `;
    }).join('');
}

function renderRuns() {
    const tbody = document.getElementById('runsBody');
    const runs = S.runs.data;

    if (!runs.length) {
        tbody.innerHTML = '<tr><td colspan="10" class="empty-state">No runs yet</td></tr>';
        return;
    }

    tbody.innerHTML = runs.map(r => {
        const dur = r.finished_at && r.started_at ? fmtDur(new Date(r.finished_at) - new Date(r.started_at)) : (r.status === 'running' ? 'Running...' : '-');
        const statusCls = r.status === 'completed' ? 'success' : r.status === 'running' ? 'info' : 'danger';
        const type = r.run_type || 'full';
        const typeBadge = type === 'smart' ? '<span class="badge badge-info">Smart</span>' : '<span class="badge badge-neutral">Full</span>';

        return `
            <tr>
                <td>${r.id}</td>
                <td>${typeBadge}</td>
                <td>${fmtDT(r.started_at)}</td>
                <td>${dur}</td>
                <td>${r.pages_scraped || 0}/${r.total_pages || 0}</td>
                <td>${fmtN(r.listings_found || 0)}</td>
                <td>${fmtN(r.listings_new || 0)}</td>
                <td>${fmtN(r.listings_updated || 0)}</td>
                <td>${fmtN(r.price_changes || 0)}</td>
                <td><span class="badge badge-${statusCls}">${r.status}</span></td>
            </tr>
        `;
    }).join('');
}

// ─── CHARTS ─────────────────────────────────────────────────────────────────

function renderTopCities(cities) {
    const el = document.getElementById('topCitiesChart');
    if (!cities.length) { el.innerHTML = '<div class="empty-state">No data</div>'; return; }
    const max = cities[0].count;
    el.innerHTML = `<div class="bar-chart">${cities.slice(0, 10).map((c, i) => `
        <div class="bar-row">
            <div class="bar-label" title="${c.city}">${c.city}</div>
            <div class="bar-track">
                <div class="bar-fill" style="width:${(c.count / max * 100).toFixed(1)}%;background:${COLORS[i % COLORS.length]}">
                    <span>${c.count}</span>
                </div>
            </div>
        </div>
    `).join('')}</div>`;
}

function renderRoomsChart(rooms) {
    const el = document.getElementById('roomsChart');
    if (!rooms.length) { el.innerHTML = '<div class="empty-state">No data</div>'; return; }
    const max = Math.max(...rooms.map(r => r.count));
    el.innerHTML = `<div class="bar-chart">${rooms.filter(r => r.rooms).slice(0, 10).map((r, i) => `
        <div class="bar-row">
            <div class="bar-label">${r.rooms} rooms</div>
            <div class="bar-track">
                <div class="bar-fill" style="width:${(r.count / max * 100).toFixed(1)}%;background:${COLORS[i % COLORS.length]}">
                    <span>${r.count}</span>
                </div>
            </div>
        </div>
    `).join('')}</div>`;
}

function renderScraperStatus(runs) {
    const el = document.getElementById('scraperStatusContainer');
    const latest = runs[0];
    if (!latest) { el.innerHTML = ''; return; }

    const isRunning = latest.status === 'running';
    const pct = latest.total_pages ? Math.round((latest.pages_scraped || 0) / latest.total_pages * 100) : 0;
    const type = latest.run_type || 'full';

    el.innerHTML = `
        <div class="scraper-status">
            <div class="scraper-status-icon ${isRunning ? 'running' : 'idle'}">${isRunning ? '&#9881;' : '&#10003;'}</div>
            <div class="scraper-status-text">
                <div class="scraper-status-title">${isRunning ? `${type.toUpperCase()} scrape running...` : `Last ${type} scrape completed`}</div>
                <div class="scraper-status-detail">
                    ${isRunning ? `Page ${latest.pages_scraped || 0}/${latest.total_pages || '?'} | ${latest.listings_new || 0} new` :
                    `${fmtDT(latest.finished_at)} | ${latest.pages_scraped}/${latest.total_pages} pages | ${latest.listings_new || 0} new`}
                </div>
            </div>
            ${isRunning ? `<div class="scraper-status-progress"><div class="scraper-status-progress-fill" style="width:${pct}%"></div></div>` : ''}
        </div>
    `;
}

function renderRecentRuns(runs) {
    const el = document.getElementById('recentRunsChart');
    if (!runs.length) { el.innerHTML = '<div class="empty-state">No data</div>'; return; }

    el.innerHTML = `<div style="display:flex;flex-direction:column;gap:0.5rem;">${runs.map(r => {
        const dur = r.finished_at && r.started_at ? fmtDur(new Date(r.finished_at) - new Date(r.started_at)) : '-';
        const type = r.run_type || 'full';
        const statusColor = r.status === 'completed' ? 'var(--success)' : r.status === 'running' ? 'var(--info)' : 'var(--danger)';
        return `
            <div style="display:flex;align-items:center;gap:0.75rem;font-size:0.75rem;padding:0.375rem 0;border-bottom:1px solid var(--gray-100);">
                <span style="width:6px;height:6px;border-radius:50%;background:${statusColor};flex-shrink:0;"></span>
                <span style="color:var(--gray-500);width:30px;">#${r.id}</span>
                <span class="badge badge-${type === 'smart' ? 'info' : 'neutral'}" style="font-size:0.5625rem;">${type}</span>
                <span style="flex:1;color:var(--gray-600);">${r.pages_scraped || 0}p / ${fmtN(r.listings_new || 0)} new</span>
                <span style="color:var(--gray-400);">${dur}</span>
            </div>
        `;
    }).join('')}</div>`;
}

function renderLatestDrops(drops) {
    const el = document.getElementById('latestDropsChart');
    if (!drops.length) { el.innerHTML = '<div class="empty-state">No price drops</div>'; return; }

    el.innerHTML = `<div style="display:flex;flex-direction:column;gap:0.5rem;">${drops.map(d => `
        <div style="display:flex;align-items:center;gap:0.75rem;font-size:0.75rem;padding:0.375rem 0;border-bottom:1px solid var(--gray-100);">
            <span style="color:var(--success);font-weight:600;">&#9660;</span>
            <span style="flex:1;color:var(--gray-700);">${d.city}, ${d.street || d.neighborhood || ''}</span>
            <span style="text-decoration:line-through;color:var(--gray-400);">${fmtP(d.previous_price)}</span>
            <span style="font-weight:600;color:var(--success);">${fmtP(d.price_numeric)}</span>
            <span style="color:var(--success);font-size:0.625rem;">${d.price_diff_percent}%</span>
        </div>
    `).join('')}</div>`;
}

// ─── SORTING ────────────────────────────────────────────────────────────────

function sortListings(col) {
    if (S.listings.sort.col === col) {
        S.listings.sort.ord = S.listings.sort.ord === 'asc' ? 'desc' : 'asc';
    } else {
        S.listings.sort.col = col;
        S.listings.sort.ord = 'asc';
    }
    S.listings.page = 1;
    filterAndRender('listings');
}

function updateSortIcons() {
    document.querySelectorAll('.sort-icon').forEach(icon => {
        const col = icon.dataset.sort;
        if (col === S.listings.sort.col) {
            icon.classList.add('active');
            icon.innerHTML = S.listings.sort.ord === 'asc' ? '&#9650;' : '&#9660;';
        } else {
            icon.classList.remove('active');
            icon.innerHTML = '&#9650;';
        }
    });
}

// ─── ACTIVE FILTER CHIPS ────────────────────────────────────────────────────

function renderActiveChips() {
    const el = document.getElementById('activeFiltersChips');
    const f = S.listings.filters;
    const chips = [];

    Object.entries(f).forEach(([col, vals]) => {
        if (col === 'price_min' && vals) chips.push({ label: `Min: ${fmtP(vals)}`, col, type: 'range' });
        else if (col === 'price_max' && vals) chips.push({ label: `Max: ${fmtP(vals)}`, col, type: 'range' });
        else if (vals?.length) {
            const display = vals.length <= 2 ? vals.join(', ') : `${vals.length} selected`;
            chips.push({ label: `${colName(col)}: ${display}`, col, type: 'multi' });
        }
    });

    if (!chips.length) { el.innerHTML = ''; return; }

    el.innerHTML = chips.map(c => `
        <span class="filter-chip">
            ${c.label}
            <span class="filter-chip-remove" onclick="removeFilter('${c.col}','${c.type}')">&#215;</span>
        </span>
    `).join('') + `<button class="clear-all-btn" onclick="clearAllFilters()">Clear all</button>`;
}

function colName(col) {
    const map = { city: 'City', neighborhood: 'Neighborhood', rooms: 'Rooms', size_sqm: 'Sqm', floor: 'Floor', is_merchant: 'Type', street: 'Street' };
    return map[col] || col;
}

function removeFilter(col, type) {
    if (type === 'range') {
        S.listings.filters[col] = null;
        if (col === 'price_min') document.querySelector('.range-filter [data-range="min"]').value = '';
        if (col === 'price_max') document.querySelector('.range-filter [data-range="max"]').value = '';
    } else {
        S.listings.filters[col] = [];
    }
    S.listings.page = 1;
    buildFilters('listings');
    filterAndRender('listings');
}

function clearAllFilters() {
    S.listings.filters = {};
    S.listings.page = 1;
    document.querySelectorAll('.range-filter input').forEach(i => i.value = '');
    buildFilters('listings');
    filterAndRender('listings');
    toast('Filters cleared');
}

function clearPriceChangeFilters() {
    S.priceChanges.filters = {};
    S.priceChanges.page = 1;
    buildFilters('priceChanges');
    filterAndRender('priceChanges');
}

function filterByCity(city) {
    S.listings.filters = { city: [city] };
    S.listings.page = 1;
    document.querySelector('[data-tab="listings"]').click();
    buildFilters('listings');
    filterAndRender('listings');
}

// ─── PAGINATION ─────────────────────────────────────────────────────────────

function renderPagination(tbl, total) {
    const st = S[tbl];
    const totalPages = Math.ceil(total / st.limit);
    const info = document.getElementById(`${tbl}PaginationInfo`);
    const controls = document.getElementById(`${tbl}Pagination`);

    const start = Math.min((st.page - 1) * st.limit + 1, total);
    const end = Math.min(st.page * st.limit, total);
    info.textContent = total ? `${start}-${end} of ${fmtN(total)}` : 'No results';

    if (totalPages <= 1) { controls.innerHTML = ''; return; }

    const pages = pgNums(st.page, totalPages);
    controls.innerHTML =
        `<button class="page-btn" onclick="goPage('${tbl}',${st.page - 1})" ${st.page === 1 ? 'disabled' : ''}>&laquo;</button>` +
        pages.map(p => p === '...' ? '<span style="padding:0 0.375rem;color:var(--gray-400)">...</span>' :
            `<button class="page-btn ${p === st.page ? 'active' : ''}" onclick="goPage('${tbl}',${p})">${p}</button>`
        ).join('') +
        `<button class="page-btn" onclick="goPage('${tbl}',${st.page + 1})" ${st.page === totalPages ? 'disabled' : ''}>&raquo;</button>`;
}

function pgNums(cur, total) {
    if (total <= 7) return Array.from({ length: total }, (_, i) => i + 1);
    const p = [1];
    if (cur > 3) p.push('...');
    for (let i = Math.max(2, cur - 1); i <= Math.min(total - 1, cur + 1); i++) p.push(i);
    if (cur < total - 2) p.push('...');
    p.push(total);
    return p;
}

function goPage(tbl, page) {
    S[tbl].page = page;
    filterAndRender(tbl);
    document.querySelector(`#${tbl === 'priceChanges' ? 'price-changes' : tbl}-panel .table-container`)?.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

// ─── PRESETS ────────────────────────────────────────────────────────────────

function renderPresets() {
    const el = document.getElementById('listingsPresets');
    el.innerHTML = S.presets.map((p, i) => `
        <button class="preset-btn" onclick="applyPreset(${i})">
            ${p.name}
            <span onclick="event.stopPropagation();deletePreset(${i})" style="opacity:0.5;margin-right:4px;cursor:pointer;">&#215;</span>
        </button>
    `).join('');
}

function savePreset() {
    document.getElementById('presetModal').classList.add('active');
    document.getElementById('presetName').focus();
}

function closePresetModal() {
    document.getElementById('presetModal').classList.remove('active');
    document.getElementById('presetName').value = '';
}

function confirmSavePreset() {
    const name = document.getElementById('presetName').value.trim();
    if (!name) return;
    S.presets.push({ name, filters: JSON.parse(JSON.stringify(S.listings.filters)) });
    localStorage.setItem('yad2_presets', JSON.stringify(S.presets));
    closePresetModal();
    renderPresets();
    toast(`Preset "${name}" saved`);
}

function applyPreset(i) {
    const p = S.presets[i];
    if (!p) return;
    S.listings.filters = JSON.parse(JSON.stringify(p.filters));
    S.listings.page = 1;
    // Restore range inputs
    const min = S.listings.filters.price_min;
    const max = S.listings.filters.price_max;
    const minInput = document.querySelector('.range-filter [data-range="min"]');
    const maxInput = document.querySelector('.range-filter [data-range="max"]');
    if (minInput) minInput.value = min || '';
    if (maxInput) maxInput.value = max || '';
    buildFilters('listings');
    filterAndRender('listings');
    toast(`Preset "${p.name}" applied`);
}

function deletePreset(i) {
    S.presets.splice(i, 1);
    localStorage.setItem('yad2_presets', JSON.stringify(S.presets));
    renderPresets();
}

// ─── UTILITIES ──────────────────────────────────────────────────────────────

function fmtN(n) { return n == null ? '-' : Number(n).toLocaleString('en-US'); }
function fmtP(n) { return n == null ? '-' : `${Number(n).toLocaleString('en-US')}`; }
function fmtD(s) { return s ? new Date(s).toLocaleDateString('en-GB') : '-'; }
function fmtDT(s) { return s ? new Date(s).toLocaleString('en-GB', { day:'2-digit',month:'2-digit',year:'2-digit',hour:'2-digit',minute:'2-digit' }) : '-'; }
function fmtDur(ms) {
    const m = Math.floor(ms / 60000);
    if (m < 60) return `${m}m`;
    return `${Math.floor(m / 60)}h ${m % 60}m`;
}

function debounce(fn, ms) {
    let t;
    return function (...a) { clearTimeout(t); t = setTimeout(() => fn.apply(this, a), ms); };
}

function toast(msg) {
    const el = document.getElementById('toast');
    el.textContent = msg;
    el.classList.add('visible');
    setTimeout(() => el.classList.remove('visible'), 2500);
}
</script>
</body>
</html>
