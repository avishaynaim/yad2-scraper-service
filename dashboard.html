<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yad2 Scraper Dashboard</title>
    <style>
        :root {
            --primary: #4f46e5;
            --primary-light: #818cf8;
            --primary-dark: #3730a3;
            --primary-bg: #eef2ff;
            --success: #059669;
            --success-light: #d1fae5;
            --warning: #d97706;
            --warning-light: #fef3c7;
            --danger: #dc2626;
            --danger-light: #fee2e2;
            --info: #0284c7;
            --info-light: #e0f2fe;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
            --radius: 0.75rem;
            --radius-sm: 0.5rem;
            --shadow: 0 1px 3px rgba(0,0,0,0.08);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
            --shadow-lg: 0 12px 24px rgba(0,0,0,0.12);
            --transition: 0.2s ease;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: var(--gray-100);
            color: var(--gray-800);
            line-height: 1.6;
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 0.875rem 1.5rem;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 20px rgba(79, 70, 229, 0.3);
        }

        .header-content {
            max-width: 1920px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
        }

        .header-left { display: flex; align-items: center; gap: 1rem; }
        .header h1 { font-size: 1.25rem; font-weight: 700; letter-spacing: -0.02em; }

        .live-badge {
            display: flex;
            align-items: center;
            gap: 0.375rem;
            font-size: 0.75rem;
            background: rgba(255,255,255,0.15);
            padding: 0.25rem 0.625rem;
            border-radius: 1rem;
            backdrop-filter: blur(8px);
        }

        .live-dot {
            width: 8px;
            height: 8px;
            background: #34d399;
            border-radius: 50%;
            animation: pulse-dot 2s ease-in-out infinite;
        }

        @keyframes pulse-dot {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(0.8); }
        }

        .header-kpis {
            display: flex;
            gap: 1.5rem;
            align-items: center;
        }

        .header-kpi { text-align: center; }
        .header-kpi-value { font-size: 1.125rem; font-weight: 700; }
        .header-kpi-label { font-size: 0.6875rem; opacity: 0.8; }

        .last-update {
            font-size: 0.6875rem;
            opacity: 0.7;
            text-align: left;
        }

        /* Container */
        .container { max-width: 1920px; margin: 0 auto; padding: 1.25rem; }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 0.25rem;
            margin-bottom: 1.25rem;
            background: white;
            border-radius: var(--radius);
            padding: 0.25rem;
            box-shadow: var(--shadow);
            overflow-x: auto;
        }

        .tab {
            flex: 1;
            padding: 0.625rem 1rem;
            background: transparent;
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 0.8125rem;
            font-weight: 500;
            color: var(--gray-500);
            transition: var(--transition);
            white-space: nowrap;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .tab:hover { color: var(--gray-700); background: var(--gray-50); }
        .tab.active { background: var(--primary); color: white; box-shadow: 0 2px 8px rgba(79,70,229,0.3); }

        .tab-badge {
            background: var(--gray-200);
            color: var(--gray-600);
            padding: 0.125rem 0.5rem;
            border-radius: 1rem;
            font-size: 0.6875rem;
            font-weight: 600;
            min-width: 1.5rem;
            text-align: center;
        }

        .tab.active .tab-badge { background: rgba(255,255,255,0.25); color: white; }

        /* Panels */
        .panel { display: none; }
        .panel.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(4px); } to { opacity: 1; transform: translateY(0); } }

        /* Analytics Grid */
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 0.75rem;
            margin-bottom: 1.25rem;
        }

        .kpi-card {
            background: white;
            padding: 1rem 1.25rem;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            border-right: 4px solid var(--gray-200);
            transition: var(--transition);
        }

        .kpi-card:hover { box-shadow: var(--shadow-md); transform: translateY(-1px); }
        .kpi-card.accent-primary { border-right-color: var(--primary); }
        .kpi-card.accent-success { border-right-color: var(--success); }
        .kpi-card.accent-warning { border-right-color: var(--warning); }
        .kpi-card.accent-danger { border-right-color: var(--danger); }
        .kpi-card.accent-info { border-right-color: var(--info); }

        .kpi-value { font-size: 1.5rem; font-weight: 700; color: var(--gray-900); line-height: 1.2; }
        .kpi-label { font-size: 0.75rem; color: var(--gray-500); margin-top: 0.125rem; }
        .kpi-trend { font-size: 0.6875rem; margin-top: 0.25rem; }
        .kpi-trend.up { color: var(--danger); }
        .kpi-trend.down { color: var(--success); }

        /* Charts Row */
        .charts-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
            margin-bottom: 1.25rem;
        }

        .chart-card {
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .chart-card-header {
            padding: 0.875rem 1.25rem;
            border-bottom: 1px solid var(--gray-100);
            font-weight: 600;
            font-size: 0.875rem;
            color: var(--gray-700);
        }

        .chart-card-body { padding: 1rem 1.25rem; }

        /* Bar Chart */
        .bar-chart { display: flex; flex-direction: column; gap: 0.5rem; }
        .bar-row { display: flex; align-items: center; gap: 0.5rem; font-size: 0.75rem; }
        .bar-label { width: 80px; text-align: right; color: var(--gray-600); flex-shrink: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .bar-track { flex: 1; height: 22px; background: var(--gray-100); border-radius: 4px; overflow: hidden; position: relative; }
        .bar-fill { height: 100%; border-radius: 4px; transition: width 0.6s ease; display: flex; align-items: center; padding: 0 0.5rem; }
        .bar-fill span { font-size: 0.625rem; font-weight: 600; color: white; white-space: nowrap; }
        .bar-count { width: 50px; text-align: left; font-weight: 500; color: var(--gray-500); font-size: 0.6875rem; }

        /* Card */
        .card {
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            margin-bottom: 1.25rem;
        }

        .card-header {
            padding: 0.875rem 1.25rem;
            border-bottom: 1px solid var(--gray-100);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.75rem;
        }

        .card-title { font-size: 0.9375rem; font-weight: 600; color: var(--gray-800); }

        /* Active Filters Bar */
        .active-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 0.375rem;
            align-items: center;
            padding: 0 1.25rem;
        }

        .active-filters:empty { display: none; }

        .active-filters-bar {
            border-bottom: 1px solid var(--gray-100);
            padding: 0.625rem 0;
        }

        .filter-chip {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            background: var(--primary-bg);
            color: var(--primary);
            padding: 0.25rem 0.5rem;
            border-radius: 1rem;
            font-size: 0.6875rem;
            font-weight: 500;
        }

        .filter-chip-remove {
            cursor: pointer;
            opacity: 0.6;
            font-size: 0.875rem;
            line-height: 1;
        }

        .filter-chip-remove:hover { opacity: 1; }

        .clear-all-btn {
            background: none;
            border: none;
            color: var(--danger);
            font-size: 0.6875rem;
            cursor: pointer;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
        }

        .clear-all-btn:hover { background: var(--danger-light); }

        /* Filter Toolbar */
        .filter-toolbar {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .preset-btn {
            padding: 0.375rem 0.625rem;
            background: var(--gray-50);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-sm);
            font-size: 0.6875rem;
            cursor: pointer;
            transition: var(--transition);
        }

        .preset-btn:hover { background: var(--gray-100); border-color: var(--gray-300); }

        /* Table */
        .table-container { overflow-x: auto; -webkit-overflow-scrolling: touch; }

        table { width: 100%; border-collapse: collapse; font-size: 0.8125rem; }

        th, td {
            padding: 0.625rem 0.875rem;
            text-align: right;
            border-bottom: 1px solid var(--gray-100);
            white-space: nowrap;
        }

        th {
            background: var(--gray-50);
            font-weight: 600;
            font-size: 0.75rem;
            color: var(--gray-500);
            text-transform: uppercase;
            letter-spacing: 0.03em;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        tbody tr { transition: background var(--transition); }
        tbody tr:nth-child(even) { background: var(--gray-50); }
        tbody tr:hover { background: var(--primary-bg); }
        .new-badge { display:inline-block;font-size:0.5625rem;font-weight:700;background:var(--success);color:white;padding:0.0625rem 0.3125rem;border-radius:0.25rem;margin-right:0.25rem;vertical-align:middle;letter-spacing:0.03em; }

        .th-content { display: flex; flex-direction: column; gap: 0.375rem; }
        .th-label { display: flex; align-items: center; gap: 0.375rem; cursor: pointer; user-select: none; }
        .th-label:hover { color: var(--primary); }
        .sort-icon { font-size: 0.625rem; opacity: 0.4; }
        .sort-icon.active { opacity: 1; color: var(--primary); }

        /* Multi-select Dropdown */
        .multi-select { position: relative; min-width: 100px; }

        .ms-trigger {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.3125rem 0.5rem;
            border: 1px solid var(--gray-200);
            border-radius: 0.25rem;
            background: white;
            cursor: pointer;
            font-size: 0.6875rem;
            min-height: 26px;
            gap: 0.25rem;
            transition: var(--transition);
        }

        .ms-trigger:hover { border-color: var(--primary-light); }
        .ms-trigger.has-selection { border-color: var(--primary); background: var(--primary-bg); }

        .ms-count {
            background: var(--primary);
            color: white;
            padding: 0 0.375rem;
            border-radius: 0.25rem;
            font-size: 0.5625rem;
            font-weight: 600;
            line-height: 1.4;
        }

        .ms-arrow { font-size: 0.5rem; color: var(--gray-400); transition: transform var(--transition); }
        .ms-trigger.open .ms-arrow { transform: rotate(180deg); }

        .ms-dropdown {
            position: absolute;
            top: calc(100% + 4px);
            right: 0;
            min-width: 200px;
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-sm);
            box-shadow: var(--shadow-lg);
            z-index: 1000;
            display: none;
            overflow: hidden;
        }

        .ms-dropdown.open { display: block; animation: dropIn 0.15s ease; }
        @keyframes dropIn { from { opacity: 0; transform: translateY(-4px); } to { opacity: 1; transform: translateY(0); } }

        .ms-search {
            padding: 0.5rem;
            border-bottom: 1px solid var(--gray-100);
        }

        .ms-search input {
            width: 100%;
            padding: 0.375rem 0.5rem;
            border: 1px solid var(--gray-200);
            border-radius: 0.25rem;
            font-size: 0.75rem;
            outline: none;
        }

        .ms-search input:focus { border-color: var(--primary-light); }

        .ms-actions {
            display: flex;
            gap: 0.25rem;
            padding: 0.375rem 0.5rem;
            border-bottom: 1px solid var(--gray-100);
            background: var(--gray-50);
        }

        .ms-actions button {
            flex: 1;
            padding: 0.25rem;
            border: none;
            border-radius: 0.25rem;
            background: white;
            cursor: pointer;
            font-size: 0.625rem;
            color: var(--gray-600);
            transition: var(--transition);
        }

        .ms-actions button:hover { background: var(--primary-bg); color: var(--primary); }

        .ms-options { max-height: 220px; overflow-y: auto; }

        .ms-option {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.4375rem 0.5rem;
            cursor: pointer;
            font-size: 0.75rem;
            transition: background var(--transition);
        }

        .ms-option:hover { background: var(--gray-50); }
        .ms-option input[type="checkbox"] { accent-color: var(--primary); margin: 0; cursor: pointer; }
        .ms-option-label { flex: 1; }
        .ms-option-count { color: var(--gray-400); font-size: 0.625rem; }

        /* Range Filter */
        .range-filter { display: flex; gap: 0.25rem; align-items: center; }
        .range-filter input {
            width: 55px;
            padding: 0.3125rem 0.375rem;
            border: 1px solid var(--gray-200);
            border-radius: 0.25rem;
            font-size: 0.6875rem;
            text-align: center;
            outline: none;
        }
        .range-filter input:focus { border-color: var(--primary-light); }

        /* Price styling */
        .price-up { color: var(--danger); }
        .price-down { color: var(--success); }
        .price-stable { color: var(--gray-400); }

        .trend-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.75rem;
            font-weight: 500;
        }

        /* Badges */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 0.1875rem 0.5rem;
            border-radius: 1rem;
            font-size: 0.6875rem;
            font-weight: 500;
        }

        .badge-success { background: var(--success-light); color: var(--success); }
        .badge-warning { background: var(--warning-light); color: var(--warning); }
        .badge-danger { background: var(--danger-light); color: var(--danger); }
        .badge-info { background: var(--info-light); color: var(--info); }
        .badge-neutral { background: var(--gray-100); color: var(--gray-600); }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1.25rem;
            border-top: 1px solid var(--gray-100);
            flex-wrap: wrap;
            gap: 0.75rem;
        }

        .pagination-info { color: var(--gray-500); font-size: 0.8125rem; }
        .pagination-controls { display: flex; gap: 0.25rem; }

        .page-btn {
            padding: 0.375rem 0.625rem;
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: 0.25rem;
            cursor: pointer;
            font-size: 0.8125rem;
            transition: var(--transition);
            color: var(--gray-600);
        }

        .page-btn:hover:not(:disabled) { background: var(--gray-50); border-color: var(--gray-300); }
        .page-btn:disabled { opacity: 0.4; cursor: not-allowed; }
        .page-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

        /* Loading */
        .loading { display: flex; justify-content: center; align-items: center; padding: 2rem; color: var(--gray-400); gap: 0.75rem; }
        .spinner {
            width: 1.5rem; height: 1.5rem;
            border: 2px solid var(--gray-200);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .empty-state { text-align: center; padding: 2rem; color: var(--gray-400); font-size: 0.875rem; }

        /* Skeleton loading */
        .skeleton { background: linear-gradient(90deg, var(--gray-100) 25%, var(--gray-200) 50%, var(--gray-100) 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; border-radius: 4px; height: 1em; display: inline-block; }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

        /* Quick search */
        .quick-search {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .quick-search input {
            padding: 0.375rem 0.75rem;
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-sm);
            font-size: 0.8125rem;
            width: 200px;
            outline: none;
            transition: var(--transition);
        }
        .quick-search input:focus { border-color: var(--primary-light); box-shadow: 0 0 0 3px rgba(79,70,229,0.1); }

        /* Page size selector */
        .page-size-select {
            padding: 0.3125rem 0.5rem;
            border: 1px solid var(--gray-200);
            border-radius: 0.25rem;
            font-size: 0.75rem;
            outline: none;
            background: white;
        }

        /* Export button */
        .btn-export {
            padding: 0.375rem 0.75rem;
            background: var(--success);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 0.6875rem;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        .btn-export:hover { background: #047857; }

        /* Price/sqm highlight */
        .price-sqm { color: var(--info); font-weight: 500; font-size: 0.75rem; }

        /* Dark mode */
        .dark-toggle {
            background: rgba(255,255,255,0.15);
            border: none;
            color: white;
            padding: 0.25rem 0.625rem;
            border-radius: 1rem;
            cursor: pointer;
            font-size: 0.75rem;
            transition: var(--transition);
        }
        .dark-toggle:hover { background: rgba(255,255,255,0.25); }

        [data-theme="dark"] {
            --gray-50: #1a1a2e;
            --gray-100: #16213e;
            --gray-200: #1a1a2e;
            --gray-300: #2d3748;
            --gray-400: #718096;
            --gray-500: #a0aec0;
            --gray-600: #cbd5e0;
            --gray-700: #e2e8f0;
            --gray-800: #f7fafc;
            --gray-900: #ffffff;
            --primary-bg: rgba(79, 70, 229, 0.15);
            --success-light: rgba(5, 150, 105, 0.15);
            --warning-light: rgba(217, 119, 6, 0.15);
            --danger-light: rgba(220, 38, 38, 0.15);
            --info-light: rgba(2, 132, 199, 0.15);
        }
        [data-theme="dark"] body { background: #0f172a; }
        [data-theme="dark"] .card, [data-theme="dark"] .chart-card,
        [data-theme="dark"] .kpi-card, [data-theme="dark"] .tabs,
        [data-theme="dark"] .scraper-status { background: #1e293b; }
        [data-theme="dark"] table th { background: #1a1a2e; }
        [data-theme="dark"] .ms-dropdown { background: #1e293b; border-color: #2d3748; }
        [data-theme="dark"] .ms-search input, [data-theme="dark"] .range-filter input,
        [data-theme="dark"] .quick-search input, [data-theme="dark"] select,
        [data-theme="dark"] .modal input, [data-theme="dark"] .note-textarea,
        [data-theme="dark"] .note-status-select { background: #0f172a; color: #e2e8f0; border-color: #2d3748; }
        [data-theme="dark"] .modal { background: #1e293b; }
        [data-theme="dark"] .preset-btn { background: #1a1a2e; border-color: #2d3748; color: #a0aec0; }
        [data-theme="dark"] .page-btn { background: #1e293b; border-color: #2d3748; color: #a0aec0; }
        [data-theme="dark"] .compare-table th { background: #1a1a2e; }
        [data-theme="dark"] .status-called { background: rgba(37,99,235,0.2); }
        [data-theme="dark"] .status-visited { background: rgba(217,119,6,0.2); }
        [data-theme="dark"] .status-interested { background: rgba(5,150,105,0.2); }
        [data-theme="dark"] .status-rejected { background: rgba(220,38,38,0.2); }
        [data-theme="dark"] tbody tr:nth-child(even) { background: rgba(255,255,255,0.03); }
        [data-theme="dark"] .detail-dom-bar { background: #0f172a; border-color: #2d3748; }
        [data-theme="dark"] tr[style*="var(--primary-bg)"],
        [data-theme="dark"] tr[style*="var(--success-light)"],
        [data-theme="dark"] tr[style*="var(--warning-light)"],
        [data-theme="dark"] tr[style*="var(--info-light)"],
        [data-theme="dark"] tr[style*="var(--danger-light)"] { opacity: 0.85; }

        /* Scraper Status Panel */
        .scraper-status {
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 1rem 1.25rem;
            margin-bottom: 1.25rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .scraper-status-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            flex-shrink: 0;
        }

        .scraper-status-icon.running { background: var(--info-light); animation: pulse-bg 2s ease-in-out infinite; }
        .scraper-status-icon.idle { background: var(--success-light); }
        @keyframes pulse-bg { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }

        .scraper-status-text { flex: 1; }
        .scraper-status-title { font-weight: 600; font-size: 0.875rem; color: var(--gray-800); }
        .scraper-status-detail { font-size: 0.75rem; color: var(--gray-500); }

        .scraper-status-progress {
            width: 200px;
            height: 6px;
            background: var(--gray-200);
            border-radius: 3px;
            overflow: hidden;
        }

        .scraper-status-progress-fill {
            height: 100%;
            background: var(--primary);
            border-radius: 3px;
            transition: width 0.5s ease;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.4);
            backdrop-filter: blur(4px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-overlay.active { display: flex; }

        .modal {
            background: white;
            border-radius: var(--radius);
            padding: 1.5rem;
            max-width: 400px;
            width: 90%;
            box-shadow: var(--shadow-lg);
        }

        .modal h3 { margin-bottom: 1rem; font-size: 1rem; }
        .modal input {
            width: 100%;
            padding: 0.625rem;
            border: 1px solid var(--gray-300);
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
            margin-bottom: 1rem;
        }
        .modal-actions { display: flex; gap: 0.5rem; justify-content: flex-end; }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 0.8125rem;
            font-weight: 500;
            transition: var(--transition);
        }

        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-secondary { background: var(--gray-100); color: var(--gray-600); }
        .btn-secondary:hover { background: var(--gray-200); }

        a { color: var(--primary); text-decoration: none; }
        a:hover { text-decoration: underline; }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 1.5rem;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--gray-900);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: var(--radius);
            font-size: 0.8125rem;
            box-shadow: var(--shadow-lg);
            z-index: 10000;
            transition: transform 0.3s ease;
            pointer-events: none;
        }

        .toast.visible { transform: translateX(-50%) translateY(0); }

        /* Status badge styles */
        .status-active { color: var(--success); }
        .status-inactive { color: var(--gray-400); }

        /* Listing row highlight for new listings */
        tr.listing-new { background: rgba(5, 150, 105, 0.05); }
        tr.listing-new:hover { background: rgba(5, 150, 105, 0.1); }

        /* Sticky first column for mobile */
        .table-container table th:first-child,
        .table-container table td:first-child { position: sticky; right: 0; z-index: 5; background: inherit; }

        /* Smooth transitions for sort */
        tbody tr { transition: background var(--transition), opacity 0.2s ease; }

        /* Better scroll indicator */
        .table-container { position: relative; }
        .table-container::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 20px;
            height: 100%;
            background: linear-gradient(to right, transparent, rgba(0,0,0,0.03));
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .table-container.scrolled::after { opacity: 1; }

        /* Responsive */
        @media (max-width: 768px) {
            .header-content { flex-direction: column; gap: 0.5rem; }
            .header-kpis { gap: 1rem; flex-wrap: wrap; justify-content: center; }
            .container { padding: 0.75rem; }
            .analytics-grid { grid-template-columns: repeat(2, 1fr); }
            .charts-row { grid-template-columns: 1fr; }
            th, td { padding: 0.5rem 0.625rem; }
            .card-header { flex-direction: column; align-items: flex-start; }
            .tabs { flex-wrap: nowrap; overflow-x: auto; }
            .tab { min-width: fit-content; flex: none; }
            .scraper-status { flex-direction: column; text-align: center; }
            .scraper-status-progress { width: 100%; }
        }

        @media (max-width: 480px) {
            .analytics-grid { grid-template-columns: 1fr; }
            .kpi-value { font-size: 1.25rem; }
        }

        /* Favorites */
        .fav-star { cursor: pointer; font-size: 1rem; opacity: 0.3; transition: var(--transition); user-select: none; }
        .fav-star:hover { opacity: 0.7; }
        .fav-star.active { opacity: 1; color: #f59e0b; }

        /* Listing Notes & Status Tracker */
        .note-indicator { cursor: pointer; font-size: 0.8rem; opacity: 0.25; transition: var(--transition); user-select: none; }
        .note-indicator:hover { opacity: 0.6; }
        .note-indicator.has-note { opacity: 1; color: var(--info); }
        .status-pill {
            display: inline-flex;
            align-items: center;
            padding: 0.125rem 0.375rem;
            border-radius: 1rem;
            font-size: 0.5625rem;
            font-weight: 600;
            white-space: nowrap;
        }
        .status-called { background: #dbeafe; color: #2563eb; }
        .status-visited { background: #fef3c7; color: #d97706; }
        .status-interested { background: #d1fae5; color: #059669; }
        .status-rejected { background: #fee2e2; color: #dc2626; }
        .note-textarea {
            width: 100%;
            min-height: 60px;
            padding: 0.5rem;
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            font-family: inherit;
            resize: vertical;
            outline: none;
        }
        .note-textarea:focus { border-color: var(--primary-light); }
        .note-status-select {
            padding: 0.375rem 0.5rem;
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            outline: none;
            cursor: pointer;
            background: white;
        }
        .note-status-select:focus { border-color: var(--primary-light); }
        .note-preview { font-size: 0.625rem; color: var(--gray-400); max-width: 120px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

        /* Listing Compare */
        .compare-check { cursor: pointer; accent-color: var(--primary); margin: 0; }
        .compare-table { font-size: 0.75rem; }
        .compare-table th { background: var(--gray-50); font-weight: 600; color: var(--gray-500); text-transform: uppercase; font-size: 0.6875rem; }
        .compare-table td { padding: 0.5rem 0.75rem; border-bottom: 1px solid var(--gray-100); }
        .compare-table .metric-label { font-weight: 500; color: var(--gray-600); white-space: nowrap; }
        .compare-best { font-weight: 700; color: var(--success); }

        /* Listing thumbnail */
        .listing-thumb {
            width: 40px; height: 40px;
            border-radius: 4px;
            object-fit: cover;
            background: var(--gray-100);
            flex-shrink: 0;
        }

        /* Amenity tags */
        .amenity-tags { display: flex; flex-wrap: wrap; gap: 0.25rem; margin-top: 0.5rem; }
        .amenity-tag {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.1875rem 0.5rem;
            background: var(--primary-bg);
            color: var(--primary);
            border-radius: 1rem;
            font-size: 0.625rem;
            font-weight: 500;
        }

        /* Refresh countdown */
        .refresh-countdown {
            font-size: 0.625rem;
            opacity: 0.6;
            margin-top: 0.125rem;
        }

        /* Detail modal image */
        .detail-image {
            width: 100%;
            max-height: 200px;
            object-fit: cover;
            border-radius: var(--radius-sm);
            margin-bottom: 1rem;
            background: var(--gray-100);
        }
    </style>
</head>
<body>

<header class="header">
    <div class="header-content">
        <div class="header-left">
            <h1>Yad2 Dashboard</h1>
            <div class="live-badge">
                <span class="live-dot"></span>
                <span id="liveStatus">Auto-refresh</span>
            </div>
        </div>
        <div class="header-kpis" id="headerKpis">
            <div class="header-kpi">
                <div class="header-kpi-value" id="hkTotal">--</div>
                <div class="header-kpi-label">Active Listings</div>
            </div>
            <div class="header-kpi">
                <div class="header-kpi-value" id="hkCities">--</div>
                <div class="header-kpi-label">Cities</div>
            </div>
            <div class="header-kpi">
                <div class="header-kpi-value" id="hkAvgPrice">--</div>
                <div class="header-kpi-label">Avg Price</div>
            </div>
            <div class="header-kpi">
                <div class="header-kpi-value" id="hkChanges">--</div>
                <div class="header-kpi-label">Price Changes 24h</div>
            </div>
        </div>
        <div style="display:flex;align-items:center;gap:0.75rem;">
            <button class="dark-toggle" onclick="toggleDarkMode()" id="darkToggle" title="Toggle dark mode">Dark</button>
            <span class="dark-toggle" style="cursor:help;font-size:0.625rem;" title="Keys: 1-9 switch tabs, R to refresh, Esc close modals">?</span>
            <div>
                <div class="last-update" id="lastUpdate">Loading...</div>
                <div class="refresh-countdown" id="refreshCountdown"></div>
            </div>
        </div>
    </div>
</header>

<main class="container">
    <div class="tabs">
        <button class="tab active" data-tab="overview">Overview<span class="tab-badge" id="overviewBadge">--</span></button>
        <button class="tab" data-tab="listings">Listings<span class="tab-badge" id="listingsBadge">0</span></button>
        <button class="tab" data-tab="price-changes">Price Changes<span class="tab-badge" id="priceChangesBadge">0</span></button>
        <button class="tab" data-tab="analytics">Analytics<span class="tab-badge" id="analyticsBadge">0</span></button>
        <button class="tab" data-tab="deals">Deals<span class="tab-badge" id="dealsBadge">0</span></button>
        <button class="tab" data-tab="map">Map<span class="tab-badge" id="mapBadge">0</span></button>
        <button class="tab" data-tab="alerts">Alerts<span class="tab-badge" id="alertsBadge">0</span></button>
        <button class="tab" data-tab="favorites">Favorites<span class="tab-badge" id="favoritesBadge">0</span></button>
        <button class="tab" data-tab="runs">Scrape History<span class="tab-badge" id="runsBadge">0</span></button>
    </div>

    <!-- Overview Panel -->
    <div class="panel active" id="overview-panel">
        <div id="scraperStatusContainer"></div>

        <div class="analytics-grid" id="kpiGrid">
            <div class="kpi-card accent-primary">
                <div class="kpi-value" id="kpiActive">--</div>
                <div class="kpi-label">Active Listings</div>
            </div>
            <div class="kpi-card accent-info">
                <div class="kpi-value" id="kpiTotal">--</div>
                <div class="kpi-label">Total Ever Seen</div>
            </div>
            <div class="kpi-card accent-success">
                <div class="kpi-value" id="kpiAvg">--</div>
                <div class="kpi-label">Avg Price</div>
            </div>
            <div class="kpi-card accent-warning">
                <div class="kpi-value" id="kpiMin">--</div>
                <div class="kpi-label">Min Price</div>
            </div>
            <div class="kpi-card accent-danger">
                <div class="kpi-value" id="kpiMax">--</div>
                <div class="kpi-label">Max Price</div>
            </div>
            <div class="kpi-card accent-info">
                <div class="kpi-value" id="kpiCities">--</div>
                <div class="kpi-label">Cities</div>
            </div>
            <div class="kpi-card accent-primary">
                <div class="kpi-value" id="kpiNeighborhoods">--</div>
                <div class="kpi-label">Neighborhoods</div>
            </div>
            <div class="kpi-card accent-warning">
                <div class="kpi-value" id="kpiChanges7d">--</div>
                <div class="kpi-label">Price Changes 7d</div>
            </div>
            <div class="kpi-card accent-success">
                <div class="kpi-value" id="kpiNew24h">--</div>
                <div class="kpi-label">New 24h</div>
            </div>
            <div class="kpi-card accent-info">
                <div class="kpi-value" id="kpiNew7d">--</div>
                <div class="kpi-label">New 7d</div>
            </div>
        </div>

        <div class="charts-row">
            <div class="chart-card">
                <div class="chart-card-header">Top Cities</div>
                <div class="chart-card-body" id="topCitiesChart"></div>
            </div>
            <div class="chart-card">
                <div class="chart-card-header">Rooms Distribution</div>
                <div class="chart-card-body" id="roomsChart"></div>
            </div>
        </div>

        <div class="charts-row">
            <div class="chart-card">
                <div class="chart-card-header">Recent Scrape Runs</div>
                <div class="chart-card-body" id="recentRunsChart"></div>
            </div>
            <div class="chart-card">
                <div class="chart-card-header">Latest Price Drops</div>
                <div class="chart-card-body" id="latestDropsChart"></div>
            </div>
        </div>

        <div class="card" style="margin-top:1rem;">
            <div class="card-header">
                <h2 class="card-title">Telegram Notifications</h2>
                <button class="preset-btn" onclick="testTelegram()" id="telegramTestBtn">Send Test</button>
            </div>
            <div style="padding:1rem 1.25rem;">
                <div id="telegramStatus" style="font-size:0.8125rem;color:var(--gray-600);">Checking...</div>
                <p style="font-size:0.75rem;color:var(--gray-400);margin-top:0.5rem;">
                    Set <code>TELEGRAM_BOT_TOKEN</code> and <code>TELEGRAM_CHAT_ID</code> env vars in Railway to receive price drop alerts.
                    Adjust <code>TELEGRAM_MIN_DROP_PERCENT</code> (default: 5%) for sensitivity.
                </p>
            </div>
        </div>
    </div>

    <!-- Listings Panel -->
    <div class="panel" id="listings-panel">
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Listings</h2>
                <div class="filter-toolbar">
                    <div class="quick-search">
                        <input type="text" id="listingsSearch" placeholder="Search city, street, neighborhood..." oninput="onQuickSearch()">
                    </div>
                    <div id="listingsPresets"></div>
                    <button class="preset-btn" onclick="savePreset()">Save Filter</button>
                    <button class="btn-export" onclick="exportCSV()">&#8681; CSV</button>
                    <button class="preset-btn" id="compareBtn" onclick="showCompareModal()" style="display:none;">Compare (<span id="compareCnt">0</span>)</button>
                    <button class="preset-btn" onclick="clearAllFilters()">Clear All</button>
                </div>
            </div>
            <div class="active-filters-bar">
                <div class="active-filters" id="activeFiltersChips"></div>
                <div id="listingsFilterStats" style="padding:0 1.25rem;"></div>
            </div>
            <div class="table-container">
                <table id="listingsTable">
                    <thead>
                        <tr>
                            <th style="width:24px;" title="Compare"><input type="checkbox" disabled style="opacity:0.3;cursor:default;"></th>
                            <th style="width:30px;"></th>
                            <th style="width:28px;" title="Notes & Status">&#9998;</th>
                            <th style="width:48px;"></th>
                            <th>
                                <div class="th-content">
                                    <div class="th-label" onclick="sortListings('city')">City <span class="sort-icon" data-sort="city">&#9650;</span></div>
                                    <div class="multi-select" data-col="city" data-tbl="listings"></div>
                                </div>
                            </th>
                            <th>
                                <div class="th-content">
                                    <div class="th-label" onclick="sortListings('neighborhood')">Neighborhood <span class="sort-icon" data-sort="neighborhood">&#9650;</span></div>
                                    <div class="multi-select" data-col="neighborhood" data-tbl="listings"></div>
                                </div>
                            </th>
                            <th>
                                <div class="th-content">
                                    <div class="th-label" onclick="sortListings('street')">Street</div>
                                </div>
                            </th>
                            <th>
                                <div class="th-content">
                                    <div class="th-label" onclick="sortListings('rooms')">Rooms <span class="sort-icon" data-sort="rooms">&#9650;</span></div>
                                    <div class="multi-select" data-col="rooms" data-tbl="listings"></div>
                                </div>
                            </th>
                            <th>
                                <div class="th-content">
                                    <div class="th-label" onclick="sortListings('price_numeric')">Price <span class="sort-icon" data-sort="price_numeric">&#9650;</span></div>
                                    <div class="range-filter" data-col="price">
                                        <input type="number" placeholder="Min" data-range="min">
                                        <span style="color:var(--gray-400)">-</span>
                                        <input type="number" placeholder="Max" data-range="max">
                                    </div>
                                </div>
                            </th>
                            <th>
                                <div class="th-content">
                                    <div class="th-label" onclick="sortListings('size_sqm')">Sqm <span class="sort-icon" data-sort="size_sqm">&#9650;</span></div>
                                    <div class="multi-select" data-col="size_sqm" data-tbl="listings"></div>
                                </div>
                            </th>
                            <th>
                                <div class="th-content">
                                    <div class="th-label" onclick="sortListings('floor')">Floor <span class="sort-icon" data-sort="floor">&#9650;</span></div>
                                    <div class="multi-select" data-col="floor" data-tbl="listings"></div>
                                </div>
                            </th>
                            <th>
                                <div class="th-content">
                                    <div class="th-label" onclick="sortListings('price_per_sqm')">&#8362;/sqm <span class="sort-icon" data-sort="price_per_sqm">&#9650;</span></div>
                                </div>
                            </th>
                            <th>
                                <div class="th-content">
                                    <div class="th-label">Type</div>
                                    <div class="multi-select" data-col="is_merchant" data-tbl="listings"></div>
                                </div>
                            </th>
                            <th>
                                <div class="th-content">
                                    <div class="th-label" onclick="sortListings('first_seen_at')">Added <span class="sort-icon" data-sort="first_seen_at">&#9650;</span></div>
                                </div>
                            </th>
                            <th>Days</th>
                            <th>Link</th>
                        </tr>
                    </thead>
                    <tbody id="listingsBody"></tbody>
                </table>
            </div>
            <div class="pagination">
                <div class="pagination-info" id="listingsPaginationInfo"></div>
                <div style="display:flex;align-items:center;gap:0.75rem;">
                    <label style="font-size:0.75rem;color:var(--gray-500);">Per page:
                        <select class="page-size-select" onchange="changePageSize(this.value)">
                            <option value="25">25</option>
                            <option value="50" selected>50</option>
                            <option value="100">100</option>
                            <option value="200">200</option>
                        </select>
                    </label>
                    <div class="pagination-controls" id="listingsPagination"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Price Changes Panel -->
    <div class="panel" id="price-changes-panel">
        <div class="analytics-grid">
            <div class="kpi-card accent-primary">
                <div class="kpi-value" id="pcTotal">--</div>
                <div class="kpi-label">Total Changes (30d)</div>
            </div>
            <div class="kpi-card accent-success">
                <div class="kpi-value" id="pcDrops">--</div>
                <div class="kpi-label">Price Drops</div>
            </div>
            <div class="kpi-card accent-danger">
                <div class="kpi-value" id="pcRaises">--</div>
                <div class="kpi-label">Price Raises</div>
            </div>
            <div class="kpi-card accent-info">
                <div class="kpi-value" id="pcAvg">--</div>
                <div class="kpi-label">Avg Change</div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Price Changes</h2>
                <button class="preset-btn" onclick="clearPriceChangeFilters()">Clear Filters</button>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>
                                <div class="th-content">
                                    <div class="th-label">City</div>
                                    <div class="multi-select" data-col="city" data-tbl="priceChanges"></div>
                                </div>
                            </th>
                            <th>Neighborhood</th>
                            <th>Street</th>
                            <th>Rooms</th>
                            <th>Old Price</th>
                            <th>New Price</th>
                            <th>
                                <div class="th-content">
                                    <div class="th-label">Direction</div>
                                    <div class="multi-select" data-col="direction" data-tbl="priceChanges"></div>
                                </div>
                            </th>
                            <th>Change</th>
                            <th>Change %</th>
                            <th>Date</th>
                            <th>Link</th>
                        </tr>
                    </thead>
                    <tbody id="priceChangesBody"></tbody>
                </table>
            </div>
            <div class="pagination">
                <div class="pagination-info" id="priceChangesPaginationInfo"></div>
                <div class="pagination-controls" id="priceChangesPagination"></div>
            </div>
        </div>
    </div>

    <!-- Analytics Panel -->
    <div class="panel" id="analytics-panel">
        <div class="charts-row">
            <div class="chart-card">
                <div class="chart-card-header">Price Trends (30 days)</div>
                <div class="chart-card-body" id="priceTrendsChart" style="min-height:150px;">
                    <div class="loading"><div class="spinner"></div>Loading...</div>
                </div>
            </div>
            <div class="chart-card">
                <div class="chart-card-header">Daily Price Changes</div>
                <div class="chart-card-body" id="dailyChangesChart" style="min-height:150px;">
                    <div class="loading"><div class="spinner"></div>Loading...</div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Neighborhood Price Comparison</h2>
                <div class="filter-toolbar">
                    <select id="analyticsCityFilter" onchange="loadNeighborhoodAnalytics()" style="padding:0.375rem 0.625rem;border:1px solid var(--gray-200);border-radius:var(--radius-sm);font-size:0.8125rem;">
                        <option value="">All Cities</option>
                    </select>
                </div>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th style="cursor:pointer" onclick="sortAnalytics('city')">City</th>
                            <th style="cursor:pointer" onclick="sortAnalytics('neighborhood')">Neighborhood</th>
                            <th style="cursor:pointer" onclick="sortAnalytics('listings_count')">Listings</th>
                            <th style="cursor:pointer" onclick="sortAnalytics('avg_price')">Avg Price</th>
                            <th style="cursor:pointer" onclick="sortAnalytics('median_price')">Median</th>
                            <th style="cursor:pointer" onclick="sortAnalytics('min_price')">Min</th>
                            <th style="cursor:pointer" onclick="sortAnalytics('max_price')">Max</th>
                            <th style="cursor:pointer" onclick="sortAnalytics('avg_price_per_sqm')">Avg/sqm</th>
                            <th style="cursor:pointer" onclick="sortAnalytics('avg_rooms')">Avg Rooms</th>
                        </tr>
                    </thead>
                    <tbody id="analyticsBody"></tbody>
                </table>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Price Drop Leaderboard</h2>
                <span style="font-size:0.6875rem;color:var(--gray-400);">Neighborhoods with the most price drops (30 days)</span>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>City</th>
                            <th>Neighborhood</th>
                            <th>Drops</th>
                            <th>Listings</th>
                            <th>Avg Drop</th>
                            <th>Avg %</th>
                            <th>Biggest</th>
                        </tr>
                    </thead>
                    <tbody id="priceDropBody">
                        <tr><td colspan="7" class="empty-state"><div class="loading"><div class="spinner"></div>Loading...</div></td></tr>
                    </tbody>
                </table>
            </div>
            <div id="priceDropSummary" style="padding:0.75rem 1.25rem;font-size:0.6875rem;color:var(--gray-500);"></div>
        </div>

        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Compare Neighborhoods</h2>
            </div>
            <div style="padding:1rem 1.25rem;">
                <div style="display:flex;gap:1rem;margin-bottom:1rem;flex-wrap:wrap;">
                    <div style="flex:1;min-width:150px;">
                        <label style="font-size:0.6875rem;color:var(--gray-500);display:block;margin-bottom:0.25rem;">Neighborhood 1</label>
                        <input type="text" id="compareN1" list="neighborhoodList" placeholder="e.g. Florentin" style="width:100%;padding:0.5rem;border:1px solid var(--gray-200);border-radius:var(--radius-sm);font-size:0.8125rem;">
                    </div>
                    <div style="flex:1;min-width:150px;">
                        <label style="font-size:0.6875rem;color:var(--gray-500);display:block;margin-bottom:0.25rem;">Neighborhood 2</label>
                        <input type="text" id="compareN2" list="neighborhoodList" placeholder="e.g. Neve Tzedek" style="width:100%;padding:0.5rem;border:1px solid var(--gray-200);border-radius:var(--radius-sm);font-size:0.8125rem;">
                    </div>
                    <datalist id="neighborhoodList"></datalist>
                    <div style="display:flex;align-items:flex-end;">
                        <button class="btn btn-primary" onclick="compareNeighborhoods()">Compare</button>
                    </div>
                </div>
                <div id="compareResult"></div>
            </div>
        </div>
    </div>

    <!-- Deals Panel -->
    <div class="panel" id="deals-panel">
        <div class="analytics-grid">
            <div class="kpi-card accent-success">
                <div class="kpi-value" id="dealsCount">--</div>
                <div class="kpi-label">Deals Found</div>
            </div>
            <div class="kpi-card accent-primary">
                <div class="kpi-value" id="dealsAvgDiscount">--</div>
                <div class="kpi-label">Avg Discount</div>
            </div>
            <div class="kpi-card accent-info">
                <div class="kpi-value" id="dealsBestDiscount">--</div>
                <div class="kpi-label">Best Deal</div>
            </div>
        </div>

        <div class="charts-row">
            <div class="chart-card">
                <div class="chart-card-header">Price Distribution</div>
                <div class="chart-card-body" id="priceDistChart">
                    <div class="loading"><div class="spinner"></div>Loading...</div>
                </div>
            </div>
            <div class="chart-card">
                <div class="chart-card-header">Cheapest vs Expensive Neighborhoods</div>
                <div class="chart-card-body" id="neighborhoodCompareChart">
                    <div class="loading"><div class="spinner"></div>Loading...</div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Best Deals - Below Neighborhood Average</h2>
                <div class="filter-toolbar">
                    <select id="dealsCityFilter" onchange="loadDeals()" style="padding:0.375rem 0.625rem;border:1px solid var(--gray-200);border-radius:var(--radius-sm);font-size:0.8125rem;">
                        <option value="">All Cities</option>
                    </select>
                    <select id="dealsDiscountFilter" onchange="loadDeals()" style="padding:0.375rem 0.625rem;border:1px solid var(--gray-200);border-radius:var(--radius-sm);font-size:0.8125rem;">
                        <option value="10">10%+ below avg</option>
                        <option value="15" selected>15%+ below avg</option>
                        <option value="20">20%+ below avg</option>
                        <option value="25">25%+ below avg</option>
                    </select>
                </div>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th></th>
                            <th>City</th>
                            <th>Neighborhood</th>
                            <th>Street</th>
                            <th>Rooms</th>
                            <th>Price</th>
                            <th>Area Avg</th>
                            <th>Discount</th>
                            <th>Sqm</th>
                            <th>&#8362;/sqm</th>
                            <th>Type</th>
                            <th>Link</th>
                        </tr>
                    </thead>
                    <tbody id="dealsBody"></tbody>
                </table>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Stale Listings - Longest on Market</h2>
                <div class="filter-toolbar">
                    <select id="staleDaysFilter" onchange="loadStaleListings()" style="padding:0.375rem 0.625rem;border:1px solid var(--gray-200);border-radius:var(--radius-sm);font-size:0.8125rem;">
                        <option value="7">7+ days</option>
                        <option value="14" selected>14+ days</option>
                        <option value="30">30+ days</option>
                        <option value="60">60+ days</option>
                    </select>
                </div>
            </div>
            <div style="padding:0.5rem 1.25rem;">
                <span id="staleSummary" style="font-size:0.6875rem;color:var(--gray-500);"></span>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th></th>
                            <th>City</th>
                            <th>Neighborhood</th>
                            <th>Street</th>
                            <th>Rooms</th>
                            <th>Price</th>
                            <th>Sqm</th>
                            <th>Days</th>
                            <th>Type</th>
                            <th>Link</th>
                        </tr>
                    </thead>
                    <tbody id="staleBody"></tbody>
                </table>
            </div>
        </div>
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Possible Duplicates</h2>
                <div class="filter-toolbar">
                    <button class="btn btn-secondary" onclick="findDuplicates()">Scan for Duplicates</button>
                    <span id="dupeCount" style="font-size:0.6875rem;color:var(--gray-500);"></span>
                </div>
            </div>
            <div style="padding:0.5rem 1.25rem;">
                <span style="font-size:0.625rem;color:var(--gray-400);">Finds listings in the same location with matching rooms & similar size  may be the same apartment listed by different sources at different prices.</span>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Group</th>
                            <th>City</th>
                            <th>Neighborhood</th>
                            <th>Street</th>
                            <th>Rooms</th>
                            <th>Price</th>
                            <th>Sqm</th>
                            <th>Type</th>
                            <th>Days</th>
                            <th>Link</th>
                        </tr>
                    </thead>
                    <tbody id="dupesBody"><tr><td colspan="10" class="empty-state">Click "Scan for Duplicates" to analyze</td></tr></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Map Panel -->
    <div class="panel" id="map-panel">
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Price Map</h2>
                <div class="filter-toolbar">
                    <select id="mapCityFilter" onchange="loadMapData()" style="padding:0.375rem 0.625rem;border:1px solid var(--gray-200);border-radius:var(--radius-sm);font-size:0.8125rem;">
                        <option value="">All Cities</option>
                    </select>
                    <span style="font-size:0.625rem;color:var(--gray-400);">Dot size = price relative to area. Color: green=cheap, red=expensive</span>
                </div>
            </div>
            <div id="mapContainer" style="padding:1rem;min-height:400px;position:relative;">
                <div class="loading"><div class="spinner"></div>Loading map data...</div>
            </div>
            <div id="mapTooltip" style="display:none;position:fixed;background:var(--gray-900);color:white;padding:0.5rem 0.75rem;border-radius:var(--radius-sm);font-size:0.75rem;z-index:10000;pointer-events:none;max-width:250px;box-shadow:var(--shadow-lg);"></div>
        </div>
    </div>

    <!-- Alerts Panel -->
    <div class="panel" id="alerts-panel">
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Saved Searches</h2>
                <button class="btn btn-primary" onclick="showAddAlertForm()">+ New Alert</button>
            </div>
            <div id="addAlertForm" style="display:none;padding:1rem 1.25rem;border-bottom:1px solid var(--gray-100);">
                <div style="display:flex;gap:0.75rem;flex-wrap:wrap;align-items:flex-end;">
                    <div>
                        <label style="font-size:0.6875rem;color:var(--gray-500);display:block;margin-bottom:0.25rem;">City</label>
                        <input type="text" id="alertCity" placeholder="Any city" style="padding:0.375rem 0.5rem;border:1px solid var(--gray-200);border-radius:var(--radius-sm);font-size:0.8125rem;width:120px;">
                    </div>
                    <div>
                        <label style="font-size:0.6875rem;color:var(--gray-500);display:block;margin-bottom:0.25rem;">Max Price</label>
                        <input type="number" id="alertMaxPrice" placeholder="e.g. 5000" style="padding:0.375rem 0.5rem;border:1px solid var(--gray-200);border-radius:var(--radius-sm);font-size:0.8125rem;width:100px;">
                    </div>
                    <div>
                        <label style="font-size:0.6875rem;color:var(--gray-500);display:block;margin-bottom:0.25rem;">Min Rooms</label>
                        <input type="number" id="alertMinRooms" placeholder="e.g. 3" style="padding:0.375rem 0.5rem;border:1px solid var(--gray-200);border-radius:var(--radius-sm);font-size:0.8125rem;width:80px;">
                    </div>
                    <div>
                        <label style="font-size:0.6875rem;color:var(--gray-500);display:block;margin-bottom:0.25rem;">Neighborhood</label>
                        <input type="text" id="alertNeighborhood" list="neighborhoodList" placeholder="Any" style="padding:0.375rem 0.5rem;border:1px solid var(--gray-200);border-radius:var(--radius-sm);font-size:0.8125rem;width:120px;">
                    </div>
                    <button class="btn btn-primary" onclick="saveAlert()">Save</button>
                    <button class="btn btn-secondary" onclick="hideAddAlertForm()">Cancel</button>
                </div>
            </div>
            <div id="savedAlertsList" style="padding:1rem 1.25rem;"></div>
        </div>

        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Matching Listings</h2>
                <span class="badge badge-info" id="alertMatchCount">0 matches</span>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th></th>
                            <th>Alert</th>
                            <th>City</th>
                            <th>Neighborhood</th>
                            <th>Street</th>
                            <th>Rooms</th>
                            <th>Price</th>
                            <th>Sqm</th>
                            <th>Added</th>
                            <th>Link</th>
                        </tr>
                    </thead>
                    <tbody id="alertMatchesBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Favorites Panel -->
    <div class="panel" id="favorites-panel">
        <div id="favoritesStats" class="analytics-grid" style="margin-bottom:1rem;"></div>
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Bookmarked Listings</h2>
                <div style="display:flex;gap:0.5rem;align-items:center;flex-wrap:wrap;">
                    <select class="note-status-select" id="favSortSelect" onchange="renderFavorites()" style="font-size:0.6875rem;">
                        <option value="default">Sort: Default</option>
                        <option value="price_asc">Price: Low to High</option>
                        <option value="price_desc">Price: High to Low</option>
                        <option value="status">By Status</option>
                        <option value="newest">Newest First</option>
                    </select>
                    <button class="preset-btn" onclick="exportFavoritesWithNotes()">Export Notes</button>
                    <button class="preset-btn" onclick="clearFavorites()">Clear All</button>
                </div>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th></th>
                            <th>Status</th>
                            <th>City</th>
                            <th>Neighborhood</th>
                            <th>Street</th>
                            <th>Rooms</th>
                            <th>Price</th>
                            <th>Sqm</th>
                            <th>Price/sqm</th>
                            <th>Type</th>
                            <th>Notes</th>
                            <th>Added</th>
                            <th>Link</th>
                        </tr>
                    </thead>
                    <tbody id="favoritesBody"></tbody>
                </table>
            </div>
        </div>
        <div class="card" style="margin-top:1rem;">
            <div class="card-header">
                <h2 class="card-title">Recommended for You</h2>
                <button class="btn btn-secondary" onclick="findRecommendations()">Find Similar</button>
            </div>
            <div style="padding:0.5rem 1.25rem;">
                <span style="font-size:0.625rem;color:var(--gray-400);">Based on your favorites: finds listings in the same cities, similar rooms & price range that you haven't bookmarked yet.</span>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th></th>
                            <th>City</th>
                            <th>Neighborhood</th>
                            <th>Street</th>
                            <th>Rooms</th>
                            <th>Price</th>
                            <th>Sqm</th>
                            <th>Price/sqm</th>
                            <th>Type</th>
                            <th>Link</th>
                        </tr>
                    </thead>
                    <tbody id="recommendBody"><tr><td colspan="10" class="empty-state">Click "Find Similar" to get recommendations</td></tr></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Runs Panel -->
    <div class="panel" id="runs-panel">
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Scrape Run History</h2>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Type</th>
                            <th>Started</th>
                            <th>Duration</th>
                            <th>Pages</th>
                            <th>Listings</th>
                            <th>New</th>
                            <th>Updated</th>
                            <th>Price Chg</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="runsBody"></tbody>
                </table>
            </div>
        </div>
    </div>
</main>

<!-- Save Preset Modal -->
<div class="modal-overlay" id="presetModal">
    <div class="modal">
        <h3>Save Filter Preset</h3>
        <input type="text" id="presetName" placeholder="Preset name...">
        <div class="modal-actions">
            <button class="btn btn-secondary" onclick="closePresetModal()">Cancel</button>
            <button class="btn btn-primary" onclick="confirmSavePreset()">Save</button>
        </div>
    </div>
</div>

<!-- Listing Detail Modal -->
<div class="modal-overlay" id="detailModal" onclick="if(event.target===this)this.classList.remove('active')">
    <div class="modal" style="max-width:600px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;">
            <h3 id="detailTitle" style="margin:0;">Listing Details</h3>
            <button class="btn btn-secondary" onclick="document.getElementById('detailModal').classList.remove('active')" style="padding:0.25rem 0.5rem;">&#10005;</button>
        </div>
        <div id="detailContent" style="font-size:0.8125rem;line-height:1.8;"></div>
    </div>
</div>

<!-- Compare Modal -->
<div class="modal-overlay" id="compareModal" onclick="if(event.target===this)this.classList.remove('active')">
    <div class="modal" style="max-width:800px;max-height:90vh;overflow-y:auto;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;">
            <h3 style="margin:0;">Compare Listings</h3>
            <div style="display:flex;gap:0.5rem;">
                <button class="btn btn-secondary" onclick="clearCompare()" style="padding:0.25rem 0.5rem;font-size:0.6875rem;">Clear</button>
                <button class="btn btn-secondary" onclick="document.getElementById('compareModal').classList.remove('active')" style="padding:0.25rem 0.5rem;">&#10005;</button>
            </div>
        </div>
        <div id="compareContent"></div>
    </div>
</div>

<div class="toast" id="toast"></div>

<!-- Back to top button -->
<button id="backToTop" onclick="window.scrollTo({top:0,behavior:'smooth'})" style="
    position:fixed;bottom:2rem;left:2rem;width:40px;height:40px;
    border-radius:50%;background:var(--primary);color:white;border:none;
    box-shadow:var(--shadow-md);cursor:pointer;font-size:1.25rem;
    display:none;z-index:999;transition:opacity 0.3s,transform 0.3s;
    opacity:0.8;
" title="Back to top">&#8593;</button>

<script>
const API_BASE = location.hostname === 'localhost' || location.hostname === '127.0.0.1'
    ? 'http://localhost:8000' : location.origin;

const AUTO_REFRESH_MS = 60000;
const COLORS = ['#4f46e5','#0284c7','#059669','#d97706','#dc2626','#7c3aed','#db2777','#0891b2','#65a30d','#ea580c'];

const S = {
    listings: { data: [], allData: [], filters: {}, sort: { col: 'last_seen_at', ord: 'desc' }, page: 1, limit: 50 },
    priceChanges: { data: [], allData: [], filters: {}, page: 1, limit: 50 },
    runs: { data: [] },
    stats: {},
    presets: JSON.parse(localStorage.getItem('yad2_presets') || '[]'),
};

let openDD = null;
let refreshTimer = null;

// Dark mode
function toggleDarkMode() {
    const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
    document.documentElement.setAttribute('data-theme', isDark ? '' : 'dark');
    localStorage.setItem('yad2_theme', isDark ? 'light' : 'dark');
    document.getElementById('darkToggle').textContent = isDark ? 'Dark' : 'Light';
}

// Restore theme
if (localStorage.getItem('yad2_theme') === 'dark') {
    document.documentElement.setAttribute('data-theme', 'dark');
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('darkToggle').textContent = 'Light';
    });
}

//  INIT 

document.addEventListener('DOMContentLoaded', () => {
    try {
        initTabs();
        initRangeFilters();
        renderPresets();
        renderAlerts();
        document.getElementById('favoritesBadge').textContent = favorites.size;
    } catch (e) {
        console.error('Init error:', e);
    }
    loadAll();
    refreshTimer = setInterval(loadAll, AUTO_REFRESH_MS);
    startCountdown();
    document.addEventListener('click', e => {
        if (!e.target.closest('.multi-select')) closeAllDD();
    });

    // Back to top button visibility
    const btt = document.getElementById('backToTop');
    window.addEventListener('scroll', () => {
        btt.style.display = window.scrollY > 400 ? 'block' : 'none';
    });

    // Table scroll indicator
    document.querySelectorAll('.table-container').forEach(tc => {
        tc.addEventListener('scroll', () => {
            tc.classList.toggle('scrolled', tc.scrollLeft > 10);
        });
    });

    // Keyboard shortcuts for tab navigation
    document.addEventListener('keydown', e => {
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT' || e.target.tagName === 'TEXTAREA') return;
        const tabs = document.querySelectorAll('.tab');
        const num = parseInt(e.key);
        if (num >= 1 && num <= tabs.length) {
            tabs[num - 1].click();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        // Escape to close modals
        if (e.key === 'Escape') {
            document.getElementById('detailModal').classList.remove('active');
            document.getElementById('presetModal').classList.remove('active');
            document.getElementById('compareModal').classList.remove('active');
        }
        // 'r' to refresh
        if (e.key === 'r' && !e.ctrlKey && !e.metaKey) {
            loadAll();
            toast('Refreshing...');
        }
    });
});

function initTabs() {
    document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            tab.classList.add('active');
            document.getElementById(`${tab.dataset.tab}-panel`).classList.add('active');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });
    });
}

function initRangeFilters() {
    document.querySelectorAll('.range-filter input').forEach(input => {
        input.addEventListener('input', debounce(() => {
            const c = input.closest('.range-filter');
            S.listings.filters.price_min = parseInt(c.querySelector('[data-range="min"]').value) || null;
            S.listings.filters.price_max = parseInt(c.querySelector('[data-range="max"]').value) || null;
            S.listings.page = 1;
            filterAndRender('listings');
        }, 400));
    });
}

//  DATA LOADING 

async function api(endpoint, params = {}) {
    const url = `${API_BASE}${endpoint}?` + Object.entries(params)
        .filter(([k, v]) => v != null && v !== '')
        .map(([k, v]) => `${encodeURIComponent(k)}=${encodeURIComponent(v)}`)
        .join('&');
    const r = await fetch(url);
    if (!r.ok) throw new Error(`HTTP ${r.status} for ${endpoint}`);
    return r.json();
}

async function loadAll() {
    countdownSec = AUTO_REFRESH_MS / 1000;
    try {
        const results = await Promise.allSettled([loadStats(), loadListings(), loadPriceChanges(), loadRuns(), loadAnalyticsCities(), loadTelegramStatus(), loadDeals(), loadMarketSummary(), loadMapData(), loadStaleListings()]);
        const failed = results.filter(r => r.status === 'rejected');
        if (failed.length) {
            console.error('Load failures:', failed.map(f => f.reason));
            document.getElementById('lastUpdate').textContent = `Updated ${new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })} (${failed.length} error${failed.length > 1 ? 's' : ''})`;
        } else {
            document.getElementById('lastUpdate').textContent = `Updated ${new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })}`;
        }
    } catch (e) {
        console.error('loadAll error:', e);
        document.getElementById('lastUpdate').textContent = `Error: ${esc(e.message)}`;
    }
}

async function loadStats() {
    try {
        const s = await api('/stats');
        S.stats = s;
        document.getElementById('hkTotal').textContent = fmtN(s.active_listings);
        document.getElementById('hkCities').textContent = fmtN(s.cities);
        document.getElementById('hkAvgPrice').textContent = `\u20AA${fmtN(s.avg_price)}`;
        document.getElementById('hkChanges').textContent = fmtN(s.price_history?.changes_last_24h || 0);
        document.getElementById('overviewBadge').textContent = fmtN(s.active_listings);

        document.getElementById('kpiActive').textContent = fmtN(s.active_listings);
        document.getElementById('kpiTotal').textContent = fmtN(s.total_listings);
        document.getElementById('kpiAvg').textContent = `\u20AA${fmtN(s.avg_price)}`;
        document.getElementById('kpiMin').textContent = `\u20AA${fmtN(s.min_price)}`;
        document.getElementById('kpiMax').textContent = `\u20AA${fmtN(s.max_price)}`;
        document.getElementById('kpiCities').textContent = fmtN(s.cities);
        document.getElementById('kpiNeighborhoods').textContent = fmtN(s.neighborhoods);
        document.getElementById('kpiChanges7d').textContent = fmtN(s.price_history?.changes_last_7d || 0);

        renderTopCities(s.top_cities || []);
        renderRoomsChart(s.rooms_distribution || []);
    } catch (e) {
        console.error('Stats error:', e);
        document.getElementById('kpiActive').textContent = 'Error';
    }
}

async function loadListings() {
    try {
        const d = await api('/listings', { limit: 1000, active_only: true });
        S.listings.allData = d.listings;
        document.getElementById('listingsBadge').textContent = fmtN(d.total);
        buildFilters('listings');
        filterAndRender('listings');
        renderFavorites();
        renderAlerts();
    } catch (e) {
        document.getElementById('listingsBody').innerHTML = `<tr><td colspan="16" class="empty-state">Error: ${esc(e.message)}</td></tr>`;
    }
}

async function loadPriceChanges() {
    try {
        const d = await api('/price-changes', { limit: 500, days: 30 });
        S.priceChanges.allData = d.changes;
        document.getElementById('priceChangesBadge').textContent = fmtN(d.changes.length);

        const drops = d.changes.filter(c => c.price_diff < 0);
        const raises = d.changes.filter(c => c.price_diff > 0);
        const avg = d.changes.length ? Math.round(d.changes.reduce((s, c) => s + c.price_diff, 0) / d.changes.length) : 0;

        document.getElementById('pcTotal').textContent = fmtN(d.changes.length);
        document.getElementById('pcDrops').textContent = fmtN(drops.length);
        document.getElementById('pcRaises').textContent = fmtN(raises.length);
        document.getElementById('pcAvg').textContent = `\u20AA${fmtN(avg)}`;

        buildFilters('priceChanges');
        filterAndRender('priceChanges');
        renderLatestDrops(drops.slice(0, 8));
    } catch (e) {
        document.getElementById('priceChangesBody').innerHTML = `<tr><td colspan="11" class="empty-state">Error: ${esc(e.message)}</td></tr>`;
    }
}

async function loadRuns() {
    try {
        const d = await api('/runs', { limit: 50 });
        S.runs.data = d.runs;
        document.getElementById('runsBadge').textContent = fmtN(d.runs.length);
        renderRuns();
        renderScraperStatus(d.runs);
        renderRecentRuns(d.runs.slice(0, 8));
    } catch (e) {
        document.getElementById('runsBody').innerHTML = `<tr><td colspan="10" class="empty-state">Error: ${esc(e.message)}</td></tr>`;
    }
}

//  TELEGRAM 

async function loadTelegramStatus() {
    try {
        const d = await api('/telegram/status');
        const el = document.getElementById('telegramStatus');
        if (d.configured) {
            el.innerHTML = `<span class="badge badge-success">Configured</span> Min drop: ${d.min_drop_percent}%`;
            document.getElementById('telegramTestBtn').style.display = '';
        } else {
            el.innerHTML = '<span class="badge badge-warning">Not configured</span> Set env vars to enable';
            document.getElementById('telegramTestBtn').style.display = 'none';
        }
    } catch (e) {
        document.getElementById('telegramStatus').textContent = 'Could not check status';
    }
}

async function testTelegram() {
    try {
        const btn = document.getElementById('telegramTestBtn');
        btn.textContent = 'Sending...';
        btn.disabled = true;
        const r = await fetch(`${API_BASE}/telegram/test`, { method: 'POST' });
        const d = await r.json();
        if (d.success) {
            toast('Test message sent to Telegram!');
        } else {
            toast('Error: ' + (d.error || 'Unknown'));
        }
        btn.textContent = 'Send Test';
        btn.disabled = false;
    } catch (e) {
        toast('Failed to send test: ' + e.message);
        document.getElementById('telegramTestBtn').textContent = 'Send Test';
        document.getElementById('telegramTestBtn').disabled = false;
    }
}

//  ANALYTICS 

async function loadAnalyticsCities() {
    try {
        const d = await api('/cities');
        const sel = document.getElementById('analyticsCityFilter');
        sel.innerHTML = '<option value="">All Cities</option>' +
            d.cities.map(c => `<option value="${esc(c.city)}">${esc(c.city)} (${c.listings_count})</option>`).join('');
        await Promise.allSettled([loadNeighborhoodAnalytics(), loadPriceTrends(), loadPriceDropLeaderboard()]);
    } catch (e) {
        console.error('Analytics cities error:', e);
    }
}

async function loadPriceDropLeaderboard() {
    const tbody = document.getElementById('priceDropBody');
    try {
        const d = await api('/analytics/price-drops', { days: 30, min_drops: 2 });
        const summary = d.summary || {};
        document.getElementById('priceDropSummary').innerHTML =
            `Total: ${fmtN(summary.total_drops || 0)} drops vs ${fmtN(summary.total_raises || 0)} raises in last 30 days`;

        if (!d.neighborhoods.length) {
            tbody.innerHTML = '<tr><td colspan="7" class="empty-state">No neighborhoods with 2+ price drops</td></tr>';
            return;
        }

        tbody.innerHTML = d.neighborhoods.map(n => `
            <tr onclick="filterByCity('${esc(n.city || '')}')" style="cursor:pointer;">
                <td>${esc(n.city || '-')}</td>
                <td>${esc(n.neighborhood || '-')}</td>
                <td><strong>${n.drop_count}</strong></td>
                <td>${n.listings_affected}</td>
                <td class="price-down">&#8362;${fmtP(n.avg_drop_amount)}</td>
                <td class="price-down">${n.avg_drop_pct}%</td>
                <td class="price-down">&#8362;${fmtP(n.biggest_drop)}</td>
            </tr>
        `).join('');
    } catch (e) {
        tbody.innerHTML = `<tr><td colspan="7" class="empty-state">Error: ${esc(e.message)}</td></tr>`;
    }
}

async function loadPriceTrends() {
    try {
        const d = await api('/analytics/trends', { days: 30 });
        renderPriceTrends(d.trends || []);
        renderDailyChanges(d.trends || []);
    } catch (e) {
        document.getElementById('priceTrendsChart').innerHTML = '<div class="empty-state">Could not load trends</div>';
        document.getElementById('dailyChangesChart').innerHTML = '<div class="empty-state">Could not load trends</div>';
    }
}

function renderPriceTrends(trends) {
    const el = document.getElementById('priceTrendsChart');
    if (!trends.length) { el.innerHTML = '<div class="empty-state">No trend data yet</div>'; return; }

    const prices = trends.map(t => t.avg_price).filter(Boolean);
    if (!prices.length) { el.innerHTML = '<div class="empty-state">No price data</div>'; return; }
    const minP = Math.min(...prices);
    const maxP = Math.max(...prices);
    const range = maxP - minP || 1;
    const h = 120;

    const points = trends.map((t, i) => {
        const x = (i / (trends.length - 1 || 1)) * 100;
        const y = h - ((t.avg_price - minP) / range) * (h - 20) - 10;
        return `${x},${y}`;
    }).join(' ');

    el.innerHTML = `
        <div style="position:relative;">
            <svg viewBox="0 0 100 ${h}" preserveAspectRatio="none" style="width:100%;height:${h}px;">
                <polyline points="${points}" fill="none" stroke="var(--primary)" stroke-width="0.5" vector-effect="non-scaling-stroke"/>
                <polyline points="0,${h} ${points} 100,${h}" fill="url(#gradient)" opacity="0.15"/>
                <defs><linearGradient id="gradient" x1="0" y1="0" x2="0" y2="1">
                    <stop offset="0%" stop-color="var(--primary)"/><stop offset="100%" stop-color="transparent"/>
                </linearGradient></defs>
            </svg>
            <div style="display:flex;justify-content:space-between;font-size:0.625rem;color:var(--gray-400);margin-top:0.25rem;">
                <span>${trends[0]?.date ? new Date(trends[0].date).toLocaleDateString('en-GB',{day:'2-digit',month:'short'}) : ''}</span>
                <span>Avg: &#8362;${fmtN(Math.round(prices.reduce((a,b)=>a+b,0)/prices.length))}</span>
                <span>${trends[trends.length-1]?.date ? new Date(trends[trends.length-1].date).toLocaleDateString('en-GB',{day:'2-digit',month:'short'}) : ''}</span>
            </div>
        </div>
    `;
}

function renderDailyChanges(trends) {
    const el = document.getElementById('dailyChangesChart');
    if (!trends.length) { el.innerHTML = '<div class="empty-state">No data</div>'; return; }

    const maxChanges = Math.max(...trends.map(t => t.price_changes || 0)) || 1;
    const h = 120;
    const barW = Math.max(1, 90 / trends.length);

    el.innerHTML = `
        <svg viewBox="0 0 100 ${h}" preserveAspectRatio="none" style="width:100%;height:${h}px;">
            ${trends.map((t, i) => {
                const x = (i / trends.length) * 100;
                const barH = ((t.price_changes || 0) / maxChanges) * (h - 20);
                return `<rect x="${x}" y="${h - barH - 5}" width="${barW}" height="${barH}" fill="var(--primary)" opacity="0.6" rx="0.5"/>`;
            }).join('')}
        </svg>
        <div style="display:flex;justify-content:space-between;font-size:0.625rem;color:var(--gray-400);margin-top:0.25rem;">
            <span>${trends[0]?.date ? new Date(trends[0].date).toLocaleDateString('en-GB',{day:'2-digit',month:'short'}) : ''}</span>
            <span>Total: ${fmtN(trends.reduce((a,t)=>a+(t.price_changes||0),0))} changes</span>
            <span>${trends[trends.length-1]?.date ? new Date(trends[trends.length-1].date).toLocaleDateString('en-GB',{day:'2-digit',month:'short'}) : ''}</span>
        </div>
    `;
}

async function loadNeighborhoodAnalytics() {
    const city = document.getElementById('analyticsCityFilter').value;
    const tbody = document.getElementById('analyticsBody');
    tbody.innerHTML = '<tr><td colspan="9" class="empty-state"><div class="loading"><div class="spinner"></div>Loading...</div></td></tr>';

    try {
        const params = { min_listings: 3 };
        if (city) params.city = city;
        const d = await api('/analytics/neighborhoods', params);
        document.getElementById('analyticsBadge').textContent = fmtN(d.count);

        if (!d.neighborhoods.length) {
            tbody.innerHTML = '<tr><td colspan="9" class="empty-state">No data</td></tr>';
            analyticsData = [];
            return;
        }

        analyticsData = d.neighborhoods;
        renderAnalyticsBody();

        // Populate neighborhood autocomplete
        const datalist = document.getElementById('neighborhoodList');
        if (datalist) {
            datalist.innerHTML = d.neighborhoods.map(n =>
                `<option value="${esc(n.neighborhood)}">${esc(n.neighborhood)} - ${esc(n.city)} (${n.listings_count})</option>`
            ).join('');
        }
    } catch (e) {
        tbody.innerHTML = `<tr><td colspan="9" class="empty-state">Error: ${esc(e.message)}</td></tr>`;
    }
}

//  MULTI-SELECT FILTER SYSTEM 

function buildFilters(tbl) {
    document.querySelectorAll(`.multi-select[data-tbl="${tbl}"]`).forEach(container => {
        const col = container.dataset.col;
        const opts = getOptions(tbl, col);
        renderMS(container, opts, col, tbl);
    });
}

function getOptions(tbl, col) {
    const data = S[tbl].allData;
    const filters = S[tbl].filters;

    // Apply all OTHER filters to get cascaded counts
    let filtered = data;
    Object.entries(filters).forEach(([fc, vals]) => {
        if (fc === col || fc === 'price_min' || fc === 'price_max' || !vals?.length) return;
        filtered = filtered.filter(item => {
            if (fc === 'is_merchant') return vals.includes(String(item.is_merchant));
            if (fc === 'direction') {
                return (vals.includes('down') && item.price_diff < 0) || (vals.includes('up') && item.price_diff > 0);
            }
            return vals.includes(String(item[fc] || ''));
        });
    });

    if (col === 'is_merchant') {
        return [
            { value: 'true', label: 'Agent', count: filtered.filter(d => d.is_merchant).length },
            { value: 'false', label: 'Private', count: filtered.filter(d => !d.is_merchant).length },
        ];
    }
    if (col === 'direction') {
        return [
            { value: 'down', label: 'Drop', count: filtered.filter(d => d.price_diff < 0).length },
            { value: 'up', label: 'Raise', count: filtered.filter(d => d.price_diff > 0).length },
        ];
    }

    const counts = {};
    filtered.forEach(item => {
        const v = String(item[col] || '');
        if (v) counts[v] = (counts[v] || 0) + 1;
    });

    return Object.entries(counts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 150)
        .map(([value, count]) => ({ value, label: value, count }));
}

function renderMS(container, options, col, tbl) {
    const sel = S[tbl].filters[col] || [];
    const id = `dd-${tbl}-${col}`;

    container.innerHTML = `
        <div class="ms-trigger ${sel.length ? 'has-selection' : ''}" onclick="toggleDD(event,'${id}')">
            <span>${sel.length ? sel.length + ' selected' : 'All'}</span>
            ${sel.length ? `<span class="ms-count">${sel.length}</span>` : ''}
            <span class="ms-arrow">&#9660;</span>
        </div>
        <div class="ms-dropdown" id="${id}">
            <div class="ms-search">
                <input type="text" placeholder="Search..." oninput="searchDD(this)">
            </div>
            <div class="ms-actions">
                <button onclick="msAll('${tbl}','${col}','${id}')">Select All</button>
                <button onclick="msNone('${tbl}','${col}','${id}')">Clear</button>
            </div>
            <div class="ms-options">
                ${options.map(o => `
                    <label class="ms-option" data-v="${o.value}">
                        <input type="checkbox" value="${o.value}" ${sel.includes(o.value) ? 'checked' : ''}
                            onchange="msChange('${tbl}','${col}','${o.value}',this.checked)">
                        <span class="ms-option-label">${o.label}</span>
                        <span class="ms-option-count">${o.count}</span>
                    </label>
                `).join('')}
            </div>
        </div>
    `;
}

function toggleDD(e, id) {
    e.stopPropagation();
    const dd = document.getElementById(id);
    const trigger = dd.previousElementSibling;

    if (openDD && openDD !== dd) {
        openDD.classList.remove('open');
        openDD.previousElementSibling.classList.remove('open');
    }

    dd.classList.toggle('open');
    trigger.classList.toggle('open');
    openDD = dd.classList.contains('open') ? dd : null;

    if (openDD) {
        const input = dd.querySelector('.ms-search input');
        if (input) setTimeout(() => input.focus(), 50);
    }
}

function closeAllDD() {
    document.querySelectorAll('.ms-dropdown.open').forEach(d => {
        d.classList.remove('open');
        d.previousElementSibling.classList.remove('open');
    });
    openDD = null;
}

function searchDD(input) {
    const q = input.value.toLowerCase();
    input.closest('.ms-dropdown').querySelectorAll('.ms-option').forEach(o => {
        o.style.display = o.textContent.toLowerCase().includes(q) ? '' : 'none';
    });
}

function msAll(tbl, col, id) {
    const dd = document.getElementById(id);
    const visible = dd.querySelectorAll('.ms-option:not([style*="display: none"]) input');
    const vals = Array.from(visible).map(cb => { cb.checked = true; return cb.value; });
    S[tbl].filters[col] = vals;
    S[tbl].page = 1;
    buildFilters(tbl);
    filterAndRender(tbl);
}

function msNone(tbl, col) {
    S[tbl].filters[col] = [];
    S[tbl].page = 1;
    buildFilters(tbl);
    filterAndRender(tbl);
}

function msChange(tbl, col, val, checked) {
    if (!S[tbl].filters[col]) S[tbl].filters[col] = [];
    if (checked) {
        if (!S[tbl].filters[col].includes(val)) S[tbl].filters[col].push(val);
    } else {
        S[tbl].filters[col] = S[tbl].filters[col].filter(v => v !== val);
    }
    S[tbl].page = 1;
    // Rebuild ALL filter dropdowns for this table (cascading)
    buildFilters(tbl);
    filterAndRender(tbl);
}

//  FILTERING & RENDERING 

function filterAndRender(tbl) {
    if (tbl === 'listings') filterListings();
    else if (tbl === 'priceChanges') filterPriceChanges();
}

function filterListings() {
    const f = S.listings.filters;
    let data = S.listings.allData;

    // Quick search
    const q = (document.getElementById('listingsSearch')?.value || '').trim().toLowerCase();
    if (q) {
        data = data.filter(i =>
            (i.city || '').toLowerCase().includes(q) ||
            (i.neighborhood || '').toLowerCase().includes(q) ||
            (i.street || '').toLowerCase().includes(q)
        );
    }

    Object.entries(f).forEach(([col, vals]) => {
        if (col === 'price_min' || col === 'price_max' || !vals?.length) return;
        if (col === 'is_merchant') {
            data = data.filter(i => vals.includes(String(i.is_merchant)));
        } else {
            data = data.filter(i => vals.includes(String(i[col] || '')));
        }
    });

    if (f.price_min) data = data.filter(i => i.price_numeric >= f.price_min);
    if (f.price_max) data = data.filter(i => i.price_numeric <= f.price_max);

    // Compute price_per_sqm for sorting
    data.forEach(i => { const sqm = parseInt(i.size_sqm); i.price_per_sqm = (i.price_numeric && sqm > 0) ? Math.round(i.price_numeric / sqm) : 0; });

    // Sort
    const { col, ord } = S.listings.sort;
    data.sort((a, b) => {
        let av = a[col], bv = b[col];
        if (av == null) av = '';
        if (bv == null) bv = '';
        if (typeof av === 'string') { av = av.toLowerCase(); bv = (bv || '').toLowerCase(); }
        if (av < bv) return ord === 'asc' ? -1 : 1;
        if (av > bv) return ord === 'asc' ? 1 : -1;
        return 0;
    });

    S.listings.data = data;

    const start = (S.listings.page - 1) * S.listings.limit;
    const page = data.slice(start, start + S.listings.limit);

    renderListingsTable(page);
    renderPagination('listings', data.length);
    renderActiveChips();
    updateSortIcons();
    renderFilterStats(data);
}

function renderListingsTable(listings) {
    const tbody = document.getElementById('listingsBody');
    if (!listings.length) {
        tbody.innerHTML = '<tr><td colspan="16" class="empty-state">No listings found</td></tr>';
        return;
    }

    tbody.innerHTML = listings.map((l, idx) => {
        const sqm = parseInt(l.size_sqm);
        const ppsqm = (l.price_numeric && sqm > 0) ? Math.round(l.price_numeric / sqm) : null;
        const isFav = favorites.has(l.id);
        const img = l.image_url ? `<img class="listing-thumb" src="${l.image_url}" alt="" loading="lazy" onerror="this.style.display='none'">` : '';
        const isNew24h = l.first_seen_at && (Date.now() - new Date(l.first_seen_at).getTime()) < 86400000;
        const noteData = getNote(l.id);
        const statusHtml = noteData && noteData.status ? getStatusBadge(noteData.status) : '';
        const noteInd = noteData && (noteData.note || noteData.status) ? 'has-note' : '';
        return `
        <tr style="cursor:pointer" class="${isNew24h ? 'listing-new' : ''}" onclick="showListingDetail(${(S.listings.page-1)*S.listings.limit + idx})">
            <td><input type="checkbox" class="compare-check" data-id="${l.id}" ${compareSet.has(l.id) ? 'checked' : ''} onclick="toggleCompare(event,'${l.id}')"></td>
            <td><span class="fav-star ${isFav ? 'active' : ''}" data-id="${l.id}" onclick="toggleFavorite(event,'${l.id}')">&#9733;</span></td>
            <td><span class="note-indicator ${noteInd}" title="${noteData?.note ? esc(noteData.note) : 'Add note'}">&#9998;</span>${statusHtml}</td>
            <td>${img}</td>
            <td>${isNew24h ? '<span class="new-badge">NEW</span>' : ''}${l.city ? `<a href="#" onclick="event.preventDefault();event.stopPropagation();quickFilterCity('${esc(l.city)}')" style="text-decoration:none;color:inherit;" title="Filter by city">${esc(l.city)}</a>` : '-'}</td>
            <td>${l.neighborhood ? `<a href="#" onclick="event.preventDefault();event.stopPropagation();quickFilterNeighborhood('${esc(l.neighborhood)}')" style="text-decoration:none;color:inherit;" title="Filter by neighborhood">${esc(l.neighborhood)}</a>` : '-'}</td>
            <td>${l.street || '-'}</td>
            <td>${l.rooms || '-'}</td>
            <td><strong>&#8362;${fmtP(l.price_numeric)}</strong></td>
            <td>${l.size_sqm || '-'}</td>
            <td>${l.floor || '-'}</td>
            <td class="price-sqm">${ppsqm ? '&#8362;' + fmtN(ppsqm) : '-'}</td>
            <td>${l.is_merchant ? '<span class="badge badge-warning">Agent</span>' : '<span class="badge badge-success">Private</span>'}</td>
            <td>${fmtD(l.first_seen_at)}</td>
            <td>${daysAgo(l.first_seen_at)}</td>
            <td><a href="https://www.yad2.co.il/item/${l.link_token || l.id}" target="_blank" onclick="event.stopPropagation()">View</a></td>
        </tr>`;
    }).join('');
}

function filterPriceChanges() {
    const f = S.priceChanges.filters;
    let data = S.priceChanges.allData;

    Object.entries(f).forEach(([col, vals]) => {
        if (!vals?.length) return;
        if (col === 'direction') {
            data = data.filter(i => (vals.includes('down') && i.price_diff < 0) || (vals.includes('up') && i.price_diff > 0));
        } else {
            data = data.filter(i => vals.includes(String(i[col] || '')));
        }
    });

    S.priceChanges.data = data;

    const start = (S.priceChanges.page - 1) * S.priceChanges.limit;
    const page = data.slice(start, start + S.priceChanges.limit);

    renderPriceChangesTable(page);
    renderPagination('priceChanges', data.length);
}

function renderPriceChangesTable(changes) {
    const tbody = document.getElementById('priceChangesBody');
    if (!changes.length) {
        tbody.innerHTML = '<tr><td colspan="11" class="empty-state">No price changes found</td></tr>';
        return;
    }

    tbody.innerHTML = changes.map(c => {
        const down = c.price_diff < 0;
        const cls = down ? 'price-down' : 'price-up';
        const arrow = down ? '&#9660;' : '&#9650;';
        return `
            <tr>
                <td>${esc(c.city || '-')}</td>
                <td>${esc(c.neighborhood || '-')}</td>
                <td>${esc(c.street || '-')}</td>
                <td>${c.rooms || '-'}</td>
                <td>&#8362;${fmtP(c.previous_price)}</td>
                <td><strong>&#8362;${fmtP(c.price_numeric)}</strong></td>
                <td><span class="${cls}">${arrow}</span></td>
                <td class="${cls}">&#8362;${fmtP(Math.abs(c.price_diff))}</td>
                <td class="${cls}">${c.price_diff_percent}%</td>
                <td>${fmtDT(c.recorded_at)}</td>
                <td><a href="https://www.yad2.co.il/item/${c.link_token || c.listing_id}" target="_blank">View</a></td>
            </tr>
        `;
    }).join('');
}

function renderRuns() {
    const tbody = document.getElementById('runsBody');
    const runs = S.runs.data;

    if (!runs.length) {
        tbody.innerHTML = '<tr><td colspan="10" class="empty-state">No runs yet</td></tr>';
        return;
    }

    tbody.innerHTML = runs.map(r => {
        const dur = r.finished_at && r.started_at ? fmtDur(new Date(r.finished_at) - new Date(r.started_at)) : (r.status === 'running' ? 'Running...' : '-');
        const statusCls = r.status === 'completed' ? 'success' : r.status === 'running' ? 'info' : 'danger';
        const type = r.run_type || 'full';
        const typeBadge = type === 'smart' ? '<span class="badge badge-info">Smart</span>' : '<span class="badge badge-neutral">Full</span>';

        return `
            <tr>
                <td>${r.id}</td>
                <td>${typeBadge}</td>
                <td>${fmtDT(r.started_at)}</td>
                <td>${dur}</td>
                <td>${r.pages_scraped || 0}/${r.total_pages || 0}</td>
                <td>${fmtN(r.listings_found || 0)}</td>
                <td>${fmtN(r.listings_new || 0)}</td>
                <td>${fmtN(r.listings_updated || 0)}</td>
                <td>${fmtN(r.price_changes || 0)}</td>
                <td><span class="badge badge-${statusCls}">${r.status}</span></td>
            </tr>
        `;
    }).join('');
}

//  CHARTS 

function renderTopCities(cities) {
    const el = document.getElementById('topCitiesChart');
    if (!cities.length) { el.innerHTML = '<div class="empty-state">No data</div>'; return; }
    const max = cities[0].count;
    el.innerHTML = `<div class="bar-chart">${cities.slice(0, 10).map((c, i) => `
        <div class="bar-row" style="cursor:pointer" onclick="showCityDetail('${esc(c.city)}')">
            <div class="bar-label" title="${esc(c.city)}">${esc(c.city)}</div>
            <div class="bar-track">
                <div class="bar-fill" style="width:${(c.count / max * 100).toFixed(1)}%;background:${COLORS[i % COLORS.length]}">
                    <span>${c.count}</span>
                </div>
            </div>
        </div>
    `).join('')}</div>`;
}

function renderRoomsChart(rooms) {
    const el = document.getElementById('roomsChart');
    if (!rooms.length) { el.innerHTML = '<div class="empty-state">No data</div>'; return; }
    const max = Math.max(...rooms.map(r => r.count));
    el.innerHTML = `<div class="bar-chart">${rooms.filter(r => r.rooms).slice(0, 10).map((r, i) => `
        <div class="bar-row">
            <div class="bar-label">${r.rooms} rooms</div>
            <div class="bar-track">
                <div class="bar-fill" style="width:${(r.count / max * 100).toFixed(1)}%;background:${COLORS[i % COLORS.length]}">
                    <span>${r.count}</span>
                </div>
            </div>
        </div>
    `).join('')}</div>`;
}

function renderScraperStatus(runs) {
    const el = document.getElementById('scraperStatusContainer');
    const latest = runs[0];
    if (!latest) { el.innerHTML = ''; return; }

    const isRunning = latest.status === 'running';
    const pct = latest.total_pages ? Math.round((latest.pages_scraped || 0) / latest.total_pages * 100) : 0;
    const type = latest.run_type || 'full';
    let eta = '';
    if (isRunning && latest.started_at && latest.pages_scraped > 0 && latest.total_pages) {
        const elapsed = Date.now() - new Date(latest.started_at).getTime();
        const rate = elapsed / latest.pages_scraped;
        const remaining = (latest.total_pages - latest.pages_scraped) * rate;
        eta = ` | ETA: ${fmtDur(remaining)}`;
    }

    el.innerHTML = `
        <div class="scraper-status">
            <div class="scraper-status-icon ${isRunning ? 'running' : 'idle'}">${isRunning ? '&#9881;' : '&#10003;'}</div>
            <div class="scraper-status-text">
                <div class="scraper-status-title">${type === 'smart' ? '<span class="badge badge-info" style="font-size:0.5625rem;margin-left:0.375rem;">Smart</span>' : '<span class="badge badge-neutral" style="font-size:0.5625rem;margin-left:0.375rem;">Full</span>'} ${isRunning ? 'Scrape running...' : 'Last scrape completed'}</div>
                <div class="scraper-status-detail">
                    ${isRunning ? `Page ${latest.pages_scraped || 0}/${latest.total_pages || '?'} (${pct}%) | ${latest.listings_new || 0} new | ${latest.listings_updated || 0} updated | ${latest.price_changes || 0} price chg${eta}` :
                    `${fmtDT(latest.finished_at)} | ${latest.pages_scraped}/${latest.total_pages} pages | ${latest.listings_new || 0} new | ${latest.listings_updated || 0} updated | ${latest.price_changes || 0} price chg${latest.finished_at && latest.started_at ? ' | ' + fmtDur(new Date(latest.finished_at) - new Date(latest.started_at)) : ''}`}
                </div>
            </div>
            ${isRunning ? `<div class="scraper-status-progress"><div class="scraper-status-progress-fill" style="width:${pct}%"></div></div>` : ''}
        </div>
    `;
}

function renderRecentRuns(runs) {
    const el = document.getElementById('recentRunsChart');
    if (!runs.length) { el.innerHTML = '<div class="empty-state">No data</div>'; return; }

    el.innerHTML = `<div style="display:flex;flex-direction:column;gap:0.5rem;">${runs.map(r => {
        const dur = r.finished_at && r.started_at ? fmtDur(new Date(r.finished_at) - new Date(r.started_at)) : '-';
        const type = r.run_type || 'full';
        const statusColor = r.status === 'completed' ? 'var(--success)' : r.status === 'running' ? 'var(--info)' : 'var(--danger)';
        return `
            <div style="display:flex;align-items:center;gap:0.75rem;font-size:0.75rem;padding:0.375rem 0;border-bottom:1px solid var(--gray-100);">
                <span style="width:6px;height:6px;border-radius:50%;background:${statusColor};flex-shrink:0;"></span>
                <span style="color:var(--gray-500);width:30px;">#${r.id}</span>
                <span class="badge badge-${type === 'smart' ? 'info' : 'neutral'}" style="font-size:0.5625rem;">${type}</span>
                <span style="flex:1;color:var(--gray-600);">${r.pages_scraped || 0}p / ${fmtN(r.listings_new || 0)} new</span>
                <span style="color:var(--gray-400);">${dur}</span>
            </div>
        `;
    }).join('')}</div>`;
}

function renderLatestDrops(drops) {
    const el = document.getElementById('latestDropsChart');
    if (!drops.length) { el.innerHTML = '<div class="empty-state">No price drops</div>'; return; }

    el.innerHTML = `<div style="display:flex;flex-direction:column;gap:0.5rem;">${drops.map(d => `
        <div style="display:flex;align-items:center;gap:0.75rem;font-size:0.75rem;padding:0.375rem 0;border-bottom:1px solid var(--gray-100);">
            <span style="color:var(--success);font-weight:600;">&#9660;</span>
            <span style="flex:1;color:var(--gray-700);">${esc(d.city)}, ${esc(d.street || d.neighborhood || '')}</span>
            <span style="text-decoration:line-through;color:var(--gray-400);">&#8362;${fmtP(d.previous_price)}</span>
            <span style="font-weight:600;color:var(--success);">&#8362;${fmtP(d.price_numeric)}</span>
            <span style="color:var(--success);font-size:0.625rem;">${d.price_diff_percent}%</span>
        </div>
    `).join('')}</div>`;
}

//  DEALS & MARKET SUMMARY 

async function loadDeals() {
    const city = document.getElementById('dealsCityFilter')?.value || '';
    const discount = document.getElementById('dealsDiscountFilter')?.value || '15';
    const tbody = document.getElementById('dealsBody');
    tbody.innerHTML = '<tr><td colspan="12" class="empty-state"><div class="loading"><div class="spinner"></div>Loading...</div></td></tr>';

    try {
        const params = { min_discount: discount, limit: 100 };
        if (city) params.city = city;
        const d = await api('/analytics/deals', params);
        document.getElementById('dealsBadge').textContent = fmtN(d.count);
        document.getElementById('dealsCount').textContent = fmtN(d.count);

        if (d.deals.length) {
            const avgDisc = Math.round(d.deals.reduce((s, dl) => s + dl.discount_pct, 0) / d.deals.length);
            document.getElementById('dealsAvgDiscount').textContent = `${avgDisc}%`;
            document.getElementById('dealsBestDiscount').textContent = `${Math.round(d.deals[0].discount_pct)}%`;
        }

        if (!d.deals.length) {
            tbody.innerHTML = '<tr><td colspan="12" class="empty-state">No deals found. Try lowering the discount threshold.</td></tr>';
            return;
        }

        tbody.innerHTML = d.deals.map(dl => {
            const isFav = favorites.has(dl.id);
            return `
            <tr>
                <td><span class="fav-star ${isFav ? 'active' : ''}" data-id="${dl.id}" onclick="toggleFavorite(event,'${dl.id}')">&#9733;</span></td>
                <td>${esc(dl.city || '-')}</td>
                <td>${esc(dl.neighborhood || '-')}</td>
                <td>${esc(dl.street || '-')}</td>
                <td>${dl.rooms || '-'}</td>
                <td><strong style="color:var(--success)">&#8362;${fmtP(dl.price_numeric)}</strong></td>
                <td style="color:var(--gray-400);text-decoration:line-through;">&#8362;${fmtP(dl.area_avg)}</td>
                <td><span class="badge badge-success">-${Math.round(dl.discount_pct)}%</span></td>
                <td>${dl.size_sqm || '-'}</td>
                <td class="price-sqm">${dl.price_numeric && parseInt(dl.size_sqm) > 0 ? '&#8362;' + fmtN(Math.round(dl.price_numeric / parseInt(dl.size_sqm))) : '-'}</td>
                <td>${dl.is_merchant ? '<span class="badge badge-warning">Agent</span>' : '<span class="badge badge-success">Private</span>'}</td>
                <td><a href="https://www.yad2.co.il/item/${dl.link_token || dl.id}" target="_blank">View</a></td>
            </tr>`;
        }).join('');
    } catch (e) {
        tbody.innerHTML = `<tr><td colspan="12" class="empty-state">Error: ${esc(e.message)}</td></tr>`;
    }
}

async function loadMarketSummary() {
    try {
        const d = await api('/analytics/market-summary');
        const ov = d.overview || {};

        // Update overview KPIs
        document.getElementById('kpiNew24h').textContent = fmtN(ov.new_24h || 0);
        document.getElementById('kpiNew7d').textContent = fmtN(ov.new_7d || 0);

        // Populate deals city filter
        const sel = document.getElementById('dealsCityFilter');
        if (sel && sel.options.length <= 1) {
            try {
                const cities = await api('/cities');
                sel.innerHTML = '<option value="">All Cities</option>' +
                    cities.cities.map(c => `<option value="${esc(c.city)}">${esc(c.city)}</option>`).join('');
            } catch (e) {}
        }

        // Price distribution chart
        renderPriceDistribution(d.price_distribution || []);

        // Neighborhood comparison
        renderNeighborhoodCompare(d.cheapest_neighborhoods || [], d.most_expensive_neighborhoods || []);
    } catch (e) {
        console.error('Market summary error:', e);
    }
}

function renderPriceDistribution(dist) {
    const el = document.getElementById('priceDistChart');
    if (!dist.length) { el.innerHTML = '<div class="empty-state">No data</div>'; return; }
    const max = Math.max(...dist.map(d => d.count));
    el.innerHTML = `<div class="bar-chart">${dist.map((d, i) => `
        <div class="bar-row">
            <div class="bar-label">${d.bucket}</div>
            <div class="bar-track">
                <div class="bar-fill" style="width:${(d.count / max * 100).toFixed(1)}%;background:${COLORS[i % COLORS.length]}">
                    <span>${fmtN(d.count)}</span>
                </div>
            </div>
        </div>
    `).join('')}</div>`;
}

function renderNeighborhoodCompare(cheapest, expensive) {
    const el = document.getElementById('neighborhoodCompareChart');
    if (!cheapest.length && !expensive.length) { el.innerHTML = '<div class="empty-state">No data</div>'; return; }

    el.innerHTML = `
        <div style="display:flex;gap:1rem;">
            <div style="flex:1;">
                <div style="font-size:0.6875rem;font-weight:600;color:var(--success);margin-bottom:0.5rem;">Cheapest</div>
                ${cheapest.map(n => `
                    <div style="display:flex;justify-content:space-between;font-size:0.75rem;padding:0.25rem 0;border-bottom:1px solid var(--gray-100);">
                        <span style="color:var(--gray-600);">${esc(n.neighborhood)}, ${esc(n.city)}</span>
                        <span style="font-weight:600;color:var(--success);">&#8362;${fmtP(n.avg_price)}</span>
                    </div>
                `).join('')}
            </div>
            <div style="flex:1;">
                <div style="font-size:0.6875rem;font-weight:600;color:var(--danger);margin-bottom:0.5rem;">Most Expensive</div>
                ${expensive.map(n => `
                    <div style="display:flex;justify-content:space-between;font-size:0.75rem;padding:0.25rem 0;border-bottom:1px solid var(--gray-100);">
                        <span style="color:var(--gray-600);">${esc(n.neighborhood)}, ${esc(n.city)}</span>
                        <span style="font-weight:600;color:var(--danger);">&#8362;${fmtP(n.avg_price)}</span>
                    </div>
                `).join('')}
            </div>
        </div>
    `;
}

//  STALE LISTINGS 

async function loadStaleListings() {
    const minDays = document.getElementById('staleDaysFilter')?.value || '14';
    const tbody = document.getElementById('staleBody');
    tbody.innerHTML = '<tr><td colspan="10" class="empty-state"><div class="loading"><div class="spinner"></div>Loading...</div></td></tr>';

    try {
        const d = await api('/analytics/stale', { min_days: minDays, limit: 50 });
        const summary = d.summary || {};
        document.getElementById('staleSummary').innerHTML =
            `${fmtN(summary.total_stale || 0)} listings on market ${minDays}+ days | Avg ${summary.avg_days || 0} days | Avg price &#8362;${fmtP(summary.avg_price)}`;

        if (!d.listings.length) {
            tbody.innerHTML = '<tr><td colspan="10" class="empty-state">No stale listings found</td></tr>';
            return;
        }

        tbody.innerHTML = d.listings.map(l => {
            const isFav = favorites.has(l.id);
            const daysBadge = l.days_on_market > 60
                ? `<span class="badge badge-danger" title="Over 60 days">${l.days_on_market}d</span>`
                : l.days_on_market > 30
                ? `<span class="badge badge-warning" title="Over 30 days">${l.days_on_market}d</span>`
                : `<span class="badge badge-info">${l.days_on_market}d</span>`;
            return `
            <tr>
                <td><span class="fav-star ${isFav ? 'active' : ''}" data-id="${l.id}" onclick="toggleFavorite(event,'${l.id}')">&#9733;</span></td>
                <td>${esc(l.city || '-')}</td>
                <td>${esc(l.neighborhood || '-')}</td>
                <td>${esc(l.street || '-')}</td>
                <td>${l.rooms || '-'}</td>
                <td><strong>&#8362;${fmtP(l.price_numeric)}</strong></td>
                <td>${l.size_sqm || '-'}</td>
                <td>${daysBadge}</td>
                <td>${l.is_merchant ? '<span class="badge badge-warning">Agent</span>' : '<span class="badge badge-success">Private</span>'}</td>
                <td><a href="https://www.yad2.co.il/item/${l.link_token || l.id}" target="_blank">View</a></td>
            </tr>`;
        }).join('');
    } catch (e) {
        tbody.innerHTML = `<tr><td colspan="10" class="empty-state">Error: ${esc(e.message)}</td></tr>`;
    }
}

//  DUPLICATE DETECTOR 

function findDuplicates() {
    const data = S.listings.allData || [];
    if (!data.length) { toast('Load listings first'); return; }
    const tbody = document.getElementById('dupesBody');
    tbody.innerHTML = '<tr><td colspan="10" class="empty-state"><div class="loading"><div class="spinner"></div>Scanning...</div></td></tr>';

    const snapshot = [...data];
    setTimeout(() => {
        const groups = {};
        for (const l of snapshot) {
            if (!l.city || !l.rooms) continue;
            const key = `${(l.city||'').toLowerCase()}|${(l.neighborhood||'').toLowerCase()}|${l.rooms}`;
            if (!groups[key]) groups[key] = [];
            groups[key].push(l);
        }

        const dupes = [];
        let groupId = 0;
        for (const [key, items] of Object.entries(groups)) {
            if (items.length < 2) continue;
            // Within each group, find pairs with similar sqm (within 10%)
            const sqmGroups = [];
            const used = new Set();
            for (let i = 0; i < items.length; i++) {
                if (used.has(i)) continue;
                const sqmI = parseInt(items[i].size_sqm) || 0;
                if (!sqmI) continue;
                const cluster = [items[i]];
                used.add(i);
                for (let j = i + 1; j < items.length; j++) {
                    if (used.has(j)) continue;
                    const sqmJ = parseInt(items[j].size_sqm) || 0;
                    if (!sqmJ) continue;
                    if (Math.abs(sqmI - sqmJ) <= Math.max(sqmI, sqmJ) * 0.1) {
                        cluster.push(items[j]);
                        used.add(j);
                    }
                }
                if (cluster.length >= 2) sqmGroups.push(cluster);
            }
            for (const cluster of sqmGroups) {
                groupId++;
                // Sort by price asc so cheapest is first
                cluster.sort((a, b) => (a.price_numeric || 0) - (b.price_numeric || 0));
                for (const l of cluster) {
                    dupes.push({ ...l, _groupId: groupId, _groupSize: cluster.length });
                }
            }
        }

        const countEl = document.getElementById('dupeCount');
        countEl.textContent = `${dupes.length} listings in ${groupId} groups`;

        if (!dupes.length) {
            tbody.innerHTML = '<tr><td colspan="10" class="empty-state">No potential duplicates found</td></tr>';
            return;
        }

        // Show max 100 rows
        const show = dupes.slice(0, 100);
        const colors = ['var(--primary-bg)', 'var(--success-light)', 'var(--warning-light)', 'var(--info-light)', 'var(--danger-light)'];
        tbody.innerHTML = show.map(l => {
            const days = l.first_seen_at ? Math.floor((Date.now() - new Date(l.first_seen_at).getTime()) / 86400000) : '-';
            const bg = colors[(l._groupId - 1) % colors.length];
            return `
            <tr style="background:${bg};">
                <td><strong>#${l._groupId}</strong> <span style="font-size:0.625rem;color:var(--gray-400);">(${l._groupSize})</span></td>
                <td>${esc(l.city || '-')}</td>
                <td>${esc(l.neighborhood || '-')}</td>
                <td>${esc(l.street || '-')}</td>
                <td>${l.rooms || '-'}</td>
                <td><strong>&#8362;${fmtP(l.price_numeric)}</strong></td>
                <td>${l.size_sqm || '-'}</td>
                <td>${l.is_merchant ? '<span class="badge badge-warning">Agent</span>' : '<span class="badge badge-success">Private</span>'}</td>
                <td>${days}</td>
                <td><a href="https://www.yad2.co.il/item/${l.link_token || l.id}" target="_blank">View</a></td>
            </tr>`;
        }).join('');
    }, 50);
}

//  COMPARE NEIGHBORHOODS 

async function compareNeighborhoods() {
    const n1 = document.getElementById('compareN1').value.trim();
    const n2 = document.getElementById('compareN2').value.trim();
    const el = document.getElementById('compareResult');

    if (!n1 || !n2) { toast('Enter both neighborhood names'); return; }

    el.innerHTML = '<div class="loading"><div class="spinner"></div>Comparing...</div>';

    try {
        const d = await api('/analytics/compare', { n1, n2 });
        const a = d.n1 || {};
        const b = d.n2 || {};

        if (!a.listings_count && !b.listings_count) {
            el.innerHTML = '<div class="empty-state">No data found for either neighborhood</div>';
            return;
        }

        const rows = [
            ['City', a.city || '-', b.city || '-'],
            ['Listings', fmtN(a.listings_count || 0), fmtN(b.listings_count || 0)],
            ['Avg Price', `&#8362;${fmtP(a.avg_price)}`, `&#8362;${fmtP(b.avg_price)}`],
            ['Median Price', `&#8362;${fmtP(a.median_price)}`, `&#8362;${fmtP(b.median_price)}`],
            ['Min Price', `&#8362;${fmtP(a.min_price)}`, `&#8362;${fmtP(b.min_price)}`],
            ['Max Price', `&#8362;${fmtP(a.max_price)}`, `&#8362;${fmtP(b.max_price)}`],
            ['Avg/sqm', a.avg_price_per_sqm ? `&#8362;${fmtP(a.avg_price_per_sqm)}` : '-', b.avg_price_per_sqm ? `&#8362;${fmtP(b.avg_price_per_sqm)}` : '-'],
            ['Avg Rooms', a.avg_rooms || '-', b.avg_rooms || '-'],
            ['Avg Sqm', a.avg_sqm ? `${a.avg_sqm}` : '-', b.avg_sqm ? `${b.avg_sqm}` : '-'],
            ['Private', fmtN(a.private || 0), fmtN(b.private || 0)],
            ['Agents', fmtN(a.agents || 0), fmtN(b.agents || 0)],
        ];

        // Highlight cheaper option
        const winColor = 'var(--success)';
        const loseColor = 'var(--gray-400)';

        el.innerHTML = `
            <table style="font-size:0.8125rem;">
                <thead>
                    <tr>
                        <th style="text-align:right;">Metric</th>
                        <th style="text-align:center;color:var(--primary);font-weight:700;">${esc(a.neighborhood || n1)}</th>
                        <th style="text-align:center;color:var(--info);font-weight:700;">${esc(b.neighborhood || n2)}</th>
                    </tr>
                </thead>
                <tbody>
                    ${rows.map(([label, v1, v2]) => `
                        <tr>
                            <td style="font-weight:500;color:var(--gray-600);">${label}</td>
                            <td style="text-align:center;">${v1}</td>
                            <td style="text-align:center;">${v2}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
            <div style="margin-top:1rem;display:flex;gap:1rem;">
                <div style="flex:1;">
                    <div style="font-size:0.6875rem;font-weight:600;color:var(--primary);margin-bottom:0.375rem;">Room Distribution - ${a.neighborhood || n1}</div>
                    ${(d.n1_rooms || []).map(r => `<div style="display:flex;justify-content:space-between;font-size:0.75rem;padding:0.125rem 0;"><span>${r.rooms} rooms</span><span style="font-weight:500;">${r.count}</span></div>`).join('') || '<div class="empty-state">No data</div>'}
                </div>
                <div style="flex:1;">
                    <div style="font-size:0.6875rem;font-weight:600;color:var(--info);margin-bottom:0.375rem;">Room Distribution - ${b.neighborhood || n2}</div>
                    ${(d.n2_rooms || []).map(r => `<div style="display:flex;justify-content:space-between;font-size:0.75rem;padding:0.125rem 0;"><span>${r.rooms} rooms</span><span style="font-weight:500;">${r.count}</span></div>`).join('') || '<div class="empty-state">No data</div>'}
                </div>
            </div>
        `;
    } catch (e) {
        el.innerHTML = `<div class="empty-state">Error: ${esc(e.message)}</div>`;
    }
}

//  CITY DRILLDOWN 

async function showCityDetail(cityName) {
    const modal = document.getElementById('detailModal');
    document.getElementById('detailTitle').textContent = cityName;
    document.getElementById('detailContent').innerHTML = '<div class="loading"><div class="spinner"></div>Loading city stats...</div>';
    modal.classList.add('active');

    try {
        const d = await api(`/analytics/city/${encodeURIComponent(cityName)}`);
        const ov = d.overview || {};

        const neighborhoodBars = (d.neighborhoods || []).slice(0, 10).map((n, i) => {
            const max = d.neighborhoods[0].count;
            return `<div style="display:flex;align-items:center;gap:0.5rem;font-size:0.75rem;margin-bottom:0.25rem;">
                <span style="width:100px;text-align:right;color:var(--gray-600);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${n.neighborhood}">${n.neighborhood}</span>
                <div style="flex:1;height:18px;background:var(--gray-100);border-radius:3px;overflow:hidden;">
                    <div style="height:100%;width:${(n.count/max*100).toFixed(1)}%;background:${COLORS[i%COLORS.length]};border-radius:3px;display:flex;align-items:center;padding:0 0.375rem;">
                        <span style="font-size:0.5625rem;font-weight:600;color:white;">${n.count}</span>
                    </div>
                </div>
                <span style="font-size:0.625rem;color:var(--gray-400);width:60px;">&#8362;${fmtP(n.avg_price)}</span>
            </div>`;
        }).join('');

        const priceBars = (d.price_distribution || []).map((b, i) => {
            const max = Math.max(...d.price_distribution.map(x => x.count));
            return `<div style="display:flex;align-items:center;gap:0.5rem;font-size:0.75rem;margin-bottom:0.25rem;">
                <span style="width:45px;text-align:right;color:var(--gray-600);">${b.bucket}</span>
                <div style="flex:1;height:16px;background:var(--gray-100);border-radius:3px;overflow:hidden;">
                    <div style="height:100%;width:${(b.count/max*100).toFixed(1)}%;background:${COLORS[i%COLORS.length]};border-radius:3px;"></div>
                </div>
                <span style="font-size:0.625rem;color:var(--gray-400);width:35px;">${fmtN(b.count)}</span>
            </div>`;
        }).join('');

        document.getElementById('detailContent').innerHTML = `
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.5rem 1.5rem;margin-bottom:1rem;">
                <div><strong>Active:</strong> ${fmtN(ov.active_listings)}</div>
                <div><strong>Total Ever:</strong> ${fmtN(ov.total_listings)}</div>
                <div><strong>Avg Price:</strong> &#8362;${fmtP(ov.avg_price)}</div>
                <div><strong>Median:</strong> &#8362;${fmtP(ov.median_price)}</div>
                <div><strong>Min:</strong> &#8362;${fmtP(ov.min_price)}</div>
                <div><strong>Max:</strong> &#8362;${fmtP(ov.max_price)}</div>
                <div><strong>Avg Rooms:</strong> ${ov.avg_rooms || '-'}</div>
                <div><strong>Avg &#8362;/sqm:</strong> ${ov.avg_price_per_sqm ? '&#8362;' + fmtP(ov.avg_price_per_sqm) : '-'}</div>
                <div><strong>Private:</strong> ${fmtN(ov.private_listings)}</div>
                <div><strong>Agents:</strong> ${fmtN(ov.agent_listings)}</div>
                <div><strong>New 24h:</strong> ${fmtN(ov.new_24h)}</div>
                <div><strong>New 7d:</strong> ${fmtN(ov.new_7d)}</div>
                <div><strong>Neighborhoods:</strong> ${fmtN(ov.neighborhoods)}</div>
            </div>
            <div style="font-size:0.6875rem;font-weight:600;color:var(--gray-600);margin-bottom:0.375rem;">Top Neighborhoods</div>
            ${neighborhoodBars || '<div class="empty-state">No neighborhoods</div>'}
            <div style="font-size:0.6875rem;font-weight:600;color:var(--gray-600);margin:0.75rem 0 0.375rem;">Price Distribution</div>
            ${priceBars || '<div class="empty-state">No data</div>'}
            <div style="margin-top:1rem;display:flex;gap:0.5rem;">
                <button class="btn btn-primary" onclick="filterByCity('${esc(cityName)}')">View Listings</button>
            </div>
        `;
    } catch (e) {
        document.getElementById('detailContent').innerHTML = `<div class="empty-state">Error: ${esc(e.message)}</div>`;
    }
}

//  SORTING 

function sortListings(col) {
    if (S.listings.sort.col === col) {
        S.listings.sort.ord = S.listings.sort.ord === 'asc' ? 'desc' : 'asc';
    } else {
        S.listings.sort.col = col;
        S.listings.sort.ord = 'asc';
    }
    S.listings.page = 1;
    filterAndRender('listings');
}

function updateSortIcons() {
    document.querySelectorAll('.sort-icon').forEach(icon => {
        const col = icon.dataset.sort;
        if (col === S.listings.sort.col) {
            icon.classList.add('active');
            icon.innerHTML = S.listings.sort.ord === 'asc' ? '&#9650;' : '&#9660;';
        } else {
            icon.classList.remove('active');
            icon.innerHTML = '&#9650;';
        }
    });
}

//  ACTIVE FILTER CHIPS 

function renderActiveChips() {
    const el = document.getElementById('activeFiltersChips');
    const f = S.listings.filters;
    const chips = [];

    Object.entries(f).forEach(([col, vals]) => {
        if (col === 'price_min' && vals) chips.push({ label: `Min: ${fmtP(vals)}`, col, type: 'range' });
        else if (col === 'price_max' && vals) chips.push({ label: `Max: ${fmtP(vals)}`, col, type: 'range' });
        else if (vals?.length) {
            const display = vals.length <= 2 ? vals.join(', ') : `${vals.length} selected`;
            chips.push({ label: `${colName(col)}: ${display}`, col, type: 'multi' });
        }
    });

    if (!chips.length) { el.innerHTML = ''; return; }

    el.innerHTML = chips.map(c => `
        <span class="filter-chip">
            ${c.label}
            <span class="filter-chip-remove" onclick="removeFilter('${c.col}','${c.type}')">&#215;</span>
        </span>
    `).join('') + `<button class="clear-all-btn" onclick="clearAllFilters()">Clear all</button>`;
}

function renderFilterStats(data) {
    const el = document.getElementById('listingsFilterStats');
    if (!el) return;
    if (!data.length) { el.innerHTML = ''; return; }
    const prices = data.map(d => d.price_numeric).filter(Boolean);
    const avg = prices.length ? Math.round(prices.reduce((a,b)=>a+b,0)/prices.length) : 0;
    const min = prices.length ? Math.min(...prices) : 0;
    const max = prices.length ? Math.max(...prices) : 0;
    const cities = new Set(data.map(d => d.city).filter(Boolean)).size;
    const hasFilters = Object.values(S.listings.filters).some(v => v && (Array.isArray(v) ? v.length : v));
    const searchActive = !!document.getElementById('listingsSearch')?.value;
    const newCount = data.filter(d => d.first_seen_at && (Date.now() - new Date(d.first_seen_at).getTime()) < 86400000).length;
    const filterLabel = hasFilters || searchActive ? ' (filtered)' : '';
    el.innerHTML = `<span style="font-size:0.6875rem;color:var(--gray-500);">${fmtN(data.length)} listings${filterLabel} | ${cities} cities | Avg &#8362;${fmtP(avg)} | Range &#8362;${fmtP(min)}-&#8362;${fmtP(max)}${newCount ? ` | ${newCount} new today` : ''}</span>`;
}

function colName(col) {
    const map = { city: 'City', neighborhood: 'Neighborhood', rooms: 'Rooms', size_sqm: 'Sqm', floor: 'Floor', is_merchant: 'Type', street: 'Street' };
    return map[col] || col;
}

function removeFilter(col, type) {
    if (type === 'range') {
        S.listings.filters[col] = null;
        if (col === 'price_min') document.querySelector('.range-filter [data-range="min"]').value = '';
        if (col === 'price_max') document.querySelector('.range-filter [data-range="max"]').value = '';
    } else {
        S.listings.filters[col] = [];
    }
    S.listings.page = 1;
    buildFilters('listings');
    filterAndRender('listings');
}

function clearAllFilters() {
    S.listings.filters = {};
    S.listings.page = 1;
    document.querySelectorAll('.range-filter input').forEach(i => i.value = '');
    buildFilters('listings');
    filterAndRender('listings');
    toast('Filters cleared');
}

function clearPriceChangeFilters() {
    S.priceChanges.filters = {};
    S.priceChanges.page = 1;
    buildFilters('priceChanges');
    filterAndRender('priceChanges');
}

function filterByCity(city) {
    S.listings.filters = { city: [city] };
    S.listings.page = 1;
    document.querySelector('[data-tab="listings"]').click();
    buildFilters('listings');
    filterAndRender('listings');
}

function quickFilterCity(city) {
    S.listings.filters.city = [city];
    S.listings.page = 1;
    buildFilters('listings');
    filterAndRender('listings');
    toast(`Filtered: ${city}`);
}

function quickFilterNeighborhood(neighborhood) {
    S.listings.filters.neighborhood = [neighborhood];
    S.listings.page = 1;
    buildFilters('listings');
    filterAndRender('listings');
    toast(`Filtered: ${neighborhood}`);
}

//  PAGINATION 

function renderPagination(tbl, total) {
    const st = S[tbl];
    const totalPages = Math.ceil(total / st.limit);
    const info = document.getElementById(`${tbl}PaginationInfo`);
    const controls = document.getElementById(`${tbl}Pagination`);

    const start = Math.min((st.page - 1) * st.limit + 1, total);
    const end = Math.min(st.page * st.limit, total);
    info.textContent = total ? `${start}-${end} of ${fmtN(total)}` : 'No results';

    if (totalPages <= 1) { controls.innerHTML = ''; return; }

    const pages = pgNums(st.page, totalPages);
    controls.innerHTML =
        `<button class="page-btn" onclick="goPage('${tbl}',${st.page - 1})" ${st.page === 1 ? 'disabled' : ''}>&laquo;</button>` +
        pages.map(p => p === '...' ? '<span style="padding:0 0.375rem;color:var(--gray-400)">...</span>' :
            `<button class="page-btn ${p === st.page ? 'active' : ''}" onclick="goPage('${tbl}',${p})">${p}</button>`
        ).join('') +
        `<button class="page-btn" onclick="goPage('${tbl}',${st.page + 1})" ${st.page === totalPages ? 'disabled' : ''}>&raquo;</button>`;
}

function pgNums(cur, total) {
    if (total <= 7) return Array.from({ length: total }, (_, i) => i + 1);
    const p = [1];
    if (cur > 3) p.push('...');
    for (let i = Math.max(2, cur - 1); i <= Math.min(total - 1, cur + 1); i++) p.push(i);
    if (cur < total - 2) p.push('...');
    p.push(total);
    return p;
}

function goPage(tbl, page) {
    S[tbl].page = page;
    filterAndRender(tbl);
    document.querySelector(`#${tbl === 'priceChanges' ? 'price-changes' : tbl}-panel .table-container`)?.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

//  PRESETS 

function renderPresets() {
    const el = document.getElementById('listingsPresets');
    el.innerHTML = S.presets.map((p, i) => `
        <button class="preset-btn" onclick="applyPreset(${i})">
            ${esc(p.name)}
            <span onclick="event.stopPropagation();deletePreset(${i})" style="opacity:0.5;margin-right:4px;cursor:pointer;">&#215;</span>
        </button>
    `).join('');
}

function savePreset() {
    document.getElementById('presetModal').classList.add('active');
    document.getElementById('presetName').focus();
}

function closePresetModal() {
    document.getElementById('presetModal').classList.remove('active');
    document.getElementById('presetName').value = '';
}

function confirmSavePreset() {
    const name = document.getElementById('presetName').value.trim();
    if (!name) return;
    S.presets.push({ name, filters: JSON.parse(JSON.stringify(S.listings.filters)) });
    localStorage.setItem('yad2_presets', JSON.stringify(S.presets));
    closePresetModal();
    renderPresets();
    toast(`Preset "${name}" saved`);
}

function applyPreset(i) {
    const p = S.presets[i];
    if (!p) return;
    S.listings.filters = JSON.parse(JSON.stringify(p.filters));
    S.listings.page = 1;
    // Restore range inputs
    const min = S.listings.filters.price_min;
    const max = S.listings.filters.price_max;
    const minInput = document.querySelector('.range-filter [data-range="min"]');
    const maxInput = document.querySelector('.range-filter [data-range="max"]');
    if (minInput) minInput.value = min || '';
    if (maxInput) maxInput.value = max || '';
    buildFilters('listings');
    filterAndRender('listings');
    toast(`Preset "${p.name}" applied`);
}

function deletePreset(i) {
    S.presets.splice(i, 1);
    localStorage.setItem('yad2_presets', JSON.stringify(S.presets));
    renderPresets();
}

//  LISTING DETAIL MODAL 

function showListingDetail(idx) {
    const l = S.listings.data[idx];
    if (!l) return;

    const sqmVal = parseInt(l.size_sqm);
    const ppsqm = (l.price_numeric && sqmVal > 0) ? Math.round(l.price_numeric / sqmVal) : null;
    const link = `https://www.yad2.co.il/item/${l.link_token || l.id}`;
    const noteData = getNote(l.id);

    const amenities = l.amenities || {};
    const amenityTags = Object.entries(amenities)
        .filter(([k, v]) => v && v !== '' && v !== 'false' && v !== 'no')
        .map(([k]) => {
            const icons = { parking: 'P', elevator: 'E', ac: 'AC', mamad: 'M', storage: 'S' };
            const labels = { parking: 'Parking', elevator: 'Elevator', ac: 'A/C', mamad: 'Mamad', storage: 'Storage' };
            return `<span class="amenity-tag">${icons[k] || ''} ${labels[k] || k}</span>`;
        }).join('');
    const dom = l.first_seen_at ? Math.floor((Date.now() - new Date(l.first_seen_at).getTime()) / 86400000) : null;
    const domColor = dom === null ? 'var(--gray-400)' : dom <= 3 ? 'var(--success)' : dom <= 14 ? 'var(--warning)' : 'var(--danger)';
    const domLabel = dom === null ? '-' : dom === 0 ? 'Today' : dom === 1 ? '1 day' : `${dom} days`;
    const domPct = dom === null ? 0 : Math.min(dom / 60 * 100, 100);

    document.getElementById('detailTitle').textContent = `${l.street || l.neighborhood || 'Listing'}`;
    document.getElementById('detailContent').innerHTML = `
        ${l.image_url ? `<img class="detail-image" src="${l.image_url}" alt="Listing photo" onerror="this.style.display='none'">` : ''}
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.5rem 1.5rem;">
            <div><strong>City:</strong> ${l.city || '-'}</div>
            <div><strong>Neighborhood:</strong> ${l.neighborhood || '-'}</div>
            <div><strong>Street:</strong> ${l.street || '-'}</div>
            <div><strong>Property Type:</strong> ${l.property_type || '-'}</div>
            <div><strong>Rooms:</strong> ${l.rooms || '-'}</div>
            <div><strong>Floor:</strong> ${l.floor || '-'}</div>
            <div><strong>Size:</strong> ${l.size_sqm ? l.size_sqm + ' sqm' : '-'}</div>
            <div><strong>Price:</strong> <span style="font-size:1rem;font-weight:700;">&#8362;${fmtP(l.price_numeric)}</span></div>
            ${ppsqm ? `<div><strong>Price/sqm:</strong> &#8362;${fmtN(ppsqm)}</div>` : ''}
            <div><strong>Type:</strong> ${l.is_merchant ? 'Agent' : 'Private'}${l.merchant_name ? ' (' + esc(l.merchant_name) + ')' : ''}</div>
            <div><strong>Contact:</strong> ${esc(l.contact_name) || '-'}</div>
            <div><strong>Images:</strong> ${l.images_count || 0} photos</div>
            <div><strong>First Seen:</strong> ${fmtDT(l.first_seen_at)}</div>
            <div><strong>Last Seen:</strong> ${fmtDT(l.last_seen_at)}</div>
            <div><strong>Date Added:</strong> ${fmtDT(l.date_added)}</div>
        </div>
        ${dom !== null ? `<div style="margin-top:0.75rem;padding:0.625rem 0.75rem;background:var(--gray-50);border-radius:var(--radius-sm);border:1px solid var(--gray-200);">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.375rem;">
                <span style="font-size:0.75rem;font-weight:600;color:var(--gray-600);">Days on Market</span>
                <span style="font-size:0.875rem;font-weight:700;color:${domColor};">${domLabel}</span>
            </div>
            <div style="height:6px;background:var(--gray-200);border-radius:3px;overflow:hidden;">
                <div style="height:100%;width:${domPct}%;background:${domColor};border-radius:3px;transition:width 0.3s;"></div>
            </div>
            <div style="display:flex;justify-content:space-between;font-size:0.625rem;color:var(--gray-400);margin-top:0.25rem;">
                <span>New</span><span>2 weeks</span><span>1 month</span><span>2 months</span>
            </div>
        </div>` : ''}
        ${amenityTags ? `<div class="amenity-tags" style="margin-top:0.75rem;">${amenityTags}</div>` : ''}
        ${l.description_line ? `<div style="margin-top:0.75rem;padding:0.75rem;background:var(--gray-50);border-radius:var(--radius-sm);font-size:0.75rem;color:var(--gray-600);">${esc(l.description_line)}</div>` : ''}
        <div id="priceHistoryChart" style="margin-top:1rem;"></div>
        ${l.latitude && l.longitude ? `<div style="margin-top:0.75rem;font-size:0.6875rem;color:var(--gray-400);">Coordinates: ${l.latitude}, ${l.longitude}</div>` : ''}
        <div style="margin-top:1rem;padding:0.75rem;background:var(--gray-50);border-radius:var(--radius-sm);border:1px solid var(--gray-200);">
            <div style="font-size:0.75rem;font-weight:600;color:var(--gray-600);margin-bottom:0.5rem;">Notes & Status</div>
            <div style="display:flex;gap:0.5rem;align-items:center;margin-bottom:0.5rem;">
                <select class="note-status-select" id="noteStatus_${l.id}" onchange="updateListingNote('${l.id}')">
                    <option value="">No status</option>
                    <option value="called" ${noteData?.status === 'called' ? 'selected' : ''}>Called</option>
                    <option value="visited" ${noteData?.status === 'visited' ? 'selected' : ''}>Visited</option>
                    <option value="interested" ${noteData?.status === 'interested' ? 'selected' : ''}>Interested</option>
                    <option value="rejected" ${noteData?.status === 'rejected' ? 'selected' : ''}>Rejected</option>
                </select>
                ${noteData?.status ? getStatusBadge(noteData.status) : ''}
            </div>
            <textarea class="note-textarea" id="noteText_${l.id}" placeholder="Add private notes about this listing..." onblur="updateListingNote('${l.id}')">${noteData?.note ? esc(noteData.note) : ''}</textarea>
        </div>
        <div style="margin-top:1rem;display:flex;gap:0.5rem;flex-wrap:wrap;">
            <a href="${link}" target="_blank" class="btn btn-primary" style="text-decoration:none;">Open on Yad2</a>
            <button class="btn btn-secondary" onclick="navigator.clipboard.writeText('${link}');toast('Link copied!')">Copy Link</button>
            <button class="btn btn-secondary" onclick="shareListingWhatsApp(${(S.listings.page-1)*S.listings.limit + idx})" style="background:#25d366;color:white;border-color:#25d366;">WhatsApp</button>
            <button class="btn btn-secondary" onclick="copyListingSummary(${(S.listings.page-1)*S.listings.limit + idx})">Copy Summary</button>
        </div>
    `;
    document.getElementById('detailModal').classList.add('active');
    loadListingPriceHistory(l.id);
}

function buildListingSummary(idx) {
    const l = S.listings.data[idx];
    if (!l) return '';
    const sqm = parseInt(l.size_sqm);
    const ppsqm = (l.price_numeric && sqm > 0) ? Math.round(l.price_numeric / sqm) : null;
    const link = `https://www.yad2.co.il/item/${l.link_token || l.id}`;
    const lines = [
        `\u{1F3E0} ${l.street || ''} ${l.neighborhood || ''}, ${l.city || ''}`,
        `\u{1F4B0} \u20AA${fmtP(l.price_numeric)}${ppsqm ? ` (\u20AA${fmtN(ppsqm)}/sqm)` : ''}`,
        `\u{1F6CF} ${l.rooms || '?'} rooms | ${l.size_sqm || '?'} sqm | Floor ${l.floor || '?'}`,
        l.is_merchant ? `\u{1F464} Agent${l.merchant_name ? ': ' + l.merchant_name : ''}` : `\u{1F464} Private`,
        link
    ];
    return lines.filter(Boolean).join('\n');
}

function shareListingWhatsApp(idx) {
    const text = buildListingSummary(idx);
    if (!text) return;
    window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
}

function copyListingSummary(idx) {
    const text = buildListingSummary(idx);
    if (!text) return;
    navigator.clipboard.writeText(text);
    toast('Summary copied to clipboard');
}

async function loadListingPriceHistory(listingId) {
    const el = document.getElementById('priceHistoryChart');
    if (!el) return;
    el.innerHTML = '<div style="font-size:0.75rem;color:var(--gray-400);">Loading price history...</div>';

    try {
        const d = await api(`/listings/${encodeURIComponent(listingId)}/price-history`);
        const history = d.history || [];

        if (history.length < 2) {
            el.innerHTML = '<div style="font-size:0.75rem;color:var(--gray-400);">No price changes recorded</div>';
            return;
        }

        // Render price history timeline
        const prices = history.map(item => item.price_numeric).filter(Boolean);
        const minP = Math.min(...prices);
        const maxP = Math.max(...prices);
        const pRange = maxP - minP || 1;
        const chartH = 80;

        function priceToY(price) { return chartH - ((price - minP) / pRange) * 55 - 10; }

        const points = history.filter(item => item.price_numeric).map((item, i, arr) => ({
            x: (i / (arr.length - 1 || 1)) * 100,
            y: priceToY(item.price_numeric),
            price: item.price_numeric,
            date: item.recorded_at
        }));

        // Use step-style line for price changes
        let pathD = '';
        points.forEach((p, i) => {
            if (i === 0) {
                pathD += `M ${p.x},${p.y}`;
            } else {
                pathD += ` L ${points[i-1].x + (p.x - points[i-1].x) * 0.01},${points[i-1].y}`;
                pathD += ` L ${p.x},${p.y}`;
            }
        });

        el.innerHTML = `
            <div style="font-size:0.6875rem;font-weight:600;color:var(--gray-600);margin-bottom:0.375rem;">Price History (${d.price_changes} change${d.price_changes !== 1 ? 's' : ''})</div>
            <svg viewBox="0 0 100 ${chartH}" preserveAspectRatio="none" style="width:100%;height:${chartH}px;background:var(--gray-50);border-radius:4px;">
                <path d="${pathD}" fill="none" stroke="var(--primary)" stroke-width="0.5" vector-effect="non-scaling-stroke"/>
                ${points.map(p => `<circle cx="${p.x}" cy="${p.y}" r="1.5" fill="var(--primary)" vector-effect="non-scaling-stroke"/>`).join('')}
            </svg>
            <div style="display:flex;flex-direction:column;gap:0.25rem;margin-top:0.5rem;max-height:120px;overflow-y:auto;">
                ${history.map((h, i) => {
                    if (i === 0) return `<div style="font-size:0.6875rem;color:var(--gray-500);display:flex;justify-content:space-between;"><span>${fmtD(h.recorded_at)}</span><span>&#8362;${fmtP(h.price_numeric)} (initial)</span></div>`;
                    const prev = history[i-1].price_numeric;
                    const diff = h.price_numeric - prev;
                    const cls = diff < 0 ? 'price-down' : 'price-up';
                    const arrow = diff < 0 ? '&#9660;' : '&#9650;';
                    const pct = prev ? ((diff / prev) * 100).toFixed(1) : 0;
                    return `<div style="font-size:0.6875rem;display:flex;justify-content:space-between;"><span style="color:var(--gray-500);">${fmtD(h.recorded_at)}</span><span>&#8362;${fmtP(h.price_numeric)} <span class="${cls}">${arrow} ${fmtP(Math.abs(diff))} (${pct}%)</span></span></div>`;
                }).join('')}
            </div>
        `;
    } catch (e) {
        el.innerHTML = '<div style="font-size:0.75rem;color:var(--gray-400);">Could not load price history</div>';
    }
}

//  FAVORITES 

const favorites = new Set(JSON.parse(localStorage.getItem('yad2_favorites') || '[]'));

function saveFavorites() {
    localStorage.setItem('yad2_favorites', JSON.stringify([...favorites]));
    document.getElementById('favoritesBadge').textContent = favorites.size;
}

function toggleFavorite(e, id) {
    e.stopPropagation();
    if (favorites.has(id)) {
        favorites.delete(id);
    } else {
        favorites.add(id);
    }
    saveFavorites();
    // Update star in listings table
    document.querySelectorAll(`.fav-star[data-id="${id}"]`).forEach(s => {
        s.classList.toggle('active', favorites.has(id));
    });
    // Re-render favorites if on that tab
    renderFavorites();
}

function renderFavorites() {
    const tbody = document.getElementById('favoritesBody');
    const statsEl = document.getElementById('favoritesStats');
    if (!favorites.size) {
        tbody.innerHTML = '<tr><td colspan="13" class="empty-state">No bookmarked listings. Click the star on any listing to bookmark it.</td></tr>';
        statsEl.innerHTML = '';
        return;
    }

    let favListings = S.listings.allData.filter(l => favorites.has(l.id));
    if (!favListings.length) {
        tbody.innerHTML = '<tr><td colspan="13" class="empty-state">Bookmarked listings not loaded yet. Switch to Listings tab first.</td></tr>';
        statsEl.innerHTML = '';
        return;
    }

    // Sort favorites
    const sortVal = document.getElementById('favSortSelect')?.value || 'default';
    const statusOrder = { interested: 0, called: 1, visited: 2, rejected: 3 };
    if (sortVal === 'price_asc') favListings.sort((a, b) => (a.price_numeric || 0) - (b.price_numeric || 0));
    else if (sortVal === 'price_desc') favListings.sort((a, b) => (b.price_numeric || 0) - (a.price_numeric || 0));
    else if (sortVal === 'newest') favListings.sort((a, b) => new Date(b.first_seen_at || 0) - new Date(a.first_seen_at || 0));
    else if (sortVal === 'status') favListings.sort((a, b) => {
        const sa = getNote(a.id)?.status || 'zzz';
        const sb = getNote(b.id)?.status || 'zzz';
        return (statusOrder[sa] ?? 99) - (statusOrder[sb] ?? 99);
    });

    // Render quick stats
    const prices = favListings.map(l => l.price_numeric).filter(Boolean);
    const avgPrice = prices.length ? Math.round(prices.reduce((s, p) => s + p, 0) / prices.length) : 0;
    const minPrice = prices.length ? Math.min(...prices) : 0;
    const notesCount = favListings.filter(l => getNote(l.id)?.note || getNote(l.id)?.status).length;
    statsEl.innerHTML = `
        <div class="kpi-card accent-primary"><div class="kpi-value">${favListings.length}</div><div class="kpi-label">Bookmarked</div></div>
        <div class="kpi-card accent-success"><div class="kpi-value">\u20AA${fmtN(avgPrice)}</div><div class="kpi-label">Avg Price</div></div>
        <div class="kpi-card accent-info"><div class="kpi-value">\u20AA${fmtN(minPrice)}</div><div class="kpi-label">Cheapest</div></div>
        <div class="kpi-card accent-warning"><div class="kpi-value">${notesCount}</div><div class="kpi-label">With Notes</div></div>
    `;

    tbody.innerHTML = favListings.map(l => {
        const sqmVal = parseInt(l.size_sqm);
        const ppsqm = (l.price_numeric && sqmVal > 0) ? Math.round(l.price_numeric / sqmVal) : null;
        const noteData = getNote(l.id);
        return `
        <tr>
            <td><span class="fav-star active" data-id="${l.id}" onclick="toggleFavorite(event,'${l.id}')">&#9733;</span></td>
            <td>${noteData?.status ? getStatusBadge(noteData.status) : '<span style="color:var(--gray-300);font-size:0.6875rem;">-</span>'}</td>
            <td>${l.city || '-'}</td>
            <td>${l.neighborhood || '-'}</td>
            <td>${l.street || '-'}</td>
            <td>${l.rooms || '-'}</td>
            <td><strong>&#8362;${fmtP(l.price_numeric)}</strong></td>
            <td>${l.size_sqm || '-'}</td>
            <td class="price-sqm">${ppsqm ? '&#8362;' + fmtN(ppsqm) : '-'}</td>
            <td>${l.is_merchant ? '<span class="badge badge-warning">Agent</span>' : '<span class="badge badge-success">Private</span>'}</td>
            <td><span class="note-preview" title="${noteData?.note ? esc(noteData.note) : ''}">${noteData?.note ? esc(noteData.note) : '-'}</span></td>
            <td>${fmtD(l.first_seen_at)}</td>
            <td><a href="https://www.yad2.co.il/item/${l.link_token || l.id}" target="_blank">View</a></td>
        </tr>`;
    }).join('');
}

function exportFavoritesWithNotes() {
    const favListings = S.listings.allData.filter(l => favorites.has(l.id));
    if (!favListings.length) { toast('No favorites to export'); return; }
    const rows = [['City','Neighborhood','Street','Rooms','Price','Sqm','Type','Status','Notes','Link']];
    favListings.forEach(l => {
        const noteData = getNote(l.id);
        rows.push([
            l.city || '', l.neighborhood || '', l.street || '', l.rooms || '',
            l.price_numeric || '', l.size_sqm || '',
            l.is_merchant ? 'Agent' : 'Private',
            noteData?.status || '', (noteData?.note || '').replace(/"/g, '""'),
            'https://www.yad2.co.il/item/' + (l.link_token || l.id)
        ]);
    });
    const safeCsv = v => { const s = String(v); return /^[=+\-@\t\r]/.test(s) ? "'" + s : s; };
    const csv = rows.map(r => r.map(c => `"${safeCsv(c)}"`).join(',')).join('\n');
    const bom = '\uFEFF';
    const blob = new Blob([bom + csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `yad2-favorites-${new Date().toISOString().slice(0,10)}.csv`;
    a.click();
    URL.revokeObjectURL(url);
    toast('Favorites with notes exported');
}

function clearFavorites() {
    favorites.clear();
    saveFavorites();
    renderFavorites();
    toast('Favorites cleared');
}

function findRecommendations() {
    const favListings = S.listings.allData.filter(l => favorites.has(l.id));
    const tbody = document.getElementById('recommendBody');
    if (!favListings.length) { toast('Bookmark some listings first'); return; }

    // Build profile from favorites
    const favCities = new Set(favListings.map(l => l.city).filter(Boolean));
    const favRooms = favListings.map(l => parseFloat(l.rooms)).filter(r => !isNaN(r));
    const favPrices = favListings.map(l => l.price_numeric).filter(Boolean);
    if (!favPrices.length) { tbody.innerHTML = '<tr><td colspan="10" class="empty-state">Not enough data</td></tr>'; return; }

    const minRooms = Math.min(...favRooms) - 0.5;
    const maxRooms = Math.max(...favRooms) + 0.5;
    const avgPrice = favPrices.reduce((a, b) => a + b, 0) / favPrices.length;
    const priceRange = avgPrice * 0.3; // 30% tolerance

    const recs = S.listings.allData.filter(l => {
        if (favorites.has(l.id)) return false;
        if (!favCities.has(l.city)) return false;
        const rooms = parseFloat(l.rooms);
        if (isNaN(rooms) || rooms < minRooms || rooms > maxRooms) return false;
        if (!l.price_numeric) return false;
        if (Math.abs(l.price_numeric - avgPrice) > priceRange) return false;
        return true;
    }).sort((a, b) => (a.price_numeric || 0) - (b.price_numeric || 0)).slice(0, 30);

    if (!recs.length) {
        tbody.innerHTML = '<tr><td colspan="10" class="empty-state">No similar listings found outside your favorites</td></tr>';
        return;
    }

    tbody.innerHTML = recs.map(l => {
        const sqm = parseInt(l.size_sqm);
        const ppsqm = (l.price_numeric && sqm > 0) ? Math.round(l.price_numeric / sqm) : null;
        const isFav = favorites.has(l.id);
        return `
        <tr>
            <td><span class="fav-star ${isFav ? 'active' : ''}" data-id="${l.id}" onclick="toggleFavorite(event,'${l.id}');findRecommendations()">&#9733;</span></td>
            <td>${esc(l.city || '-')}</td>
            <td>${esc(l.neighborhood || '-')}</td>
            <td>${esc(l.street || '-')}</td>
            <td>${l.rooms || '-'}</td>
            <td><strong>&#8362;${fmtP(l.price_numeric)}</strong></td>
            <td>${l.size_sqm || '-'}</td>
            <td class="price-sqm">${ppsqm ? '&#8362;' + fmtN(ppsqm) : '-'}</td>
            <td>${l.is_merchant ? '<span class="badge badge-warning">Agent</span>' : '<span class="badge badge-success">Private</span>'}</td>
            <td><a href="https://www.yad2.co.il/item/${l.link_token || l.id}" target="_blank">View</a></td>
        </tr>`;
    }).join('');
    toast(`Found ${recs.length} similar listings`);
}

//  LISTING NOTES & STATUS 

const listingNotes = JSON.parse(localStorage.getItem('yad2_notes') || '{}');

function saveNotes() {
    localStorage.setItem('yad2_notes', JSON.stringify(listingNotes));
}

function getNote(id) {
    return listingNotes[id] || null;
}

function getStatusBadge(status) {
    if (!status) return '';
    const labels = { called: 'Called', visited: 'Visited', interested: 'Interested', rejected: 'Rejected' };
    return `<span class="status-pill status-${status}">${labels[status] || status}</span>`;
}

function updateListingNote(id) {
    const statusEl = document.getElementById('noteStatus_' + id);
    const textEl = document.getElementById('noteText_' + id);
    if (!statusEl || !textEl) return;
    const status = statusEl.value;
    const note = textEl.value.trim();
    if (!note && !status) {
        delete listingNotes[id];
    } else {
        listingNotes[id] = { note, status, updated: Date.now() };
    }
    saveNotes();
    renderFavorites();
}

function getNotesCount() {
    return Object.keys(listingNotes).filter(k => listingNotes[k].note || listingNotes[k].status).length;
}

//  LISTING COMPARE 

const compareSet = new Set();

function toggleCompare(e, id) {
    e.stopPropagation();
    if (compareSet.has(id)) {
        compareSet.delete(id);
    } else {
        if (compareSet.size >= 4) { toast('Max 4 listings to compare'); return; }
        compareSet.add(id);
    }
    updateCompareUI();
}

function updateCompareUI() {
    const btn = document.getElementById('compareBtn');
    document.getElementById('compareCnt').textContent = compareSet.size;
    btn.style.display = compareSet.size >= 2 ? '' : 'none';
    document.querySelectorAll('.compare-check').forEach(cb => {
        cb.checked = compareSet.has(cb.dataset.id);
    });
}

function clearCompare() {
    compareSet.clear();
    updateCompareUI();
    document.getElementById('compareModal').classList.remove('active');
}

function showCompareModal() {
    if (compareSet.size < 2) { toast('Select at least 2 listings to compare'); return; }
    const listings = S.listings.allData.filter(l => compareSet.has(l.id)).map(l => ({...l}));
    if (listings.length < 2) { toast('Selected listings not loaded'); return; }

    const metrics = [
        { label: 'City', key: 'city' },
        { label: 'Neighborhood', key: 'neighborhood' },
        { label: 'Street', key: 'street' },
        { label: 'Rooms', key: 'rooms' },
        { label: 'Price', key: 'price_numeric', fmt: v => v ? '\u20AA' + fmtP(v) : '-', best: 'min' },
        { label: 'Size (sqm)', key: 'size_sqm', best: 'max' },
        { label: 'Floor', key: 'floor' },
        { label: 'Price/sqm', key: '_ppsqm', fmt: v => v ? '\u20AA' + fmtN(v) : '-', best: 'min' },
        { label: 'Type', key: 'is_merchant', fmt: v => v ? 'Agent' : 'Private' },
        { label: 'Status', key: '_status', fmt: v => v || '-' },
        { label: 'First Seen', key: 'first_seen_at', fmt: v => fmtD(v) },
        { label: 'Days on Market', key: '_days', best: 'context' },
    ];

    // Enrich listings with computed fields
    listings.forEach(l => {
        const sqm = parseInt(l.size_sqm);
        l._ppsqm = (l.price_numeric && sqm > 0) ? Math.round(l.price_numeric / sqm) : null;
        l._days = l.first_seen_at ? Math.floor((Date.now() - new Date(l.first_seen_at).getTime()) / 86400000) : null;
        const nd = getNote(l.id);
        l._status = nd?.status ? { called: 'Called', visited: 'Visited', interested: 'Interested', rejected: 'Rejected' }[nd.status] || '' : '';
    });

    const el = document.getElementById('compareContent');
    el.innerHTML = `
        <table class="compare-table" style="width:100%;border-collapse:collapse;">
            <thead>
                <tr>
                    <th style="text-align:right;padding:0.5rem 0.75rem;">Metric</th>
                    ${listings.map(l => `<th style="text-align:center;padding:0.5rem 0.75rem;">${esc(l.street || l.neighborhood || 'Listing')}<br><span style="font-weight:400;font-size:0.5625rem;color:var(--gray-400);">${esc(l.city || '')}</span></th>`).join('')}
                </tr>
            </thead>
            <tbody>
                ${listings[0].image_url ? `<tr><td class="metric-label">Photo</td>${listings.map(l => `<td style="text-align:center;">${l.image_url ? `<img src="${l.image_url}" style="width:100px;height:60px;object-fit:cover;border-radius:4px;" onerror="this.style.display='none'">` : '-'}</td>`).join('')}</tr>` : ''}
                ${metrics.map(m => {
                    const vals = listings.map(l => l[m.key]);
                    const numVals = vals.map(v => typeof v === 'number' ? v : parseFloat(v)).filter(v => !isNaN(v));
                    let bestVal = null;
                    if (m.best === 'min' && numVals.length) bestVal = Math.min(...numVals);
                    if (m.best === 'max' && numVals.length) bestVal = Math.max(...numVals);
                    return `<tr>
                        <td class="metric-label">${m.label}</td>
                        ${vals.map(v => {
                            const display = m.fmt ? m.fmt(v) : (v || '-');
                            const numV = typeof v === 'number' ? v : parseFloat(v);
                            const isBest = bestVal !== null && !isNaN(numV) && numV === bestVal && numVals.length > 1;
                            return `<td style="text-align:center;" class="${isBest ? 'compare-best' : ''}">${esc(String(display))}</td>`;
                        }).join('')}
                    </tr>`;
                }).join('')}
                <tr>
                    <td class="metric-label">Link</td>
                    ${listings.map(l => `<td style="text-align:center;"><a href="https://www.yad2.co.il/item/${l.link_token || l.id}" target="_blank">Open</a></td>`).join('')}
                </tr>
            </tbody>
        </table>
    `;
    document.getElementById('compareModal').classList.add('active');
}

//  MAP VIEW 

let mapData = [];

async function loadMapData() {
    const city = document.getElementById('mapCityFilter')?.value || '';
    const el = document.getElementById('mapContainer');
    el.innerHTML = '<div class="loading"><div class="spinner"></div>Loading map data...</div>';

    try {
        const params = { limit: 2000 };
        if (city) params.city = city;
        const d = await api('/analytics/price-map', params);
        mapData = d.listings || [];
        document.getElementById('mapBadge').textContent = fmtN(mapData.length);

        // Populate city filter if not already done
        const sel = document.getElementById('mapCityFilter');
        if (sel && sel.options.length <= 1) {
            try {
                const cities = await api('/cities');
                sel.innerHTML = '<option value="">All Cities</option>' +
                    cities.cities.map(c => `<option value="${esc(c.city)}">${esc(c.city)}</option>`).join('');
            } catch (e) {}
        }

        renderMap(mapData);
    } catch (e) {
        el.innerHTML = `<div class="empty-state">Error: ${esc(e.message)}</div>`;
    }
}

function renderMap(listings) {
    const el = document.getElementById('mapContainer');
    if (!listings.length) { el.innerHTML = '<div class="empty-state">No listings with coordinates</div>'; return; }

    const lats = listings.map(l => parseFloat(l.latitude)).filter(v => !isNaN(v));
    const lngs = listings.map(l => parseFloat(l.longitude)).filter(v => !isNaN(v));

    if (!lats.length) { el.innerHTML = '<div class="empty-state">No coordinate data</div>'; return; }

    const minLat = Math.min(...lats), maxLat = Math.max(...lats);
    const minLng = Math.min(...lngs), maxLng = Math.max(...lngs);
    const padLat = (maxLat - minLat) * 0.05 || 0.01;
    const padLng = (maxLng - minLng) * 0.05 || 0.01;

    const W = 800, H = 500;
    const prices = listings.map(l => l.price_numeric).filter(Boolean);
    const minP = Math.min(...prices), maxP = Math.max(...prices);
    const pRange = maxP - minP || 1;

    function latToY(lat) { return H - ((lat - minLat + padLat) / (maxLat - minLat + 2 * padLat)) * H; }
    function lngToX(lng) { return ((lng - minLng + padLng) / (maxLng - minLng + 2 * padLng)) * W; }
    function priceColor(p) {
        const t = (p - minP) / pRange;
        const r = Math.round(t * 220);
        const g = Math.round((1 - t) * 180);
        return `rgb(${r}, ${g}, 60)`;
    }

    const dots = listings.map((l, i) => {
        const lat = parseFloat(l.latitude), lng = parseFloat(l.longitude);
        if (isNaN(lat) || isNaN(lng)) return '';
        const x = lngToX(lng), y = latToY(lat);
        const r = 2.5 + ((l.price_numeric - minP) / pRange) * 3;
        const color = priceColor(l.price_numeric);
        return `<circle cx="${x.toFixed(1)}" cy="${y.toFixed(1)}" r="${r.toFixed(1)}" fill="${color}" opacity="0.7" data-idx="${i}" style="cursor:pointer"/>`;
    }).join('');

    el.innerHTML = `
        <svg viewBox="0 0 ${W} ${H}" style="width:100%;height:${H}px;background:var(--gray-50);border-radius:var(--radius-sm);" id="mapSvg">
            ${dots}
        </svg>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:0.5rem;font-size:0.625rem;color:var(--gray-400);">
            <span>${fmtN(listings.length)} listings plotted</span>
            <div style="display:flex;align-items:center;gap:0.25rem;">
                <span style="width:10px;height:10px;background:rgb(0,180,60);border-radius:50%;"></span> Cheap
                <span style="width:10px;height:10px;background:rgb(110,90,60);border-radius:50%;margin-right:0.25rem;"></span> Mid
                <span style="width:10px;height:10px;background:rgb(220,0,60);border-radius:50%;"></span> Expensive
            </div>
            <span>&#8362;${fmtP(minP)} - &#8362;${fmtP(maxP)}</span>
        </div>
    `;

    // Add hover tooltip
    const svg = document.getElementById('mapSvg');
    const tooltip = document.getElementById('mapTooltip');
    svg.addEventListener('mousemove', e => {
        const circle = e.target.closest('circle');
        if (circle) {
            const idx = parseInt(circle.dataset.idx);
            const l = listings[idx];
            if (!l) return;
            tooltip.innerHTML = `
                <strong>${l.street || l.neighborhood || 'Listing'}</strong><br>
                ${l.city}, ${l.neighborhood || ''}<br>
                &#8362;${fmtP(l.price_numeric)} | ${l.rooms || '?'} rooms | ${l.size_sqm || '?'} sqm
            `;
            tooltip.style.display = 'block';
            tooltip.style.left = e.clientX + 12 + 'px';
            tooltip.style.top = e.clientY - 10 + 'px';
        } else {
            tooltip.style.display = 'none';
        }
    });
    svg.addEventListener('mouseleave', () => { tooltip.style.display = 'none'; });

    // Click to open listing
    svg.addEventListener('click', e => {
        const circle = e.target.closest('circle');
        if (circle) {
            const idx = parseInt(circle.dataset.idx);
            const l = listings[idx];
            if (l) window.open(`https://www.yad2.co.il/item/${l.link_token || l.id}`, '_blank');
        }
    });
}

//  SAVED SEARCH ALERTS 

const savedAlerts = JSON.parse(localStorage.getItem('yad2_alerts') || '[]');

function showAddAlertForm() {
    document.getElementById('addAlertForm').style.display = '';
    document.getElementById('alertCity').focus();
}

function hideAddAlertForm() {
    document.getElementById('addAlertForm').style.display = 'none';
}

function saveAlert() {
    const city = document.getElementById('alertCity').value.trim();
    const maxPrice = parseInt(document.getElementById('alertMaxPrice').value) || null;
    const minRooms = parseInt(document.getElementById('alertMinRooms').value) || null;
    const neighborhood = document.getElementById('alertNeighborhood').value.trim();

    if (!city && !maxPrice && !minRooms && !neighborhood) {
        toast('Set at least one filter'); return;
    }

    const label = [city, neighborhood, maxPrice ? `<${fmtN(maxPrice)}` : '', minRooms ? `${minRooms}+ rooms` : ''].filter(Boolean).join(', ');
    savedAlerts.push({ city, maxPrice, minRooms, neighborhood, label, created: new Date().toISOString() });
    localStorage.setItem('yad2_alerts', JSON.stringify(savedAlerts));

    document.getElementById('alertCity').value = '';
    document.getElementById('alertMaxPrice').value = '';
    document.getElementById('alertMinRooms').value = '';
    document.getElementById('alertNeighborhood').value = '';
    hideAddAlertForm();
    renderAlerts();
    toast(`Alert "${label}" saved`);
}

function deleteAlert(idx) {
    savedAlerts.splice(idx, 1);
    localStorage.setItem('yad2_alerts', JSON.stringify(savedAlerts));
    renderAlerts();
}

function renderAlerts() {
    const list = document.getElementById('savedAlertsList');
    document.getElementById('alertsBadge').textContent = savedAlerts.length;

    if (!savedAlerts.length) {
        list.innerHTML = '<div class="empty-state">No saved searches. Create one to track new listings matching your criteria.</div>';
        document.getElementById('alertMatchesBody').innerHTML = '<tr><td colspan="10" class="empty-state">No alerts configured</td></tr>';
        document.getElementById('alertMatchCount').textContent = '0 matches';
        return;
    }

    list.innerHTML = savedAlerts.map((a, i) => `
        <div style="display:flex;justify-content:space-between;align-items:center;padding:0.5rem 0;border-bottom:1px solid var(--gray-100);">
            <div>
                <span style="font-weight:600;font-size:0.8125rem;color:var(--gray-700);">${a.label}</span>
                <span style="font-size:0.625rem;color:var(--gray-400);margin-right:0.5rem;">created ${fmtD(a.created)}</span>
            </div>
            <button class="preset-btn" onclick="deleteAlert(${i})" style="color:var(--danger);">Delete</button>
        </div>
    `).join('');

    // Find matching listings
    const matches = [];
    const data = S.listings.allData || [];

    for (const listing of data) {
        for (let i = 0; i < savedAlerts.length; i++) {
            const a = savedAlerts[i];
            let match = true;

            if (a.city && !(listing.city || '').toLowerCase().includes(a.city.toLowerCase())) match = false;
            if (a.neighborhood && !(listing.neighborhood || '').toLowerCase().includes(a.neighborhood.toLowerCase())) match = false;
            if (a.maxPrice && listing.price_numeric > a.maxPrice) match = false;
            if (a.minRooms) {
                const rooms = parseFloat(listing.rooms);
                if (isNaN(rooms) || rooms < a.minRooms) match = false;
            }

            if (match) {
                matches.push({ listing, alertIdx: i, alertLabel: a.label });
                break;
            }
        }
    }

    // Sort by first_seen_at (newest first)
    matches.sort((a, b) => new Date(b.listing.first_seen_at) - new Date(a.listing.first_seen_at));

    document.getElementById('alertMatchCount').textContent = `${fmtN(matches.length)} matches`;

    const tbody = document.getElementById('alertMatchesBody');
    if (!matches.length) {
        tbody.innerHTML = '<tr><td colspan="10" class="empty-state">No listings match your saved searches</td></tr>';
        return;
    }

    tbody.innerHTML = matches.slice(0, 100).map(m => {
        const l = m.listing;
        const isFav = favorites.has(l.id);
        return `
        <tr>
            <td><span class="fav-star ${isFav ? 'active' : ''}" data-id="${l.id}" onclick="toggleFavorite(event,'${l.id}')">&#9733;</span></td>
            <td><span class="badge badge-info" style="font-size:0.5625rem;">${m.alertLabel}</span></td>
            <td>${l.city || '-'}</td>
            <td>${l.neighborhood || '-'}</td>
            <td>${l.street || '-'}</td>
            <td>${l.rooms || '-'}</td>
            <td><strong>&#8362;${fmtP(l.price_numeric)}</strong></td>
            <td>${l.size_sqm || '-'}</td>
            <td>${daysAgo(l.first_seen_at)}</td>
            <td><a href="https://www.yad2.co.il/item/${l.link_token || l.id}" target="_blank">View</a></td>
        </tr>`;
    }).join('');
}

//  ANALYTICS SORTING 

let analyticsData = [];
let analyticsSort = { col: 'avg_price', ord: 'asc' };

function sortAnalytics(col) {
    if (analyticsSort.col === col) {
        analyticsSort.ord = analyticsSort.ord === 'asc' ? 'desc' : 'asc';
    } else {
        analyticsSort.col = col;
        analyticsSort.ord = col === 'city' || col === 'neighborhood' ? 'asc' : 'desc';
    }
    renderAnalyticsBody();
}

function renderAnalyticsBody() {
    const { col, ord } = analyticsSort;
    const sorted = [...analyticsData].sort((a, b) => {
        let av = a[col], bv = b[col];
        if (av == null) av = '';
        if (bv == null) bv = '';
        if (typeof av === 'string') { av = av.toLowerCase(); bv = (bv || '').toLowerCase(); }
        if (av < bv) return ord === 'asc' ? -1 : 1;
        if (av > bv) return ord === 'asc' ? 1 : -1;
        return 0;
    });

    const tbody = document.getElementById('analyticsBody');
    tbody.innerHTML = sorted.map(n => `
        <tr onclick="filterByCity('${esc(n.city || '')}')" style="cursor:pointer">
            <td>${esc(n.city || '-')}</td>
            <td>${esc(n.neighborhood || '-')}</td>
            <td>${fmtN(n.listings_count)}</td>
            <td><strong>&#8362;${fmtP(n.avg_price)}</strong></td>
            <td>&#8362;${fmtP(n.median_price)}</td>
            <td>&#8362;${fmtP(n.min_price)}</td>
            <td>&#8362;${fmtP(n.max_price)}</td>
            <td>${n.avg_price_per_sqm ? '&#8362;' + fmtP(n.avg_price_per_sqm) : '-'}</td>
            <td>${n.avg_rooms || '-'}</td>
        </tr>
    `).join('');
}

//  QUICK SEARCH 

const onQuickSearch = debounce(() => {
    S.listings.page = 1;
    filterAndRender('listings');
}, 300);

//  CSV EXPORT 

function exportCSV() {
    const data = S.listings.data;
    if (!data.length) { toast('No data to export'); return; }

    const headers = ['City','Neighborhood','Street','Rooms','Price','Sqm','Floor','Price/Sqm','Type','Added','Link'];
    const rows = data.map(l => {
        const sqm = parseInt(l.size_sqm);
        const ppsqm = (l.price_numeric && sqm > 0) ? Math.round(l.price_numeric / sqm) : '';
        return [
            l.city || '', l.neighborhood || '', l.street || '', l.rooms || '',
            l.price_numeric || '', l.size_sqm || '', l.floor || '', ppsqm,
            l.is_merchant ? 'Agent' : 'Private',
            l.first_seen_at ? new Date(l.first_seen_at).toLocaleDateString('en-GB') : '',
            `https://www.yad2.co.il/item/${l.link_token || l.id}`
        ];
    });

    const safeCsvCell = v => { const s = String(v).replace(/"/g, '""'); return /^[=+\-@\t\r]/.test(s) ? "'" + s : s; };
    const csv = [headers, ...rows].map(r => r.map(v => `"${safeCsvCell(v)}"`).join(',')).join('\n');
    const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `yad2-listings-${new Date().toISOString().slice(0,10)}.csv`;
    a.click();
    URL.revokeObjectURL(url);
    toast(`Exported ${data.length} listings`);
}

//  PAGE SIZE 

function changePageSize(size) {
    S.listings.limit = parseInt(size);
    S.listings.page = 1;
    filterAndRender('listings');
}

//  REFRESH COUNTDOWN 

let countdownSec = AUTO_REFRESH_MS / 1000;
function startCountdown() {
    setInterval(() => {
        countdownSec--;
        if (countdownSec <= 0) countdownSec = AUTO_REFRESH_MS / 1000;
        const el = document.getElementById('refreshCountdown');
        if (el) el.textContent = `Next refresh: ${countdownSec}s`;
    }, 1000);
}

//  UTILITIES 

function daysAgo(s) {
    if (!s) return '-';
    const days = Math.floor((Date.now() - new Date(s).getTime()) / 86400000);
    if (days === 0) return '<span class="badge badge-success">Today</span>';
    if (days === 1) return '<span class="badge badge-success">1d</span>';
    if (days <= 3) return `<span class="badge badge-info">${days}d</span>`;
    if (days <= 7) return `<span class="badge badge-neutral">${days}d</span>`;
    if (days <= 14) return `${days}d`;
    return `<span style="color:var(--gray-400)">${days}d</span>`;
}

function esc(s) { if (s == null) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }
function fmtN(n) { return n == null ? '-' : Number(n).toLocaleString('en-US'); }
function fmtP(n) { return n == null ? '-' : `${Number(n).toLocaleString('en-US')}`; }
function fmtD(s) { return s ? new Date(s).toLocaleDateString('en-GB') : '-'; }
function fmtDT(s) { return s ? new Date(s).toLocaleString('en-GB', { day:'2-digit',month:'2-digit',year:'2-digit',hour:'2-digit',minute:'2-digit' }) : '-'; }
function fmtDur(ms) {
    const m = Math.floor(ms / 60000);
    if (m < 60) return `${m}m`;
    return `${Math.floor(m / 60)}h ${m % 60}m`;
}

function debounce(fn, ms) {
    let t;
    return function (...a) { clearTimeout(t); t = setTimeout(() => fn.apply(this, a), ms); };
}

function toast(msg) {
    const el = document.getElementById('toast');
    el.textContent = msg;
    el.classList.add('visible');
    setTimeout(() => el.classList.remove('visible'), 2500);
}
</script>
</body>
</html>
